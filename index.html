<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Diego Y Danna" />
  <title>Diego Y Danna</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="portada.jpeg" />
  <link rel="apple-touch-icon" href="portada.jpeg" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700;800&family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    :root {
      --diego-primary: #2563eb;
      --diego-secondary: #1e40af;
      --diego-accent: #3b82f6;
      --diego-light: #eff6ff;
      
      --danna-primary: #db2777;
      --danna-secondary: #9d174d;
      --danna-accent: #ec4899;
      --danna-light: #fdf2f8;

      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-tertiary: #94a3b8;
      --text-light: #e5e7eb;

      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --bg-dark: #1e293b;

      /* Superficies modernas (glass) */
      --border: rgba(15, 23, 42, 0.10);
      --surface: rgba(255, 255, 255, 0.76);
      --surface-strong: rgba(255, 255, 255, 0.92);
      --surface-muted: rgba(248, 250, 252, 0.70);

      --radius-xs: 4px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;

      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 6px 14px -6px rgb(0 0 0 / 0.18);
      --shadow-lg: 0 14px 28px -14px rgb(0 0 0 / 0.22);
      --shadow-xl: 0 28px 60px -28px rgb(0 0 0 / 0.35);

      /* Focus rings */
      --ring: rgba(59, 130, 246, 0.18);
      --ring-strong: rgba(59, 130, 246, 0.28);

      /* Pendientes (icono fijo) */
      --pending-btn-size: 132px;
      --pending-img-size: 112px;
      --pending-offset: 0px;
    }

    /* DIEGO THEME */
    body.theme-diego {
      background:
        radial-gradient(1100px 760px at 12% 10%, rgba(37, 99, 235, 0.16), transparent 58%),
        radial-gradient(900px 680px at 88% 22%, rgba(59, 130, 246, 0.14), transparent 60%),
        linear-gradient(135deg, #f7fbff 0%, #eef5ff 55%, #ffffff 100%);
      color: var(--text-primary);
    }

    body.theme-diego .primary-color { color: var(--diego-primary); }
    body.theme-diego .primary-bg { background: var(--diego-primary); }
    body.theme-diego .primary-gradient { background: linear-gradient(135deg, var(--diego-primary), var(--diego-secondary)); }

    /* DANNA THEME */
    body.theme-danna {
      background:
        radial-gradient(1100px 760px at 12% 10%, rgba(219, 39, 119, 0.16), transparent 58%),
        radial-gradient(900px 680px at 88% 22%, rgba(236, 72, 153, 0.14), transparent 60%),
        linear-gradient(135deg, #fff7fb 0%, #fde9f3 55%, #ffffff 100%);
      color: var(--text-primary);
    }

    body.theme-danna .primary-color { color: var(--danna-primary); }
    body.theme-danna .primary-bg { background: var(--danna-primary); }
    body.theme-danna .primary-gradient { background: linear-gradient(135deg, var(--danna-primary), var(--danna-secondary)); }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      -webkit-text-size-adjust: 100%;
      min-height: 100dvh;
      text-rendering: optimizeLegibility;
    }

    *, *::before, *::after {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    :focus-visible {
      outline: none;
    }

    @media (prefers-reduced-motion: reduce) {
      html { scroll-behavior: auto; }
      *, *::before, *::after {
        animation-duration: 0.001ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.001ms !important;
      }
    }

    /* ==================== LOGIN SCREEN ==================== */
    .login-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      visibility: visible;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }

    .login-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .login-container {
      text-align: center;
      max-width: 450px;
      width: 90%;
      animation: slideUpFade 0.8s ease;
      padding: 60px 40px;
      background: var(--surface-strong);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    @keyframes slideUpFade {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .login-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-light);
      border-radius: var(--radius-lg);
      font-size: 2.5rem;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
    }

    .login-title {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-family: "Playfair Display", serif;
    }

    .login-subtitle {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 48px;
      font-weight: 400;
    }

    .login-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .login-btn {
      padding: 18px;
      border: 2px solid transparent;
      border-radius: var(--radius-lg);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
      background: var(--bg-light);
      color: var(--text-primary);
    }

    .login-avatar {
      width: 64px;
      height: 64px;
      border-radius: 999px;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--text-light);
      background: var(--bg-white);
      box-shadow: var(--shadow-sm);
    }

    body.theme-diego .login-btn.diego .login-avatar { border-color: var(--diego-primary); }
    body.theme-danna .login-btn.danna .login-avatar { border-color: var(--danna-primary); }

    .login-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: var(--transition);
      transform: scale(1.02);
    }

    .login-btn:hover .login-avatar img {
      transform: scale(1.08);
    }

    .login-avatar-fallback {
      width: 64px;
      height: 64px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--text-light);
      background: var(--bg-white);
      box-shadow: var(--shadow-sm);
    }

    .login-btn i {
      font-size: 1.8rem;
    }

    .login-btn.diego {
      border-color: var(--diego-primary);
      color: var(--diego-primary);
    }

    .login-btn.diego:hover {
      background: var(--diego-primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
    }

    .login-btn.danna {
      border-color: var(--danna-primary);
      color: var(--danna-primary);
    }

    .login-btn.danna:hover {
      background: var(--danna-primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(219, 39, 119, 0.2);
    }

    @media (max-width: 480px) {
      .login-container { padding: 40px 24px; }
      .login-title { font-size: 1.8rem; }
      .login-buttons { grid-template-columns: 1fr; }
      .login-icon { width: 64px; height: 64px; }
    }

    /* ==================== INICIO PORTADA ==================== */
    .cover-hero {
      position: relative;
      border-radius: var(--radius-xl);
      overflow: hidden;
      border: 1px solid var(--text-light);
      background: var(--bg-white);
      box-shadow: var(--shadow-md);
      margin-bottom: 24px;
      min-height: 260px;
      isolation: isolate;
      cursor: zoom-in;
    }

    .cover-hero img {
      width: 100%;
      height: 100%;
      min-height: 260px;
      object-fit: cover;
      display: block;
      will-change: transform;
      transform-origin: 50% 40%;
      transform: scale(1.04);
      filter: saturate(1.05) contrast(1.03);
      animation: coverKenBurns 16s ease-in-out infinite;
    }

    @keyframes coverKenBurns {
      0% { transform: scale(1.04) translate3d(0px, 0px, 0); }
      50% { transform: scale(1.11) translate3d(-8px, -6px, 0); }
      100% { transform: scale(1.04) translate3d(0px, 0px, 0); }
    }

    .cover-hero::after {
      content: "";
      position: absolute;
      inset: 0;
      opacity: 0.22;
      pointer-events: none;
      z-index: 2;
      background-size: 140% 140%;
      background-position: 0% 0%;
      animation: coverOverlayShift 12s ease-in-out infinite;
    }

    @keyframes coverOverlayShift {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }

    body.theme-diego .cover-hero::after {
      background: linear-gradient(135deg, var(--diego-primary), var(--diego-secondary));
    }

    body.theme-danna .cover-hero::after {
      background: linear-gradient(135deg, var(--danna-primary), var(--danna-secondary));
    }

    .cover-overlay {
      position: absolute;
      inset: 0;
      z-index: 3;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
      padding: 22px;
      background: linear-gradient(to top, rgba(15, 23, 42, 0.55), rgba(15, 23, 42, 0.0) 60%);
    }

    .cover-title {
      color: var(--bg-white);
      font-family: "Playfair Display", serif;
      font-size: 1.7rem;
      font-weight: 800;
      letter-spacing: -0.01em;
      text-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cover-title small {
      font-family: "Great Vibes", cursive;
      font-size: 1.6rem;
      font-weight: 400;
      line-height: 1;
      opacity: 0.95;
    }

    .cover-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(255, 255, 255, 0.12);
      color: var(--bg-white);
      font-weight: 700;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: var(--transition-fast);
      cursor: default;
      user-select: none;
    }

    .cover-hero:hover .cover-badge {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.16);
    }

    .cover-hero:hover img {
      animation-play-state: paused;
      transform: scale(1.10);
    }

    @media (max-width: 768px) {
      .cover-hero { min-height: 220px; }
      .cover-hero img { min-height: 220px; }
      .cover-overlay { padding: 16px; }
      .cover-title { font-size: 1.35rem; }
      .cover-title small { font-size: 1.35rem; }
    }

    @media (prefers-reduced-motion: reduce) {
      .cover-hero img { animation: none; transform: none; }
      .cover-hero::after { animation: none; }
      .cover-hero:hover img { transform: none; }
    }

    /* ==================== COVER LIGHTBOX ==================== */
    .cover-lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.72);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.22s ease, visibility 0.22s ease;
      padding: calc(14px + env(safe-area-inset-top)) calc(14px + env(safe-area-inset-right)) calc(14px + env(safe-area-inset-bottom)) calc(14px + env(safe-area-inset-left));
    }

    .cover-lightbox.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .cover-lightbox-inner {
      width: min(1100px, 100%);
      max-height: 100%;
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.14);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow-xl);
    }

    .cover-lightbox-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(0, 0, 0, 0.22);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
      z-index: 1;
    }

    .cover-lightbox-close:hover {
      background: rgba(0, 0, 0, 0.32);
      transform: translateY(-1px);
    }

    .cover-lightbox-stage {
      width: 100%;
      max-height: calc(100dvh - 28px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .cover-lightbox-stage img {
      width: 100%;
      height: auto;
      max-width: 100%;
      max-height: calc(100dvh - 28px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      object-fit: contain;
      display: block;
      cursor: zoom-in;
      user-select: none;
      -webkit-user-drag: none;
      transform-origin: center;
      transition: transform 0.18s ease;
    }

    .cover-lightbox-stage.is-zoomed {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .cover-lightbox-stage.is-zoomed img {
      cursor: zoom-out;
      max-width: none;
      max-height: none;
      width: auto;
      height: auto;
      transform: scale(1.8);
      margin: 60px;
    }

    @media (prefers-reduced-motion: reduce) {
      .cover-lightbox,
      .cover-lightbox-stage img {
        transition: none;
      }
    }

    /* ==================== HEADER ==================== */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: calc(12px + env(safe-area-inset-top)) 0 12px;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      isolation: isolate;
    }

    header::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -1px;
      height: 2px;
      pointer-events: none;
      opacity: 0;
      background: linear-gradient(90deg, transparent, rgba(0,0,0,0.0), transparent);
    }

    body.theme-diego header::after {
      opacity: 0.55;
      background: linear-gradient(
        90deg,
        transparent,
        color-mix(in srgb, var(--diego-primary) 55%, transparent),
        transparent
      );
    }

    body.theme-danna header::after {
      opacity: 0.55;
      background: linear-gradient(
        90deg,
        transparent,
        color-mix(in srgb, var(--danna-primary) 55%, transparent),
        transparent
      );
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 calc(20px + env(safe-area-inset-left)) 0 calc(20px + env(safe-area-inset-right));
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .brand-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: white;
      box-shadow: var(--shadow-md);
    }

    @media (max-width: 520px) {
      .brand { gap: 12px; }
      .brand-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }
    }

    .brand-text h1 {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--text-primary);
      font-family: "Playfair Display", serif;
      letter-spacing: -0.01em;
      line-height: 1.1;
    }

    .brand-text p {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 2px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: fit-content;
      max-width: 100%;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--text-light);
      background: color-mix(in srgb, var(--bg-light) 72%, var(--bg-white));
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.theme-diego .brand-text p {
      border-color: color-mix(in srgb, var(--diego-primary) 28%, var(--text-light));
      background: color-mix(in srgb, var(--diego-primary) 10%, var(--bg-light));
    }

    body.theme-danna .brand-text p {
      border-color: color-mix(in srgb, var(--danna-primary) 28%, var(--text-light));
      background: color-mix(in srgb, var(--danna-primary) 10%, var(--bg-light));
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      flex: 0 0 auto;
      min-width: 0;
    }

    .header-user-row {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    /* Botón grande sin borde (solo imagen activa/inactiva) */
    .notif-icon-btn {
      position: relative;
      width: 56px;
      height: 56px;
      border: none;
      background: none;
      padding: 0;
      margin: 0;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
      transition: var(--transition-fast);
      -webkit-tap-highlight-color: transparent;
    }

    .notif-icon-btn:hover {
      transform: translateY(-1px);
      opacity: 0.92;
    }

    .notif-icon-btn:active {
      transform: translateY(0px);
    }

    .notif-icon-btn:focus-visible {
      box-shadow: 0 0 0 4px var(--ring-strong);
    }

    .notif-icon-btn img {
      width: 56px;
      height: 56px;
      object-fit: contain;
      display: block;
      pointer-events: none;
      user-select: none;
      transform: none;
    }

    .pending-badge.pending-badge--header {
      top: -6px;
      right: -6px;
      min-width: 26px;
      height: 26px;
      padding: 0 8px;
      font-size: 0.85rem;
    }

    /* ==================== PENDINGS ICON + MINI PANEL ==================== */
    .pending-icon-btn {
      position: relative;
      width: min(var(--pending-btn-size), calc(100vw - 24px));
      height: min(var(--pending-btn-size), calc(100vw - 24px));
      border-radius: 999px;
      border: none;
      background: none;
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition-fast);
      flex: 0 0 auto;
    }

    /* Burbuja flotante independiente */
    #pendingIconBtn {
      position: fixed;
      right: calc(var(--pending-offset) + env(safe-area-inset-right));
      bottom: calc(var(--pending-offset) + env(safe-area-inset-bottom));
      z-index: 10050;
      filter: drop-shadow(0 10px 15px -3px rgba(0, 0, 0, 0.2));
      transform: translateZ(0);
      touch-action: none;
      cursor: grab;
    }

    #pendingIconBtn.is-dragging {
      cursor: grabbing;
      animation: none;
      opacity: 0.95;
    }

    /* Siempre visible: el header es sticky, no hace falta fixed */

    .pending-icon-btn img {
      width: min(var(--pending-img-size), calc(100vw - 72px));
      height: min(var(--pending-img-size), calc(100vw - 72px));
      object-fit: contain;
      display: block;
      pointer-events: none;
      user-select: none;
      /* “Acostado” en la esquina inferior, sin estorbar */
      transform: rotate(-10deg);
      transform-origin: 100% 100%;
    }

    /* Nota: el tamaño real del botón/imagen se controla por variables (--pending-*) */
    @media (max-width: 520px) {
      .pending-icon-btn {
        width: var(--pending-btn-size);
        height: var(--pending-btn-size);
      }

      .pending-icon-btn img {
        width: var(--pending-img-size);
        height: var(--pending-img-size);
      }
    }

    .pending-icon-btn:hover {
      opacity: 0.85;
    }

    .pending-icon-btn.has-pending {
      animation: pendingPulse 1.6s ease-in-out infinite;
    }

    /* En móvil: más pequeño y pegado a la base (esquina) */
    @media (max-width: 480px) {
      :root {
        --pending-btn-size: 88px;
        --pending-img-size: 72px;
      }
    }

    @keyframes pendingPulse {
      0%, 100% { filter: drop-shadow(0 10px 15px -3px rgba(0, 0, 0, 0.2)); }
      50% { filter: drop-shadow(0 15px 20px -3px rgba(0, 0, 0, 0.25)); }
    }

    .pending-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      min-width: 34px;
      height: 34px;
      padding: 0 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 800;
      color: white;
      border: 2px solid var(--bg-white);
      box-shadow: var(--shadow-sm);
      line-height: 1;
    }

    body.theme-diego .pending-badge { background: var(--diego-primary); }
    body.theme-danna .pending-badge { background: var(--danna-primary); }

    .pending-panel {
      position: fixed;
      right: calc(var(--pending-offset) + env(safe-area-inset-right));
      bottom: calc(var(--pending-offset) + env(safe-area-inset-bottom) + var(--pending-btn-size) + 12px);
      width: min(460px, calc(100vw - 32px));
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-8px);
      transition: var(--transition);
      z-index: 10060;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .pending-panel.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
    }

    /* ==================== PENDIENTES EN INICIO (INLINE) ==================== */
    .pending-section {
      --pending-btn-size: 96px;
      --pending-img-size: 78px;
    }

    .pending-section #pendingIconBtn {
      position: static;
      right: auto;
      bottom: auto;
      left: auto;
      top: auto;
      z-index: auto;
      filter: none;
      transform: none;
      touch-action: manipulation;
      cursor: pointer;
    }

    .pending-section .pending-panel {
      position: static;
      left: auto;
      top: auto;
      right: auto;
      bottom: auto;
      width: 100%;
      margin-top: 12px;
      transform: none;
      display: none;
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      z-index: auto;
    }

    .pending-section .pending-panel.active {
      display: block;
    }

    .pending-panel-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .pending-panel-title {
      font-weight: 800;
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .pending-panel-close {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--surface-strong);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: var(--transition-fast);
    }

    .pending-panel-close:hover {
      background: var(--bg-light);
      color: var(--text-primary);
      border-color: var(--text-secondary);
    }

    .pending-panel-body {
      padding: 14px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pending-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .pending-row-left {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
      font-weight: 700;
      min-width: 0;
    }

    .pending-row-left span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .pending-row-count {
      font-weight: 900;
      font-size: 1.2rem;
      color: var(--text-primary);
      flex: 0 0 auto;
    }

    .pending-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .pending-note {
      color: var(--text-tertiary);
      font-size: 0.9rem;
      line-height: 1.6;
      margin-top: 2px;
    }

    @media (max-width: 520px) {
      :root {
        --pending-btn-size: 260px;
        --pending-img-size: 225px;
        --pending-offset: 4px;
      }

      .pending-panel {
        left: 12px;
        right: 12px;
        width: auto;
        bottom: calc(var(--pending-offset) + env(safe-area-inset-bottom) + var(--pending-btn-size) + 12px);
      }
    }

    @media (max-width: 360px) {
      :root {
        --pending-btn-size: 230px;
        --pending-img-size: 200px;
        --pending-offset: 2px;
      }
    }

    /* Header responsive con icono grande */
    @media (max-width: 480px) {
      .header-actions {
        width: 100%;
        align-items: stretch;
      }

      .header-user-row {
        width: 100%;
        justify-content: space-between;
      }

      .user-badge {
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }

    @media (max-width: 360px) {
      .header-actions {
        gap: 10px;
      }

      .logout-btn {
        justify-self: stretch;
        text-align: center;
        width: 100%;
        justify-content: center;
      }
    }

    .user-badge {
      padding: 9px 14px;
      background: color-mix(in srgb, var(--bg-light) 72%, var(--bg-white));
      border: 1px solid var(--text-light);
      border-radius: 999px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      line-height: 1;
    }

    .user-badge:empty { display: none; }

    .logout-btn {
      padding: 9px 14px;
      background: var(--bg-white);
      border: 1px solid var(--text-light);
      border-radius: 999px;
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition-fast);
      font-weight: 800;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      line-height: 1;
    }

    .logout-btn:active {
      transform: translateY(1px);
    }

    .logout-btn:hover {
      background: var(--bg-light);
      border-color: var(--text-secondary);
    }

    body.theme-diego .logout-btn:hover {
      background: color-mix(in srgb, var(--diego-primary) 10%, var(--bg-light));
      border-color: color-mix(in srgb, var(--diego-primary) 40%, var(--text-light));
    }

    body.theme-danna .logout-btn:hover {
      background: color-mix(in srgb, var(--danna-primary) 10%, var(--bg-light));
      border-color: color-mix(in srgb, var(--danna-primary) 40%, var(--text-light));
    }

    /* ==================== MAIN CONTENT ==================== */
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px calc(20px + env(safe-area-inset-left)) calc(24px + env(safe-area-inset-bottom)) calc(20px + env(safe-area-inset-right));
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 8px;
      border-radius: 999px;
      box-shadow: var(--shadow-sm);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
      scroll-padding-left: 8px;
      scroll-padding-right: 8px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .tabs::-webkit-scrollbar { height: 0; }

    .tab-btn {
      padding: 11px 16px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 999px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 800;
      position: relative;
      transition: var(--transition-fast);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1;
      scroll-snap-align: start;
      -webkit-tap-highlight-color: transparent;
    }

    .tab-btn i {
      opacity: 0.85;
    }

    .tab-btn.active i {
      opacity: 1;
    }

    body.theme-diego .tab-btn.active {
      color: var(--diego-primary);
      background: color-mix(in srgb, var(--diego-primary) 10%, var(--bg-light));
      border-color: color-mix(in srgb, var(--diego-primary) 38%, var(--text-light));
    }

    body.theme-danna .tab-btn.active {
      color: var(--danna-primary);
      background: color-mix(in srgb, var(--danna-primary) 10%, var(--bg-light));
      border-color: color-mix(in srgb, var(--danna-primary) 38%, var(--text-light));
    }

    .tab-btn:hover {
      color: var(--text-primary);
      background: color-mix(in srgb, var(--bg-light) 80%, var(--bg-white));
    }

    .tab-btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-md);
      border-color: var(--text-secondary);
    }

    @media (max-width: 520px) {
      .tabs { padding: 6px; margin-bottom: 22px; }
      .tab-btn { padding: 10px 12px; font-size: 0.88rem; }
    }

    .tab-content {
      display: none;
      animation: fadeInUp 0.4s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ==================== GRID ==================== */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    @media (max-width: 1024px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    /* ==================== CARDS ==================== */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      border-color: color-mix(in srgb, var(--text-secondary) 55%, var(--border));
      transform: translateY(-1px);
    }

    .card-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: var(--surface-muted);
    }

    .card-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-header h2 i {
      font-size: 1.2rem;
      opacity: 0.8;
    }

    .card-body {
      padding: 24px;
    }

    /* ==================== NEXT 5 COUNTDOWN ==================== */
    .countdowns-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .countdowns-grid .together-card {
      grid-column: 1 / -1;
    }

    @media (max-width: 980px) {
      .countdowns-grid {
        grid-template-columns: 1fr;
      }

      .countdowns-grid .together-card {
        grid-column: auto;
      }
    }

    .next5-card {
      border-width: 2px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      transform: translateZ(0);
      will-change: transform;
      --accent: var(--text-secondary);
      animation: next5FloatIn 520ms cubic-bezier(.2,.9,.2,1);
    }

    body.theme-diego .next5-card { border-color: var(--diego-primary); --accent: var(--diego-primary); }
    body.theme-danna .next5-card { border-color: var(--danna-primary); --accent: var(--danna-primary); }

    @keyframes next5FloatIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .next5-card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 1;
      background:
        radial-gradient(260px 200px at 18% 22%, color-mix(in srgb, var(--accent) 14%, transparent), transparent 62%),
        radial-gradient(340px 220px at 88% 80%, color-mix(in srgb, var(--accent) 10%, transparent), transparent 62%),
        linear-gradient(120deg, transparent, color-mix(in srgb, var(--accent) 8%, transparent), transparent);
      background-size: 100% 100%, 100% 100%, 240% 100%;
      background-position: 0 0, 0 0, 0% 0;
      animation: next5Sheen 10s ease-in-out infinite;
    }

    @keyframes next5Sheen {
      0%   { background-position: 0 0, 0 0, 0% 0; }
      50%  { background-position: 0 0, 0 0, 100% 0; }
      100% { background-position: 0 0, 0 0, 0% 0; }
    }

    .next5-card .card-header {
      border-bottom-color: transparent;
      color: var(--bg-white);
      position: relative;
      overflow: hidden;
    }

    .next5-card .card-header::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.16;
      background:
        linear-gradient(90deg, transparent, rgba(255,255,255,0.55), transparent);
      transform: translateX(-120%);
      animation: headerSweep 7s ease-in-out infinite;
    }

    @keyframes headerSweep {
      0%, 55% { transform: translateX(-120%); }
      70% { transform: translateX(120%); }
      100% { transform: translateX(120%); }
    }

    .next5-card .card-header h2 {
      color: var(--bg-white);
    }

    .next5-card .card-header h2 i {
      opacity: 0.95;
    }

    .next5-layout {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
    }

    .next5-side {
      flex: 1;
      min-width: 240px;
      text-align: right;
    }

    @media (max-width: 480px) {
      .next5-layout { align-items: flex-start; }
      .next5-side { min-width: 0; text-align: left; }
      .next5-count-value { font-size: 2.5rem; }
      .next5-count-unit { transform: translateY(-4px); }
    }

    .next5-kicker {
      font-family: "Inter", sans-serif;
      font-size: 0.95rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .next5-count-grid {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .next5-count-row {
      display: flex;
      align-items: baseline;
      gap: 12px;
      line-height: 1;
    }

    .next5-count-value {
      font-family: "Inter", sans-serif;
      font-variant-numeric: tabular-nums;
      font-size: 3.1rem;
      font-weight: 900;
      letter-spacing: -0.02em;
      color: var(--text-primary);
      text-shadow: 0 0 0 transparent;
    }

    .next5-count-unit {
      font-family: "Inter", sans-serif;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: var(--text-secondary);
      transform: translateY(-6px);
    }

    .next5-countdown-label {
      margin-top: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .next5-date-label {
      color: var(--text-tertiary);
      font-size: 0.9rem;
      margin-bottom: 6px;
    }

    .next5-date {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text-primary);
    }

    .next5-note {
      margin-top: 10px;
      font-family: "Inter", sans-serif;
      font-size: 1rem;
      font-weight: 700;
      line-height: 1.4;
      color: var(--text-secondary);
    }

    /* Sub-animación suave en números (sin ser invasiva) */
    .next5-card .next5-count-value {
      animation: numberBreathe 5.5s ease-in-out infinite;
    }

    @keyframes numberBreathe {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-1px); }
    }

    @media (prefers-reduced-motion: reduce) {
      .next5-card,
      .next5-card::before,
      .next5-card .card-header::after,
      .next5-card .next5-count-value {
        animation: none !important;
      }
    }

    /* ==================== ANNIVERSARY ==================== */
    .together-count-grid .next5-count-value {
      font-size: 2.6rem;
    }

    .together-count-grid .next5-count-unit {
      font-size: 1.15rem;
      transform: translateY(-4px);
    }

    @media (max-width: 480px) {
      .together-count-grid .next5-count-value { font-size: 2.3rem; }
    }

    /* ==================== TOGETHER HIGHLIGHT CARD ==================== */
    .together-card {
      position: relative;
      overflow: hidden;
      border-width: 2px;
      border-color: color-mix(in srgb, var(--text-secondary) 35%, var(--text-light));
      box-shadow: var(--shadow-lg);
      background:
        radial-gradient(520px 260px at 18% 22%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 60%),
        radial-gradient(520px 260px at 88% 70%, color-mix(in srgb, var(--accent) 9%, transparent), transparent 60%),
        linear-gradient(180deg, var(--bg-white), var(--bg-light));
      transform: translateZ(0);
    }

    body.theme-diego .together-card {
      border-color: color-mix(in srgb, var(--diego-primary) 40%, var(--text-light));
    }

    body.theme-danna .together-card {
      border-color: color-mix(in srgb, var(--danna-primary) 40%, var(--text-light));
    }

    .together-card .card-header {
      background: transparent;
      border-bottom-color: transparent;
      align-items: flex-start;
      flex-direction: column;
      gap: 6px;
    }

    .together-card .card-header h2 {
      font-size: 1.2rem;
      font-weight: 900;
      letter-spacing: -0.01em;
    }

    .together-subtitle {
      font-size: 0.95rem;
      font-weight: 650;
      color: var(--text-tertiary);
    }

    .together-glow {
      position: absolute;
      inset: -40px;
      pointer-events: none;
      opacity: 0.85;
      filter: blur(18px);
      background:
        radial-gradient(240px 180px at 25% 35%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 62%),
        radial-gradient(260px 200px at 78% 65%, color-mix(in srgb, var(--accent) 16%, transparent), transparent 62%);
      animation: togetherGlow 9s ease-in-out infinite;
    }

    @keyframes togetherGlow {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-6px) scale(1.02); }
    }

    .together-hero {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
      position: relative;
      z-index: 1;
    }

    .together-big {
      font-family: "Inter", sans-serif;
      font-weight: 900;
      font-size: 1.25rem;
      letter-spacing: -0.01em;
      color: var(--text-primary);
    }

    .together-kicker {
      font-family: "Inter", sans-serif;
      font-weight: 750;
      font-size: 0.95rem;
      color: var(--text-secondary);
      opacity: 0.95;
    }

    .together-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 980px) {
      .together-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    @media (max-width: 480px) {
      .together-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .together-cell {
      border: 1px solid var(--text-light);
      background: color-mix(in srgb, var(--bg-white) 70%, var(--bg-light));
      border-radius: var(--radius-md);
      padding: 12px 10px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: var(--transition-fast);
    }

    .together-card:hover .together-cell {
      transform: translateY(-1px);
    }

    .together-value {
      font-family: "Inter", sans-serif;
      font-variant-numeric: tabular-nums;
      font-weight: 950;
      font-size: 2.2rem;
      line-height: 1;
      letter-spacing: -0.03em;
      color: var(--text-primary);
      animation: togetherNumber 5s ease-in-out infinite;
    }

    @keyframes togetherNumber {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-1px); }
    }

    .together-unit {
      margin-top: 6px;
      font-family: "Inter", sans-serif;
      font-weight: 750;
      font-size: 0.9rem;
      letter-spacing: 0.02em;
      color: var(--text-tertiary);
    }

    @media (prefers-reduced-motion: reduce) {
      .together-glow,
      .together-value {
        animation: none !important;
      }
    }

    /* ==================== DATE ROULETTE ==================== */
    .date-roulette-card {
      border-width: 2px;
      border-color: color-mix(in srgb, var(--text-secondary) 28%, var(--text-light));
      background: linear-gradient(180deg, var(--bg-white), var(--bg-light));
      overflow: hidden;
      position: relative;
    }

    .date-roulette-card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.75;
      background:
        radial-gradient(420px 240px at 16% 18%, color-mix(in srgb, var(--accent) 10%, transparent), transparent 62%),
        radial-gradient(520px 280px at 86% 78%, color-mix(in srgb, var(--accent) 8%, transparent), transparent 62%);
    }

    .date-roulette-actions {
      display: inline-flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .date-roulette-actions .btn[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none !important;
    }

    .date-roulette-layout {
      display: grid;
      grid-template-columns: minmax(240px, 360px) 1fr;
      gap: 16px;
      align-items: start;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 980px) {
      .date-roulette-layout {
        grid-template-columns: 1fr;
      }
    }

    .wheel-stage {
      width: 100%;
      max-width: 360px;
      margin: 0 auto;
      position: relative;
      aspect-ratio: 1;
      display: grid;
      place-items: center;
    }

    @media (max-width: 480px) {
      .wheel-stage { max-width: 320px; }
      .date-roulette-actions { width: 100%; justify-content: flex-end; }
      .date-roulette-actions .btn { flex: 1; }
    }

    .wheel-rotor {
      width: 100%;
      height: 100%;
      border-radius: 999px;
      border: 10px solid color-mix(in srgb, var(--bg-white) 65%, var(--text-light));
      box-shadow: var(--shadow-lg);
      background: var(--bg-white);
      overflow: hidden;
      transform: rotate(0deg);
      will-change: transform;
    }

    .wheel-stage.is-spinning .wheel-rotor {
      filter: saturate(1.03);
    }

    .wheel-rotor canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .wheel-pointer {
      position: absolute;
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 22px solid color-mix(in srgb, var(--accent) 80%, var(--text-primary));
      filter: drop-shadow(0 6px 8px rgba(0,0,0,0.18));
      z-index: 2;
    }

    .wheel-pointer::after {
      content: "";
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--bg-white);
      border: 2px solid color-mix(in srgb, var(--accent) 55%, var(--text-light));
    }

    .date-roulette-panel {
      border: 1px solid var(--text-light);
      border-radius: var(--radius-lg);
      background: color-mix(in srgb, var(--bg-white) 75%, var(--bg-light));
      box-shadow: var(--shadow-sm);
      padding: 14px 16px;
    }

    .date-roulette-result-label {
      font-weight: 850;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.82rem;
      color: var(--text-tertiary);
      margin-bottom: 8px;
    }

    .date-roulette-result {
      font-weight: 950;
      letter-spacing: -0.02em;
      font-size: 1.35rem;
      line-height: 1.2;
      color: var(--text-primary);
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid color-mix(in srgb, var(--accent) 22%, var(--text-light));
      background: linear-gradient(180deg, var(--bg-white), var(--bg-light));
    }

    .date-roulette-desc {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px dashed color-mix(in srgb, var(--accent) 20%, var(--text-light));
      background: color-mix(in srgb, var(--bg-white) 82%, var(--bg-light));
      color: var(--text-secondary);
      font-weight: 650;
      line-height: 1.55;
      min-height: 54px;
    }

    .date-roulette-result.is-ready {
      animation: popReady 320ms cubic-bezier(.2,.9,.2,1);
    }

    @keyframes popReady {
      from { transform: translateY(2px) scale(0.99); }
      to { transform: translateY(0) scale(1); }
    }

    .date-roulette-hint {
      margin-top: 10px;
      color: var(--text-tertiary);
      font-size: 0.95rem;
      line-height: 1.5;
      font-weight: 600;
    }

    .date-roulette-done {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px dashed var(--text-light);
    }

    .date-roulette-done-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 900;
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    .dates-done-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .date-done-item {
      border: 1px solid var(--text-light);
      background: var(--bg-white);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .date-done-title {
      font-weight: 850;
      color: var(--text-primary);
    }

    .date-done-meta {
      font-size: 0.88rem;
      color: var(--text-tertiary);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      font-weight: 650;
    }

    @media (prefers-reduced-motion: reduce) {
      .date-roulette-result.is-ready { animation: none !important; }
    }

    /* ==================== BONELLES ==================== */
    .star-input {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid var(--text-light);
      border-radius: var(--radius-md);
      background: var(--bg-light);
    }

    .star-btn {
      appearance: none;
      border: 0;
      background: transparent;
      padding: 8px;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 1.2rem;
      transition: var(--transition-fast);
      touch-action: manipulation;
    }

    body.theme-diego .star-btn.is-on { color: var(--diego-primary); }
    body.theme-danna .star-btn.is-on { color: var(--danna-primary); }

    .star-btn:hover { transform: translateY(-1px); }

    .star-hint {
      margin-top: 8px;
      color: var(--text-tertiary);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .bonelles-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bon-item {
      border: 1px solid var(--text-light);
      border-radius: var(--radius-lg);
      background: var(--bg-white);
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: var(--transition-fast);
    }

    .bon-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .bon-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .bon-title {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bon-meta {
      color: var(--text-tertiary);
      font-size: 0.9rem;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .bon-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .bon-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .bon-delete-btn {
      border: 1px solid var(--text-light);
      background: var(--bg-light);
      color: var(--text-secondary);
      padding: 8px 10px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .bon-edit-btn {
      border: 1px solid var(--text-light);
      background: var(--bg-light);
      color: var(--text-secondary);
      padding: 8px 10px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .bon-edit-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .bon-delete-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .bon-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--text-light);
      background: var(--bg-light);
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .bon-rating {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--text-secondary);
      font-weight: 700;
    }

    .bon-rating .stars {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .bon-rating .stars button {
      border: 0;
      background: transparent;
      padding: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      color: var(--text-tertiary);
      transition: var(--transition-fast);
      min-width: 36px;
      min-height: 36px;
      touch-action: manipulation;
    }

    body.theme-diego .bon-rating .stars button.is-on { color: var(--diego-primary); }
    body.theme-danna .bon-rating .stars button.is-on { color: var(--danna-primary); }

    .bon-rating .stars button:hover { transform: translateY(-1px); }

    /* ==================== FORMS ==================== */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      background: var(--surface-muted);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: var(--transition-fast);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-tertiary);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--text-secondary);
      background: var(--surface-strong);
      box-shadow: 0 0 0 4px var(--ring);
    }

    body.theme-diego input:focus,
    body.theme-diego select:focus,
    body.theme-diego textarea:focus {
      border-color: var(--diego-primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18);
    }

    body.theme-danna input:focus,
    body.theme-danna select:focus,
    body.theme-danna textarea:focus {
      border-color: var(--danna-primary);
      box-shadow: 0 0 0 4px rgba(219, 39, 119, 0.18);
    }

    textarea {
      min-height: 140px;
      resize: vertical;
      font-family: "Inter", sans-serif;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    /* ==================== BUTTONS ==================== */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:focus-visible {
      box-shadow: 0 0 0 4px var(--ring-strong);
    }

    .btn i {
      font-size: 0.95rem;
    }

    .btn-primary {
      width: 100%;
      padding: 14px 24px;
      color: white;
      border: none;
      font-weight: 600;
    }

    body.theme-diego .btn-primary {
      background: linear-gradient(135deg, var(--diego-primary), var(--diego-secondary));
    }

    body.theme-diego .btn-primary:hover {
      background: linear-gradient(135deg, var(--diego-secondary), var(--diego-primary));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    body.theme-danna .btn-primary {
      background: linear-gradient(135deg, var(--danna-primary), var(--danna-secondary));
    }

    body.theme-danna .btn-primary:hover {
      background: linear-gradient(135deg, var(--danna-secondary), var(--danna-primary));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(219, 39, 119, 0.3);
    }

    .btn-secondary {
      background: var(--bg-light);
      color: var(--text-primary);
      border: 1px solid var(--text-light);
    }

    .btn-secondary:hover {
      background: var(--bg-white);
      border-color: var(--text-secondary);
    }

    /* ==================== PAPER PREVIEW ==================== */
    .paper-preview {
      background: linear-gradient(135deg, #faf8f6 0%, #f3f0ed);
      border-radius: var(--radius-lg);
      padding: 40px;
      min-height: 520px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid #e5ddd6;
    }

    .paper-preview::before {
      content: "";
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(120px 90px at 15% 18%, rgba(255, 255, 255, 0.15), transparent 55%),
        repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.02) 1px, transparent 1px, transparent 26px);
      mix-blend-mode: multiply;
      pointer-events: none;
    }

    .paper-content {
      position: relative;
      z-index: 1;
    }

    .paper-title {
      font-family: "Playfair Display", serif;
      font-size: 2.2rem;
      color: #3a3a3a;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .paper-text {
      font-family: "Inter", sans-serif;
      font-size: 0.95rem;
      color: #4a4a4a;
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .paper-meta {
      display: flex;
      gap: 16px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid rgba(0, 0, 0, 0.1);
      font-size: 0.85rem;
      color: #6a6a6a;
      flex-wrap: wrap;
    }

    /* ==================== LETTER STYLES ==================== */
    /* Estilo Clásico */
    .paper-preview.style-classic {
      background: linear-gradient(135deg, #faf8f6 0%, #f3f0ed);
      border: 1px solid #e5ddd6;
    }

    .style-classic .paper-title {
      font-family: "Playfair Display", serif;
      font-size: 2.2rem;
      color: #3a3a3a;
    }

    .style-classic .paper-text {
      font-family: "Inter", sans-serif;
      color: #4a4a4a;
    }

    /* Estilo Vintage */
    .paper-preview.style-vintage {
      background: linear-gradient(135deg, #f4ede5 0%, #e8dfd5);
      border: 3px solid #8b7355;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2), inset 0 -2px 5px rgba(0,0,0,.1);
    }

    .style-vintage::before {
      background: 
        radial-gradient(120px 90px at 15% 18%, rgba(255, 255, 255, 0.3), transparent 55%),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,.05) 2px, rgba(0,0,0,.05) 4px);
    }

    .style-vintage .paper-title {
      font-family: "Playfair Display", serif;
      font-size: 2.5rem;
      color: #5a4a3a;
      text-shadow: 1px 1px 2px rgba(255,255,255,.5);
      font-weight: 700;
    }

    .style-vintage .paper-text {
      font-family: "Crimson Text", serif;
      font-size: 1.05rem;
      color: #5a4a3a;
      line-height: 1.9;
    }

    /* Estilo Moderno */
    .paper-preview.style-modern {
      background: linear-gradient(135deg, #ffffff 0%, #f5f5f5);
      border: 2px solid #d0d0d0;
      box-shadow: 0 10px 40px rgba(0,0,0,.1);
    }

    .style-modern::before {
      background: transparent;
    }

    .style-modern .paper-title {
      font-family: "Inter", sans-serif;
      font-size: 2rem;
      color: #1a1a1a;
      font-weight: 800;
      letter-spacing: -1px;
    }

    .style-modern .paper-text {
      font-family: "Inter", sans-serif;
      font-size: 0.95rem;
      color: #333333;
      line-height: 1.7;
      letter-spacing: 0.3px;
    }

    /* Estilo Romántico */
    .paper-preview.style-romantic {
      background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8);
      border: 2px dashed #db2777;
      border-radius: var(--radius-xl);
    }

    .style-romantic::before {
      background: 
        radial-gradient(100px 80px at 20% 25%, rgba(219, 39, 119, 0.05), transparent 50%);
    }

    .style-romantic .paper-title {
      font-family: "Dancing Script", cursive;
      font-size: 2.8rem;
      color: #db2777;
      font-weight: 700;
    }

    .style-romantic .paper-text {
      font-family: "Great Vibes", cursive;
      font-size: 1.3rem;
      color: #9d174d;
      line-height: 2;
      font-weight: 400;
    }

    /* ==================== LETTER FONTS ==================== */
    .font-sans-serif .paper-title {
      font-family: "Inter", sans-serif;
    }

    .font-sans-serif .paper-text {
      font-family: "Inter", sans-serif;
    }

    .font-serif .paper-title {
      font-family: "Playfair Display", serif;
    }

    .font-serif .paper-text {
      font-family: "Crimson Text", serif;
    }

    .font-cursive .paper-title {
      font-family: "Dancing Script", cursive;
    }

    .font-cursive .paper-text {
      font-family: "Great Vibes", cursive;
      font-size: 1.2rem;
      line-height: 2;
    }

    .font-monospace .paper-title {
      font-family: "Courier New", monospace;
      letter-spacing: 1px;
    }

    .font-monospace .paper-text {
      font-family: "Courier New", monospace;
      letter-spacing: 0.5px;
    }

    /* ==================== LETTERS LIST ==================== */
    .letters-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 650px;
      overflow-y: auto;
    }

    .letter-item {
      padding: 16px;
      background: var(--bg-light);
      border: 1px solid var(--text-light);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      animation: slideInLeft 0.4s ease;
      --letter-accent: var(--text-secondary);
      border-left-width: 6px;
    }

    /* Marca por autor (Diego = azul, Danna = rosa) */
    .letter-item.letter-from-diego {
      --letter-accent: var(--diego-primary);
      border-left-color: var(--diego-primary);
      background: color-mix(in srgb, var(--diego-primary) 8%, var(--bg-light));
    }

    .letter-item.letter-from-danna {
      --letter-accent: var(--danna-primary);
      border-left-color: var(--danna-primary);
      background: color-mix(in srgb, var(--danna-primary) 8%, var(--bg-light));
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .letter-item:hover {
      background: var(--bg-white);
      border-color: var(--text-secondary);
      border-left-color: var(--letter-accent);
      transform: translateX(4px);
      box-shadow: var(--shadow-sm);
    }

    .letter-item-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .letter-item-title i {
      color: var(--letter-accent);
    }

    .letter-item-meta {
      font-size: 0.8rem;
      color: var(--text-tertiary);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* ==================== GALLERY ==================== */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
      padding: 12px;
      border-radius: var(--radius-lg);
      border: 1px dashed var(--text-light);
      background: linear-gradient(180deg, var(--bg-light), var(--bg-white));
    }

    .gallery-item {
      position: relative;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--text-light);
      background: var(--bg-white);
      box-shadow: var(--shadow-sm);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      animation: scaleIn 0.4s ease;
      transform: rotate(-0.6deg);
    }

    .gallery-item:nth-child(2n) {
      transform: rotate(0.8deg);
    }

    .gallery-item:nth-child(3n) {
      transform: rotate(-1.0deg);
    }

    .gallery-item:hover {
      transform: translateY(-4px) rotate(0deg);
      box-shadow: var(--shadow-lg);
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .gallery-photo {
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--text-light);
      background: var(--bg-light);
      aspect-ratio: 1;
    }

    .gallery-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
      transform: scale(1.02);
    }

    .gallery-item:hover .gallery-photo img {
      transform: scale(1.08);
    }

    /* “cinta” sutil del álbum */
    .gallery-photo::before,
    .gallery-photo::after {
      content: "";
      position: absolute;
      width: 46px;
      height: 16px;
      border-radius: var(--radius-sm);
      background: var(--bg-white);
      border: 1px solid var(--text-light);
      opacity: 0.85;
      z-index: 2;
      pointer-events: none;
      transform: rotate(-8deg);
    }

    .gallery-photo::before {
      top: 8px;
      left: 10px;
    }

    .gallery-photo::after {
      bottom: 10px;
      right: 10px;
      transform: rotate(10deg);
    }

    .gallery-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transform: translateY(-6px);
      transition: var(--transition-fast);
      z-index: 2;
    }

    .gallery-item:hover .gallery-actions {
      opacity: 1;
      transform: translateY(0);
    }

    .gallery-action-btn {
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid var(--text-light);
      background: var(--bg-white);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    body.theme-diego .gallery-action-btn { color: var(--diego-primary); }
    body.theme-danna .gallery-action-btn { color: var(--danna-primary); }

    .gallery-action-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .gallery-action-btn:active {
      transform: translateY(0);
    }

    .gallery-item-caption {
      color: var(--text-primary);
      font-family: "Great Vibes", cursive;
      font-size: 1.35rem;
      line-height: 1.25;
      font-weight: 400;
      padding: 0 4px;
    }

    .gallery-item-caption .caption-meta {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      opacity: 0.95;
      font-size: 0.9rem;
      margin-top: 6px;
      color: var(--text-tertiary);
      font-family: "Inter", sans-serif;
      font-weight: 600;
    }

    @media (max-width: 480px) {
      .gallery-item-caption { font-size: 1.2rem; }
    }

    /* ==================== NOTIFICATIONS ==================== */
    .toasts-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: var(--bg-white);
      border: 1px solid var(--text-light);
      padding: 16px 20px;
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.9rem;
      box-shadow: var(--shadow-lg);
      animation: slideInRight 0.3s ease;
      min-width: 280px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast i {
      font-size: 1rem;
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .toast.success {
      border-color: #10b981;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
    }

    .toast.success i {
      color: #10b981;
    }

    .toast.error {
      border-color: #ef4444;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.02));
    }

    .toast.error i {
      color: #ef4444;
    }

    /* ==================== STATS ==================== */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .stat-box {
      text-align: center;
      padding: 20px;
      background: var(--bg-light);
      border: 1px solid var(--text-light);
      border-radius: var(--radius-md);
      transition: var(--transition);
    }

    .stat-box:hover {
      background: var(--bg-white);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .stat-number {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    body.theme-diego .stat-number {
      color: var(--diego-primary);
    }

    body.theme-danna .stat-number {
      color: var(--danna-primary);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .stat-label i {
      font-size: 1rem;
      opacity: 0.6;
    }

    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
      main { padding: 20px 16px; }
      .grid-2 { gap: 16px; }
      .card-body { padding: 16px; }
      .paper-preview { padding: 24px; min-height: 380px; }
      .paper-title { font-size: 1.8rem; }
      .paper-text { font-size: 1rem; }
      .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }

    @media (max-width: 480px) {
      header { padding: calc(12px + env(safe-area-inset-top)) 0 12px; }
      .header-content {
        padding: 0 calc(14px + env(safe-area-inset-left)) 0 calc(14px + env(safe-area-inset-right));
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .brand { justify-content: flex-start; }
      .header-actions { width: 100%; justify-content: space-between; }

      main {
        padding: 18px calc(14px + env(safe-area-inset-left)) calc(22px + env(safe-area-inset-bottom)) calc(14px + env(safe-area-inset-right));
      }

      .login-container { padding: 42px 18px; }

      .login-buttons { grid-template-columns: 1fr; }
      .tabs { gap: 6px; padding: 6px; }
      .tab-btn { padding: 10px 12px; font-size: 0.86rem; }
      .header-actions { gap: 8px; }
      .user-badge, .logout-btn { font-size: 0.76rem; padding: 8px 12px; }

      .card-header { padding: 16px; }
      .card-body { padding: 14px; }
      .stat-box { padding: 14px; }
      .stat-number { font-size: 1.85rem; }

      .modal-header { padding: 16px; }
      .modal-body { padding: 16px; }
      .modal-content {
        max-height: calc(100dvh - 24px);
      }
    }

    .scroll-animation {
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .scroll-animation.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ==================== MODAL CARTA ==================== */
    .letter-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 8000;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: all 0.3s ease;
      padding: 20px;
    }

    .letter-modal.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .modal-content {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: 0;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideUp 0.4s ease;
      box-shadow: var(--shadow-xl);
    }

    @keyframes modalSlideUp {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--text-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-light);
    }

    .modal-header h2 {
      font-size: 1.3rem;
      color: var(--text-primary);
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition-fast);
      padding: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--text-primary);
      background: var(--bg-white);
      border-radius: var(--radius-sm);
    }

    .modal-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .modal-action {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.05rem;
      cursor: pointer;
      transition: var(--transition-fast);
      padding: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-action:hover {
      color: var(--text-primary);
      background: var(--bg-white);
      border-radius: var(--radius-sm);
    }

    .modal-action.danger:hover {
      color: #ef4444;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-paper {
      background: linear-gradient(135deg, #faf8f6 0%, #f3f0ed);
      border-radius: var(--radius-lg);
      padding: 40px;
      position: relative;
      overflow: hidden;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      min-height: 300px;
      border: 1px solid #e5ddd6;
    }

    .modal-paper::before {
      content: "";
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(120px 90px at 15% 18%, rgba(255, 255, 255, 0.15), transparent 55%),
        repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.02) 1px, transparent 1px, transparent 26px);
      mix-blend-mode: multiply;
      pointer-events: none;
    }

    /* Aplicar estilos al modal */
    .modal-paper.style-vintage {
      background: linear-gradient(135deg, #f4ede5 0%, #e8ddf5);
      border: 3px solid #8b7355;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2), inset 0 -2px 5px rgba(0,0,0,.1);
    }

    .modal-paper.style-modern {
      background: linear-gradient(135deg, #ffffff 0%, #f5f5f5);
      border: 2px solid #d0d0d0;
      box-shadow: 0 10px 40px rgba(0,0,0,.1);
    }

    .modal-paper.style-romantic {
      background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8);
      border: 2px dashed #db2777;
      border-radius: var(--radius-xl);
    }

    .modal-paper-content {
      position: relative;
      z-index: 1;
    }

    .modal-paper-title {
      font-family: "Playfair Display", serif;
      font-size: 2.2rem;
      color: #3a3a3a;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .modal-paper-text {
      font-family: "Inter", sans-serif;
      font-size: 0.95rem;
      color: #4a4a4a;
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Tipografías en modal */
    .modal-paper.font-serif .modal-paper-title {
      font-family: "Playfair Display", serif;
    }

    .modal-paper.font-serif .modal-paper-text {
      font-family: "Crimson Text", serif;
    }

    .modal-paper.font-cursive .modal-paper-title {
      font-family: "Dancing Script", cursive;
      font-size: 2.8rem;
    }

    .modal-paper.font-cursive .modal-paper-text {
      font-family: "Great Vibes", cursive;
      font-size: 1.3rem;
      line-height: 2;
    }

    .modal-paper.font-monospace .modal-paper-title {
      font-family: "Courier New", monospace;
      letter-spacing: 1px;
    }

    .modal-paper.font-monospace .modal-paper-text {
      font-family: "Courier New", monospace;
      letter-spacing: 0.5px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .modal-meta {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 24px;
    }

    .meta-item {
      background: var(--bg-light);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      color: var(--text-secondary);
      border: 1px solid var(--text-light);
    }

    .meta-label {
      font-weight: 600;
      color: var(--text-primary);
      display: block;
      margin-bottom: 4px;
    }

    /* ==================== MUSIC PLAYER ==================== */
    .music-player {
      background: var(--bg-light);
      border: 1px solid var(--text-light);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .player-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      width: 40px;
      height: 40px;
    }

    body.theme-diego .player-btn:hover {
      background: rgba(37, 99, 235, 0.1);
      color: var(--diego-primary);
      border-radius: var(--radius-sm);
    }

    body.theme-danna .player-btn:hover {
      background: rgba(219, 39, 119, 0.1);
      color: var(--danna-primary);
      border-radius: var(--radius-sm);
    }

    .player-info {
      flex: 1;
      min-width: 0;
    }

    .player-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-artist {
      font-size: 0.8rem;
      color: var(--text-tertiary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-progress {
      width: 60px;
      height: 3px;
      background: var(--text-light);
      border-radius: 2px;
      overflow: hidden;
    }

    .player-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--diego-primary), var(--danna-primary));
      border-radius: 2px;
    }

    /* Mobile: que la canción no se "apriete" y el embed sea responsive */
    @media (max-width: 520px) {
      .music-player {
        flex-wrap: wrap;
        gap: 12px;
        padding: 14px;
      }

      .player-btn {
        width: 44px;
        height: 44px;
      }

      .player-info {
        flex: 1 1 auto;
        min-width: 0;
      }

      .player-progress {
        width: 100%;
        height: 4px;
      }

      #playerContainer {
        width: 100%;
      }

      #playerContainer iframe,
      #playerContainer video {
        width: 100% !important;
        max-width: 100% !important;
        aspect-ratio: 16 / 9;
        height: auto !important;
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .modal-meta {
        grid-template-columns: 1fr;
      }

      .letters-list {
        max-height: 55vh;
      }
    }

    /* ==================== CUSTOM SELECT ==================== */
    .custom-select {
      position: relative;
    }

    .select-trigger {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-light);
      border: 1px solid var(--text-light);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .select-trigger:hover {
      border-color: var(--text-secondary);
      background: var(--bg-white);
    }

    body.theme-diego .select-trigger:focus,
    body.theme-diego .select-trigger.active {
      border-color: var(--diego-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      background: var(--bg-white);
    }

    body.theme-danna .select-trigger:focus,
    body.theme-danna .select-trigger.active {
      border-color: var(--danna-primary);
      box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.1);
      background: var(--bg-white);
    }

    .select-trigger-icon {
      font-size: 0.8rem;
      transition: transform 0.3s ease;
      color: var(--text-secondary);
    }

    .select-trigger.active .select-trigger-icon {
      transform: scaleY(-1);
    }

    .select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-white);
      border: 1px solid var(--text-light);
      border-radius: var(--radius-md);
      margin-top: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
    }

    .select-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .select-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--text-light);
      color: var(--text-primary);
    }

    .select-option:last-child {
      border-bottom: none;
    }

    .select-option:hover {
      background: var(--bg-light);
    }

    .select-option.selected {
      background: var(--bg-light);
    }

    body.theme-diego .select-option.selected {
      color: var(--diego-primary);
      font-weight: 500;
    }

    body.theme-danna .select-option.selected {
      color: var(--danna-primary);
      font-weight: 500;
    }

    .select-option-emoji {
      font-size: 1.2rem;
      min-width: 30px;
    }

    /* ==================== SONG SEARCH ==================== */
    .song-search-container {
      position: relative;
    }

    #songSearchInput {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-light);
      border: 2px solid var(--text-light);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: var(--transition-fast);
    }

    #songSearchInput:focus {
      outline: none;
      border-color: var(--diego-primary);
      background: var(--bg-white);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    body.theme-danna #songSearchInput:focus {
      border-color: var(--danna-primary);
      box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.1);
    }

    .song-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-white);
      border: 1px solid var(--text-light);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      max-height: 320px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: var(--shadow-md);
    }

    .song-result-item {
      padding: 12px 14px;
      cursor: pointer;
      transition: var(--transition-fast);
      border-bottom: 1px solid var(--text-light);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .song-result-item:last-child {
      border-bottom: none;
    }

    .song-result-item:hover {
      background: var(--bg-light);
    }

    .song-result-title {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .song-result-artist {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .selected-song-info {
      margin-top: 12px;
      padding: 12px 14px;
      background: linear-gradient(135deg, var(--diego-light), var(--danna-light));
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    body.theme-danna .selected-song-info {
      background: linear-gradient(135deg, var(--danna-light), var(--diego-light));
    }

    .selected-song-details {
      flex: 1;
      min-width: 0;
    }

    #selectedSongTitle {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #selectedSongArtist {
      color: var(--text-secondary);
      font-size: 0.85rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.85rem;
      white-space: nowrap;
      flex-shrink: 0;
    }
.select-option-text {
      flex: 1;
    }

    .select-option-label {
      font-size: 0.85rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .select-option-desc {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    /* ==================== MODERN POLISH ==================== */
    .card {
      transition: var(--transition);
      transform: translateZ(0);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .btn {
      transition: var(--transition-fast);
      transform: translateZ(0);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0px);
    }

    .btn-youtube {
      background: var(--bg-dark);
      color: var(--bg-white);
      border: 1px solid rgb(0 0 0 / 0.08);
    }

    .btn-youtube:hover {
      filter: brightness(1.05);
    }

    .tab-btn {
      position: relative;
    }

    /* El indicador “subrayado” anterior se reemplaza por el chip activo (background/borde) */
    .tab-btn::after { display: none; }

    input, textarea {
      transition: var(--transition-fast);
    }

    input:focus, textarea:focus {
      outline: none;
      box-shadow: var(--shadow-md);
    }

    .letter-item {
      transition: var(--transition-fast);
    }

    .letter-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .modal-content {
      transform: translateY(8px);
      transition: var(--transition);
    }

    .letter-modal.active .modal-content {
      transform: translateY(0px);
    }
  </style>
</head>
<body>
  <script>
    // Login rápido: si se toca Diego/Danna antes de que cargue el JS completo,
    // guardamos la elección y la ejecutamos cuando el initApp real esté listo.
    window.__queuedLoginUser = window.__queuedLoginUser || null;
    if (typeof window.initApp !== "function") {
      window.initApp = function(user) {
        window.__queuedLoginUser = user;
      };
    }
  </script>
  <!-- LOGIN SCREEN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-container">
      <div class="login-icon"><i class="fas fa-envelope"></i></div>
      <h1 class="login-title">Diego Y Danna</h1>
      <p class="login-subtitle">Juntos X Siempre</p>
      <div class="login-buttons">
        <button class="login-btn diego" id="btnDiego" onclick="window.initApp('diego')">
          <span class="login-avatar" aria-hidden="true">
            <img src="diego.jpeg" alt="" onerror="this.style.display='none'; this.parentElement.nextElementSibling.style.display='inline-flex';" />
          </span>
          <span class="login-avatar-fallback" aria-hidden="true" style="display:none;"><i class="fas fa-user"></i></span>
          <span>Diego</span>
        </button>
        <button class="login-btn danna" id="btnDanna" onclick="window.initApp('danna')">
          <span class="login-avatar" aria-hidden="true">
            <img src="danna.jpeg" alt="" onerror="this.style.display='none'; this.parentElement.nextElementSibling.style.display='inline-flex';" />
          </span>
          <span class="login-avatar-fallback" aria-hidden="true" style="display:none;"><i class="fas fa-user"></i></span>
          <span>Danna</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <header id="mainHeader" style="display: none">
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon primary-gradient" aria-hidden="true"><i class="fas fa-heart"></i></div>
        <div class="brand-text">
          <h1>Diego Y Danna</h1>
          <p id="brandSubtitle">Diego Y Danna</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="header-user-row">
          <div class="user-badge" id="userBadge"></div>
          <button class="notif-icon-btn" id="pendingIconBtnHeader" type="button" onclick="window.onPendingIconClick(event)" title="Ver pendientes" aria-label="Ver pendientes" aria-haspopup="dialog" aria-expanded="false">
            <img id="pendingIconImgHeader" src="inactiva.png" alt="Pendientes" />
            <span class="pending-badge pending-badge--header" id="pendingTotalBadgeHeader" style="display:none;">0</span>
          </button>
        </div>
        <button class="logout-btn" onclick="window.logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
      </div>
    </div>
  </header>

  <!-- Lightbox de portada -->
  <div class="cover-lightbox" id="coverLightbox" aria-hidden="true">
    <div class="cover-lightbox-inner" role="dialog" aria-modal="true" aria-label="Portada">
      <button class="cover-lightbox-close" type="button" onclick="window.closeCoverLightbox()" aria-label="Cerrar portada" title="Cerrar">
        <i class="fas fa-times"></i>
      </button>
      <div class="cover-lightbox-stage" id="coverLightboxStage">
        <img id="coverLightboxImg" src="" alt="Portada" />
      </div>
    </div>
  </div>

  <main id="mainContent" style="display: none">
    <div class="tabs">
      <button class="tab-btn active" data-tab="inicio"><i class="fas fa-chart-line"></i> Inicio</button>
      <button class="tab-btn" data-tab="cartas"><i class="fas fa-feather-alt"></i> Cartas</button>
      <button class="tab-btn" data-tab="galeria"><i class="fas fa-images"></i> Galería</button>
      <button class="tab-btn" data-tab="bonelles"><i class="fas fa-utensils"></i> Bonelles</button>
      <button class="tab-btn" data-tab="ajustes"><i class="fas fa-cog"></i> Ajustes</button>
    </div>

    <!-- INICIO TAB -->
    <div class="tab-content active" id="tab-inicio">
      <div class="cover-hero scroll-animation" id="inicioCover">
        <img src="portada.jpeg" alt="Portada" onerror="this.closest('#inicioCover').style.display='none'" />
        <div class="cover-overlay">
          <div class="cover-title">
            Diego Y Danna
            <small>Diego Y Danna</small>
          </div>
          <div class="cover-badge"><i class="fas fa-heart"></i> Nuestro lugar seguro</div>
        </div>
      </div>

      <div class="card scroll-animation pending-section" id="inicioNotificaciones">
        <div class="card-header">
          <h2><i class="fas fa-bell"></i> Notificaciones</h2>
        </div>
        <div class="card-body">
          <div style="display:flex; align-items:center; gap: 14px; flex-wrap: wrap;">
            <button class="pending-icon-btn" id="pendingIconBtn" type="button" onclick="window.onPendingIconClick(event)" title="Ver pendientes" aria-label="Ver pendientes" aria-haspopup="dialog" aria-expanded="false">
              <img id="pendingIconImg" src="inactiva.png" alt="Pendientes" />
              <span class="pending-badge" id="pendingTotalBadge" style="display:none;">0</span>
            </button>
            <div style="display:flex; flex-direction:column; gap: 2px; min-width: 200px;">
              <div style="font-weight: 800; color: var(--text-primary);">Pendientes</div>
              <div style="color: var(--text-tertiary); font-weight: 650; font-size: 0.9rem;">Toca el icono para ver el detalle.</div>
            </div>
          </div>

          <div class="pending-panel" id="pendingPanel" aria-hidden="true">
            <div class="pending-panel-header">
              <div class="pending-panel-title"><i class="fas fa-bell"></i> Pendientes</div>
              <button class="pending-panel-close" type="button" onclick="window.togglePendingPanel(false)" aria-label="Cerrar pendientes" title="Cerrar">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="pending-panel-body">
              <div class="pending-row">
                <div class="pending-row-left"><i class="fas fa-envelope-open-text"></i> <span>Cartas sin leer</span></div>
                <div class="pending-row-count"><span id="pendingLetters">0</span></div>
              </div>
              <div class="pending-row">
                <div class="pending-row-left"><i class="fas fa-camera-retro"></i> <span>Fotos nuevas</span></div>
                <div class="pending-row-count"><span id="pendingPhotos">0</span></div>
              </div>
              <div class="pending-row">
                <div class="pending-row-left"><i class="fas fa-star"></i> <span>Bonelles por calificar</span></div>
                <div class="pending-row-count"><span id="pendingBonelles">0</span></div>
              </div>

              <div class="pending-actions">
                <button class="btn btn-secondary btn-small" type="button" onclick="window.goToTab('cartas'); window.togglePendingPanel(false)"><i class="fas fa-feather-alt"></i> Cartas</button>
                <button class="btn btn-secondary btn-small" type="button" onclick="window.goToTab('galeria'); window.togglePendingPanel(false)"><i class="fas fa-images"></i> Galería</button>
                <button class="btn btn-secondary btn-small" type="button" onclick="window.goToTab('bonelles'); window.togglePendingPanel(false)"><i class="fas fa-utensils"></i> Bonelles</button>
              </div>

              <div class="pending-note"><i class="fas fa-heart"></i> Se actualiza al abrir una carta o la galería.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2 scroll-animation">
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-pie"></i> Estadísticas</h2>
          </div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-number"><span id="dashTotalLetters">0</span></div>
                <div class="stat-label"><i class="fas fa-envelope"></i> Cartas totales</div>
              </div>
              <div class="stat-box">
                <div class="stat-number"><span id="dashTotalPhotos">0</span></div>
                <div class="stat-label"><i class="fas fa-image"></i> Fotos subidas</div>
              </div>
              <div class="stat-box">
                <div class="stat-number"><span id="dashLettersDiego">0</span></div>
                <div class="stat-label"><i class="fas fa-user"></i> Cartas Diego</div>
              </div>
              <div class="stat-box">
                <div class="stat-number"><span id="dashLettersDanna">0</span></div>
                <div class="stat-label"><i class="fas fa-user"></i> Cartas Danna</div>
              </div>
              <div class="stat-box">
                <div class="stat-number"><span id="dashPhotosDiego">0</span></div>
                <div class="stat-label"><i class="fas fa-user"></i> Fotos Diego</div>
              </div>
              <div class="stat-box">
                <div class="stat-number"><span id="dashPhotosDanna">0</span></div>
                <div class="stat-label"><i class="fas fa-user"></i> Fotos Danna</div>
              </div>
            </div>
          </div>
        </div>

        <div class="countdowns-grid">
          <div class="card next5-card">
            <div class="card-header primary-gradient">
              <h2><i class="fas fa-calendar-day"></i> Próximo día 5</h2>
            </div>
            <div class="card-body">
              <div class="next5-layout">
                <div>
                  <div class="next5-kicker"><i class="fas fa-heart"></i> Cuenta regresiva</div>
                  <div class="next5-count-grid">
                    <div class="next5-count-row">
                      <div class="next5-count-value" id="dashDaysTo5">0</div>
                      <div class="next5-count-unit">días</div>
                    </div>
                    <div class="next5-count-row">
                      <div class="next5-count-value" id="dashHoursTo5">00</div>
                      <div class="next5-count-unit">horas</div>
                    </div>
                    <div class="next5-count-row">
                      <div class="next5-count-value" id="dashMinutesTo5">00</div>
                      <div class="next5-count-unit">minutos</div>
                    </div>
                    <div class="next5-count-row">
                      <div class="next5-count-value" id="dashSecondsTo5">00</div>
                      <div class="next5-count-unit">segundos</div>
                    </div>
                  </div>
                  <div class="next5-countdown-label" id="dashCountdownLabel">Para nuestro día 5 • falta</div>
                </div>
                <div class="next5-side">
                  <div class="next5-date-label">Fecha del próximo 5</div>
                  <div class="next5-date" id="dashNext5">—</div>
                  <div class="next5-note">Un mes más para volver a elegirnos</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card next5-card">
            <div class="card-header primary-gradient">
              <h2><i class="fas fa-ring"></i> Aniversario • 5 de agosto</h2>
            </div>
            <div class="card-body">
              <div class="next5-layout">
                <div>
                  <div class="next5-kicker"><i class="fas fa-hourglass-half"></i> Cuenta regresiva</div>
                  <div class="next5-count-grid">
                    <div class="next5-count-row">
                      <div class="next5-count-value" id="dashAnnDays">0</div>
                      <div class="next5-count-unit">días</div>
                    </div>
                    <div class="next5-count-row">
                      <div class="next5-count-value" id="dashAnnHours">00</div>
                      <div class="next5-count-unit">horas</div>
                    </div>
                    <div class="next5-count-row">
                      <div class="next5-count-value" id="dashAnnMinutes">00</div>
                      <div class="next5-count-unit">minutos</div>
                    </div>
                    <div class="next5-count-row">
                      <div class="next5-count-value" id="dashAnnSeconds">00</div>
                      <div class="next5-count-unit">segundos</div>
                    </div>
                  </div>
                  <div class="next5-countdown-label" id="dashAnnCountdownLabel">Para nuestro aniversario • falta</div>
                </div>
                <div class="next5-side">
                  <div class="next5-date-label">Próximo 5 de agosto</div>
                  <div class="next5-date" id="dashNextAnniversary">—</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card together-card">
            <div class="together-glow" aria-hidden="true"></div>
            <div class="card-header">
              <h2><i class="fas fa-infinity"></i> Tiempo juntos</h2>
              <div class="together-subtitle">Desde el 5 de agosto de 2024</div>
            </div>
            <div class="card-body">
              <div class="together-hero">
                <div class="together-big" id="dashTogetherTotalLabel">Cada segundo cuenta</div>
                <div class="together-kicker">y nosotros ya llevamos…</div>
              </div>

              <div class="together-grid">
                <div class="together-cell">
                  <div class="together-value" id="dashTogetherYears">0</div>
                  <div class="together-unit">años</div>
                </div>
                <div class="together-cell">
                  <div class="together-value" id="dashTogetherMonths">0</div>
                  <div class="together-unit">meses</div>
                </div>
                <div class="together-cell">
                  <div class="together-value" id="dashTogetherDays">0</div>
                  <div class="together-unit">días</div>
                </div>
                <div class="together-cell">
                  <div class="together-value" id="dashTogetherHours">00</div>
                  <div class="together-unit">horas</div>
                </div>
                <div class="together-cell">
                  <div class="together-value" id="dashTogetherMinutes">00</div>
                  <div class="together-unit">minutos</div>
                </div>
                <div class="together-cell">
                  <div class="together-value" id="dashTogetherSeconds">00</div>
                  <div class="together-unit">segundos</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card date-roulette-card">
          <div class="card-header">
            <h2><i class="fas fa-dice"></i> Ruleta de cita</h2>
            <div class="date-roulette-actions">
              <button class="btn btn-secondary" id="btnSpinDate" onclick="window.spinDateWheel()"><i class="fas fa-sync-alt"></i> Girar</button>
              <button class="btn btn-primary" id="btnAcceptDate" onclick="window.acceptDateIdea()" disabled><i class="fas fa-check"></i> Aceptar</button>
            </div>
          </div>
          <div class="card-body">
            <div class="date-roulette-layout">
              <div class="wheel-stage" aria-label="Ruleta de cita">
                <div class="wheel-pointer" aria-hidden="true"></div>
                <div class="wheel-rotor" id="dateWheelRotor">
                  <canvas id="dateWheelCanvas" width="520" height="520"></canvas>
                </div>
              </div>

              <div class="date-roulette-panel">
                <div class="date-roulette-result-label">Idea elegida</div>
                <div class="date-roulette-result" id="dateRouletteResult">Gira la ruleta…</div>
                <div class="date-roulette-desc" id="dateRouletteDesc"> </div>
                <div class="date-roulette-hint" id="dateRouletteHint">Toca “Girar” y luego “Aceptar” para guardarla en Citas hechas.</div>

                <div class="date-roulette-done">
                  <div class="date-roulette-done-title"><i class="fas fa-history"></i> Citas hechas</div>
                  <div class="dates-done-list" id="datesDoneList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-utensils"></i> Bonelles • Este año</h2>
          </div>
          <div class="card-body">
            <div id="dashBonellesYear" style="color: var(--text-secondary); line-height: 1.7;">
              Cargando...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CARTAS TAB -->
    <div class="tab-content" id="tab-cartas">
      <div class="grid-2 scroll-animation">
        <!-- Editor -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-pen-fancy"></i> Nueva Carta</h2>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label>Destinatario</label>
              <div class="custom-select" id="selectTo">
                <button class="select-trigger" onclick="window.toggleSelect('selectTo')">
                  <span id="triggerTo">Selecciona a quién escribir</span>
                  <span class="select-trigger-icon">▼</span>
                </button>
                <div class="select-dropdown" id="dropdownTo"></div>
              </div>
              <input type="hidden" id="letterTo" />
            </div>

            <div class="form-group">
              <label>Título</label>
              <input type="text" id="letterTitle" placeholder="Un título especial..." maxlength="100" />
            </div>

            <div class="form-group">
              <label><i class="fas fa-music"></i> Busca una canción de YouTube Music</label>
              <div class="song-search-container">
                <input type="url" id="songSearchInput" placeholder="Pega la URL de YouTube (ej: youtube.com/watch?v=...)" maxlength="200" />
                <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-top: 4px; font-style: italic;">Ejemplo: https://www.youtube.com/watch?v=dQw4w9WgXcQ</div>
              </div>
              <div id="selectedSongInfo" class="selected-song-info" style="display: none;">
                <div class="selected-song-details">
                  <div id="selectedSongTitle"></div>
                  <div id="selectedSongArtist"></div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button type="button" class="btn btn-small btn-youtube" id="openYouTubeBtn" style="display: none;" title="Abre en YouTube">
                    <i class="fab fa-youtube"></i> YouTube
                  </button>
                  <button type="button" class="btn btn-small" onclick="window.clearSongSelection()">Cambiar</button>
                </div>
              </div>
              <input type="hidden" id="letterSong" />
              <input type="hidden" id="selectedSongUrl" />
            </div>

            <div class="form-group">
              <label><i class="fas fa-pen-fancy"></i> Estilo de Carta</label>
              <div class="custom-select" id="selectStyle">
                <button class="select-trigger" onclick="window.toggleSelect('selectStyle')">
                  <span id="triggerStyle"><i class="fas fa-file-lines"></i> Clásico</span>
                  <span class="select-trigger-icon">▼</span>
                </button>
                <div class="select-dropdown" id="dropdownStyle"></div>
              </div>
              <input type="hidden" id="letterStyle" value="classic" />
            </div>

            <div class="form-group">
              <label><i class="fas fa-font"></i> Tipografía</label>
              <div class="custom-select" id="selectFont">
                <button class="select-trigger" onclick="window.toggleSelect('selectFont')">
                  <span id="triggerFont">Sans Serif</span>
                  <span class="select-trigger-icon">▼</span>
                </button>
                <div class="select-dropdown" id="dropdownFont"></div>
              </div>
              <input type="hidden" id="letterFont" value="sans-serif" />
            </div>

            <div class="form-group">
              <label>Tu sentimiento hoy</label>
              <div class="custom-select" id="selectMood">
                <button class="select-trigger" onclick="window.toggleSelect('selectMood')">
                  <span id="triggerMood"><i class="fas fa-heart"></i> Selecciona un sentimiento</span>
                  <span class="select-trigger-icon">▼</span>
                </button>
                <div class="select-dropdown" id="dropdownMood"></div>
              </div>
              <input type="hidden" id="letterMood" value="love" />
            </div>

            <div class="form-group">
              <label>Tu Mensaje</label>
              <textarea id="letterText" placeholder="Escribe tu corazón aquí..."></textarea>
            </div>

            <button class="btn btn-primary" onclick="window.saveLetter()"><i class="fas fa-paper-plane"></i> Enviar Carta</button>
          </div>
        </div>

        <!-- Preview -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-eye"></i> Previsualización</h2>
          </div>
          <div class="card-body">
            <div class="paper-preview" id="paperPreview">
              <div class="paper-content">
                <div class="paper-title" id="previewTitle">Sin título</div>
                <div class="paper-text" id="previewText">Escribe y verás la previsualización aquí...</div>
                <div class="paper-meta">
                  <span id="previewMood"><i class="fas fa-heart"></i></span>
                  <span id="previewFrom">De: —</span>
                  <span id="previewTo">Para: —</span>
                  <span id="previewDate">—</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cartas Guardadas -->
      <div class="card scroll-animation">
        <div class="card-header">
          <h2><i class="fas fa-inbox"></i> Mis Cartas</h2>
          <div style="display: flex; gap: 8px; flex-wrap: wrap">
            <button class="btn btn-secondary" onclick="window.filterLetters('inbox')" style="font-size: 0.85rem;"><i class="fas fa-arrow-down"></i> Recibidas</button>
            <button class="btn btn-secondary" onclick="window.filterLetters('all')" style="font-size: 0.85rem;"><i class="fas fa-arrow-up"></i> Enviadas</button>
          </div>
        </div>
        <div class="card-body">
          <div class="letters-list" id="lettersList">
            <p style="text-align: center; color: var(--text-tertiary); padding: 20px">Cargando cartas...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- GALERIA TAB -->
    <div class="tab-content" id="tab-galeria">
      <div class="grid-2 scroll-animation">
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-camera"></i> Agregar Foto</h2>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label>Subir desde tu dispositivo</label>
              <input type="file" id="photoFile" accept="image/*" />
              <p style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 8px; line-height: 1.5;">
                <i class="fas fa-info-circle"></i> La foto se comprime en el navegador y se guarda en Firestore como imagen optimizada.
              </p>
            </div>
            <div class="form-group">
              <label>O pegar URL (opcional)</label>
              <input type="url" id="photoUrl" placeholder="https://..." />
            </div>
            <div class="form-group">
              <label>Descripción</label>
              <input type="text" id="photoCaption" placeholder="Un recuerdo especial..." />
            </div>
            <button class="btn btn-primary" onclick="window.addPhoto()"><i class="fas fa-upload"></i> Agregar Foto</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-bar"></i> Estadísticas</h2>
          </div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-number"><span id="statsLetters">0</span></div>
                <div class="stat-label"><i class="fas fa-envelope"></i> Cartas</div>
              </div>
              <div class="stat-box">
                <div class="stat-number"><span id="statsPhotos">0</span></div>
                <div class="stat-label"><i class="fas fa-image"></i> Fotos</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card scroll-animation">
        <div class="card-header">
          <h2><i class="fas fa-images"></i> Galería</h2>
        </div>
        <div class="card-body">
          <div class="gallery-grid" id="galleryGrid">
            <p style="grid-column: 1/-1; text-align: center; color: var(--text-tertiary); padding: 40px">
              Aún no hay fotos. ¡Agrega una!
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- BONELLES TAB -->
    <div class="tab-content" id="tab-bonelles">
      <div class="grid-2 scroll-animation">
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-utensils"></i> Bonelles</h2>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label>Comida</label>
              <input type="text" id="bonFood" placeholder="Ej: hamburguesa, sushi, pizza..." maxlength="60" />
            </div>
            <div class="form-group">
              <label>Día</label>
              <input type="date" id="bonDate" />
            </div>
            <div class="form-group">
              <label>Restaurante</label>
              <input type="text" id="bonRestaurant" placeholder="Nombre del restaurante" maxlength="80" />
            </div>
            <div class="form-group">
              <label>¿Dónde lo comimos?</label>
              <select id="bonWhere">
                <option value="lugar">En el lugar</option>
                <option value="casa">En su casa</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tu calificación</label>
              <div class="star-input" id="bonMyRating" data-value="0">
                <button type="button" class="star-btn" data-star="1" onclick="window.setStarValue('bonMyRating', 1)"><i class="fa-regular fa-star"></i></button>
                <button type="button" class="star-btn" data-star="2" onclick="window.setStarValue('bonMyRating', 2)"><i class="fa-regular fa-star"></i></button>
                <button type="button" class="star-btn" data-star="3" onclick="window.setStarValue('bonMyRating', 3)"><i class="fa-regular fa-star"></i></button>
                <button type="button" class="star-btn" data-star="4" onclick="window.setStarValue('bonMyRating', 4)"><i class="fa-regular fa-star"></i></button>
                <button type="button" class="star-btn" data-star="5" onclick="window.setStarValue('bonMyRating', 5)"><i class="fa-regular fa-star"></i></button>
              </div>
              <div class="star-hint" id="bonMyRatingHint">0/5</div>
            </div>
            <button class="btn btn-primary" onclick="window.addBonelle()"><i class="fas fa-plus"></i> Registrar</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-bar"></i> Este año</h2>
          </div>
          <div class="card-body">
            <div id="bonYearStats" style="color: var(--text-secondary); line-height: 1.7;">
              Cargando...
            </div>
          </div>
        </div>
      </div>

      <div class="card scroll-animation">
        <div class="card-header">
          <h2><i class="fas fa-clock-rotate-left"></i> Historial</h2>
        </div>
        <div class="card-body">
          <div class="bonelles-list" id="bonellesList">
            <p style="text-align:center; color: var(--text-tertiary); padding: 20px;">Cargando...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- AJUSTES TAB -->
    <div class="tab-content" id="tab-ajustes">
      <div class="card scroll-animation">
        <div class="card-header">
          <h2><i class="fas fa-bell"></i> Notificaciones</h2>
        </div>
        <div class="card-body">
          <p style="color: var(--text-secondary); margin-bottom: 16px;">
            Recibe notificaciones cuando llegue una carta o en el aniversario (día 5 de cada mes).
          </p>
          <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
            <button class="btn btn-secondary" onclick="window.enableNotifications()"><i class="fas fa-check-circle"></i> Activar (solo con la app abierta)</button>
            <button class="btn btn-primary" onclick="window.enablePushNotifications()"><i class="fas fa-bell"></i> Activar Push (en segundo plano)</button>
            <button class="btn btn-secondary" onclick="window.debugPushStatus()"><i class="fas fa-bug"></i> Diagnosticar Push</button>
            <button class="btn btn-secondary" onclick="window.testPushNow()"><i class="fas fa-paper-plane"></i> Probar Push ahora</button>
          </div>
          <p style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 12px;">
            <i class="fas fa-mobile-alt"></i> En iPhone necesitas <strong>Agregar a pantalla de inicio</strong> (PWA) para recibir push en segundo plano.
          </p>
        </div>
      </div>

      <div class="card scroll-animation" style="margin-top: 16px;">
        <div class="card-header">
          <h2><i class="fas fa-info-circle"></i> Acerca de</h2>
        </div>
        <div class="card-body">
          <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.8;">
            <strong>Diego Y Danna</strong> es una plataforma moderna para guardar y compartir momentos especiales. 
          </p>
          <p style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 16px;">
            <i class="fas fa-code"></i> v2.0.0 • <i class="fas fa-palette"></i> Diseño Premium • <i class="fas fa-music"></i> Notificaciones Push • <i class="fas fa-cloud"></i> Realtime Database<br>
            <i class="fas fa-heart"></i> Construido con amor para Diego Y Danna
          </p>
        </div>
      </div>
    </div>
  </main>

  <div class="toasts-container" id="toastsContainer"></div>

  <!-- MODAL FOTO (LIGHTBOX) -->
  <div class="letter-modal" id="photoModal">
    <div class="modal-content" style="max-width: 860px;">
      <div class="modal-header">
        <h2 id="photoModalTitle"><i class="fas fa-image"></i> Foto</h2>
        <div class="modal-actions">
          <button class="modal-action danger" id="deletePhotoBtn" onclick="window.deleteCurrentPhoto()" title="Eliminar" style="display:none;"><i class="fas fa-trash"></i></button>
          <button class="modal-close" onclick="window.closePhotoModal()" title="Cerrar"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="modal-body">
        <div style="border-radius: var(--radius-lg); overflow:hidden; border: 1px solid var(--text-light); background: var(--bg-light);">
          <img id="photoModalImg" src="" alt="" style="width:100%; height:auto; display:block; max-height:70vh; object-fit:contain; background: #0b0f1a;" />
        </div>
        <div style="margin-top: 14px; display:flex; gap: 12px; flex-wrap: wrap; align-items:center; justify-content: space-between;">
          <div style="min-width: 220px;">
            <div id="photoModalCaption" style="font-weight: 700; color: var(--text-primary); font-size: 1.05rem; line-height: 1.4;">—</div>
            <div style="color: var(--text-tertiary); font-size: 0.9rem; margin-top: 6px;" id="photoModalMeta">—</div>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="btn btn-secondary" id="photoModalOpenBtn" onclick="window.openPhotoModalInNewTab()"><i class="fas fa-up-right-from-square"></i> Abrir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CARTA DETALLADA -->
  <div class="letter-modal" id="letterModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Carta</h2>
        <div class="modal-actions">
          <button class="modal-action danger" id="deleteLetterBtn" onclick="window.deleteCurrentLetter()" title="Eliminar" style="display:none;"><i class="fas fa-trash"></i></button>
          <button class="modal-close" onclick="window.closeLetter()" title="Cerrar"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="modal-body">
        <!-- Reproductor de música -->
        <div id="musicContainer" style="display: none;">
          <div class="music-player">
            <button class="player-btn" id="playBtn" onclick="window.toggleMusic()"><i class="fas fa-play"></i></button>
            <div class="player-info">
              <div class="player-title" id="playerTitle"></div>
              <div class="player-artist" id="playerArtist"></div>
            </div>
            <div class="player-progress">
              <div class="player-progress-bar" id="playerProgress"></div>
            </div>
          </div>
          <div id="playerContainer" style="margin-top: 12px;"></div>
        </div>

        <!-- Carta -->
        <div class="modal-paper" id="modalPaper">
          <div class="modal-paper-content">
            <div class="modal-paper-title" id="modalPaperTitle">Título</div>
            <div class="modal-paper-text" id="modalPaperText">Contenido...</div>
          </div>
        </div>

        <!-- Metadatos -->
        <div class="modal-meta">
          <div class="meta-item">
            <span class="meta-label">De:</span>
            <span id="modalFrom">—</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Para:</span>
            <span id="modalTo">—</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Sentimiento:</span>
            <span id="modalMood">—</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Fecha:</span>
            <span id="modalDate">—</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ==================== FIREBASE ====================
    let db = null;
    let firebaseReady = false;
    let currentUser = null;
    let filterMode = "inbox";

    const firebaseConfig = {
      apiKey: "AIzaSyBrvRuG9f41HE2pQh4rMcBAwfnmV0ISe5g",
      authDomain: "diegoydanna-5b698.firebaseapp.com",
      projectId: "diegoydanna-5b698",
      storageBucket: "diegoydanna-5b698.firebasestorage.app",
      messagingSenderId: "1005227750022",
      appId: "1:1005227750022:web:befb98c09d481090501707"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      firebaseReady = true;
      console.log("Firebase listo");
    } catch (err) {
      console.error("Error Firebase:", err);
    }

    window.initApp = function(user) {
      try {
        console.log("initApp iniciando para:", user);
        
        if (!firebaseReady || !db) {
          window.showToast("Firebase no está listo", "error");
          console.error("Firebase no está listo");
          return;
        }

        currentUser = user;
        localStorage.setItem("currentUser", user);

        window.ensureSeenMarkers();
        window.syncExistingPushSubscription?.();

        document.body.className = user === "diego" ? "theme-diego" : "theme-danna";
        const badgeEl = document.getElementById("userBadge");
        if (badgeEl) badgeEl.innerHTML = `<i class="fas fa-user"></i> ${user.charAt(0).toUpperCase() + user.slice(1)}`;
        
        const loginScreen = document.getElementById("loginScreen");
        if (loginScreen) loginScreen.classList.add("hidden");
        
        const mainHeader = document.getElementById("mainHeader");
        if (mainHeader) mainHeader.style.display = "block";
        
        const mainContent = document.getElementById("mainContent");
        if (mainContent) mainContent.style.display = "block";

        console.log("Llamando updateUI...");
        window.updateUI();
        
        console.log("Cargando cartas...");
        window.loadLetters();
        
        console.log("Cargando fotos...");
        window.loadPhotos();

        console.log("Cargando Bonelles...");
        window.loadBonelles();

        window.loadDashboard();
        
        console.log("Configurando event listeners...");
        window.setupEventListeners();
        
        console.log("Configurando scroll animations...");
        window.setupScrollAnimations();

        console.log("Sesión iniciada para:", user);
      } catch(err) {
        console.error("Error en initApp:", err);
        window.showToast("Error al cargar: " + err.message, "error");
      }
    };

    // Si se tocó Diego/Danna antes de que cargara el JS completo, ejecutar ahora.
    try {
      if (window.__queuedLoginUser) {
        const queued = window.__queuedLoginUser;
        window.__queuedLoginUser = null;
        setTimeout(() => {
          try {
            window.initApp(queued);
          } catch (e) {
            console.error("Error ejecutando login en cola:", e);
          }
        }, 0);
      }
    } catch (e) {
      console.error("Error procesando login en cola:", e);
    }

    window.ensureSeenMarkers = function() {
      try {
        if (!currentUser) return;
        const photosKey = `ce_lastSeenPhotos_${currentUser}`;
        if (!localStorage.getItem(photosKey)) {
          localStorage.setItem(photosKey, String(Date.now()));
        }
      } catch (err) {
        console.error("Error en ensureSeenMarkers:", err);
      }
    };

    window.goToTab = function(tabName) {
      try {
        const btn = document.querySelector(`.tabs .tab-btn[data-tab="${tabName}"]`);
        if (btn) btn.click();
      } catch (err) {
        console.error("Error en goToTab:", err);
      }
    };

    window.setStarValue = function(containerId, value) {
      try {
        const el = document.getElementById(containerId);
        if (!el) return;
        const v = Math.max(0, Math.min(5, Number(value) || 0));
        el.dataset.value = String(v);
        el.querySelectorAll(".star-btn").forEach(btn => {
          const star = Number(btn.dataset.star || 0);
          const icon = btn.querySelector("i");
          const on = star <= v;
          btn.classList.toggle("is-on", on);
          if (icon) {
            icon.className = on ? "fa-solid fa-star" : "fa-regular fa-star";
          }
        });
        const hint = document.getElementById(`${containerId}Hint`);
        if (hint) hint.textContent = `${v}/5`;
      } catch (err) {
        console.error("Error en setStarValue:", err);
      }
    };

    window.loadDashboard = async function() {
      try {
        if (!currentUser || !firebaseReady || !db) return;

        // Días restantes para el día 5
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const next5 = today.getDate() <= 5
          ? new Date(today.getFullYear(), today.getMonth(), 5)
          : new Date(today.getFullYear(), today.getMonth() + 1, 5);
        const ms = next5.getTime() - today.getTime();
        const days = Math.max(0, Math.ceil(ms / (1000 * 60 * 60 * 24)));

        const daysEl = document.getElementById("dashDaysTo5");
        if (daysEl) daysEl.textContent = String(days);
        const nextEl = document.getElementById("dashNext5");
        if (nextEl) nextEl.textContent = next5.toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });

        window.startNext5Countdown(next5);

        window.startAnniversaryTimers();

        if (typeof window.initDateRoulette === "function") window.initDateRoulette();

        // Cartas: conteo global + por autor
        const lettersSnap = await db.collection("letters").limit(1000).get();
        let lettersDiego = 0;
        let lettersDanna = 0;
        let pendingLetters = 0;
        lettersSnap.forEach(doc => {
          const data = doc.data() || {};
          const a = (data.author || "").toLowerCase();
          if (a === "diego") lettersDiego++;
          else if (a === "danna") lettersDanna++;

          const to = (data.to || "").toLowerCase();
          const isRead = !!data.isRead;
          if (to === String(currentUser).toLowerCase() && !isRead) pendingLetters++;
        });
        const totalLettersEl = document.getElementById("dashTotalLetters");
        if (totalLettersEl) totalLettersEl.textContent = String(lettersSnap.size);
        const lettersDiegoEl = document.getElementById("dashLettersDiego");
        if (lettersDiegoEl) lettersDiegoEl.textContent = String(lettersDiego);
        const lettersDannaEl = document.getElementById("dashLettersDanna");
        if (lettersDannaEl) lettersDannaEl.textContent = String(lettersDanna);

        const pendingLettersEl = document.getElementById("pendingLetters");
        if (pendingLettersEl) pendingLettersEl.textContent = String(pendingLetters);

        // Fotos: conteo global + por autor
        const photosSnap = await db.collection("photos").limit(1000).get();
        let photosDiego = 0;
        let photosDanna = 0;
        let pendingPhotos = 0;

        const photosKey = `ce_lastSeenPhotos_${currentUser}`;
        const lastSeenPhotos = Number(localStorage.getItem(photosKey) || 0);
        const meLower = String(currentUser).toLowerCase();
        photosSnap.forEach(doc => {
          const data = doc.data() || {};
          const a = (data.author || "").toLowerCase();
          if (a === "diego") photosDiego++;
          else if (a === "danna") photosDanna++;

          const created = data.createdAt?.toDate?.();
          const createdMs = created ? created.getTime() : 0;
          // Pendiente = foto nueva de la otra persona (no la tuya)
          if (createdMs && createdMs > lastSeenPhotos && a && a !== meLower) pendingPhotos++;
        });
        const totalPhotosEl = document.getElementById("dashTotalPhotos");
        if (totalPhotosEl) totalPhotosEl.textContent = String(photosSnap.size);
        const photosDiegoEl = document.getElementById("dashPhotosDiego");
        if (photosDiegoEl) photosDiegoEl.textContent = String(photosDiego);
        const photosDannaEl = document.getElementById("dashPhotosDanna");
        if (photosDannaEl) photosDannaEl.textContent = String(photosDanna);

        const pendingPhotosEl = document.getElementById("pendingPhotos");
        if (pendingPhotosEl) pendingPhotosEl.textContent = String(pendingPhotos);

        // Bonelles: pendientes por calificar (solo los creados por la otra persona)
        let pendingBonelles = 0;
        try {
          const me = String(currentUser).toLowerCase();
          const bonSnap = await db.collection("bonelles").limit(1000).get();
          pendingBonelles = 0;
          bonSnap.forEach(doc => {
            const data = doc.data() || {};
            const author = String(data.author || "").toLowerCase();
            if (!author || author === me) return;
            const ratings = data.ratings || {};
            const myRating = ratings[me];
            if (myRating === null || myRating === undefined || Number(myRating) === 0) pendingBonelles++;
          });
          const pendingBonellesEl = document.getElementById("pendingBonelles");
          if (pendingBonellesEl) pendingBonellesEl.textContent = String(pendingBonelles);
        } catch (e) {
          console.error("Error en pendientes Bonelles:", e);
        }

        window.updatePendingBadge(pendingLetters, pendingPhotos, pendingBonelles);

        // Bonelles: estadísticas por comida (año actual)
        window.loadBonellesYearStats();
      } catch (err) {
        console.error("Error en loadDashboard:", err);
      }
    };

    // ==================== PENDIENTES ICON + PANEL ====================
    window.getPendingDigestFromDom = function() {
      const letters = Number(document.getElementById("pendingLetters")?.textContent || 0);
      const photos = Number(document.getElementById("pendingPhotos")?.textContent || 0);
      const bonelles = Number(document.getElementById("pendingBonelles")?.textContent || 0);
      return `${letters}|${photos}|${bonelles}`;
    };

    window.getPendingSeenKey = function() {
      const u = String(currentUser || "").toLowerCase() || "anon";
      return `ce_pendingSeenDigest_${u}`;
    };

    window.updatePendingBadge = function(pendingLetters, pendingPhotos, pendingBonelles) {
      try {
        const btnA = document.getElementById("pendingIconBtn");
        const badgeA = document.getElementById("pendingTotalBadge");
        const iconImgA = document.getElementById("pendingIconImg");

        const btnB = document.getElementById("pendingIconBtnHeader");
        const badgeB = document.getElementById("pendingTotalBadgeHeader");
        const iconImgB = document.getElementById("pendingIconImgHeader");

        if (!btnA || !badgeA) return;

        const total = Math.max(0, Number(pendingLetters) || 0) + Math.max(0, Number(pendingPhotos) || 0) + Math.max(0, Number(pendingBonelles) || 0);
        badgeA.textContent = String(total);
        if (badgeB) badgeB.textContent = String(total);

        const active = total > 0;
        badgeA.style.display = active ? "inline-flex" : "none";
        btnA.classList.toggle("has-pending", active);

        if (badgeB) badgeB.style.display = active ? "inline-flex" : "none";
        if (btnB) btnB.classList.toggle("has-pending", active);

        if (iconImgA) iconImgA.src = active ? "activa.png" : "inactiva.png";
        if (iconImgB) iconImgB.src = active ? "activa.png" : "inactiva.png";
      } catch (err) {
        console.error("Error en updatePendingBadge:", err);
      }
    };

    window.markPendingsAsSeen = function() {
      try {
        const digest = window.getPendingDigestFromDom();
        localStorage.setItem(window.getPendingSeenKey(), digest);

        const parts = digest.split("|").map(n => Number(n) || 0);
        window.updatePendingBadge(parts[0], parts[1], parts[2]);
      } catch (err) {
        console.error("Error en markPendingsAsSeen:", err);
      }
    };

    window.getPendingFloatingPosKey = function() {
      const u = String(currentUser || "").toLowerCase() || "anon";
      return `ce_pendingFloatingPos_${u}`;
    };

    window.clampPendingFloatingToViewport = function() {
      try {
        const btn = document.getElementById("pendingIconBtn");
        if (!btn) return;

        // Solo clamp si está usando left/top (posición guardada)
        const hasLeftTop = btn.style.left && btn.style.top && btn.style.right === "auto" && btn.style.bottom === "auto";
        if (!hasLeftTop) return;

        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

        const btnW = btn.offsetWidth || btn.getBoundingClientRect().width || 0;
        const btnH = btn.offsetHeight || btn.getBoundingClientRect().height || 0;
        if (!btnW || !btnH) return;

        const maxLeft = Math.max(0, window.innerWidth - btnW);
        const maxTop = Math.max(0, window.innerHeight - btnH);

        const left = Number(String(btn.style.left).replace("px", ""));
        const top = Number(String(btn.style.top).replace("px", ""));
        if (!Number.isFinite(left) || !Number.isFinite(top)) return;

        const clampedLeft = clamp(left, 0, maxLeft);
        const clampedTop = clamp(top, 0, maxTop);

        btn.style.left = `${clampedLeft}px`;
        btn.style.top = `${clampedTop}px`;

        try {
          localStorage.setItem(window.getPendingFloatingPosKey(), JSON.stringify({ left: clampedLeft, top: clampedTop }));
        } catch (_) {}
      } catch (err) {
        console.error("Error en clampPendingFloatingToViewport:", err);
      }
    };

    window.restorePendingFloatingPosition = function() {
      try {
        const btn = document.getElementById("pendingIconBtn");
        if (!btn) return;

        const raw = localStorage.getItem(window.getPendingFloatingPosKey());
        if (!raw) return;

        const pos = JSON.parse(raw);
        const left = Number(pos?.left);
        const top = Number(pos?.top);
        if (!Number.isFinite(left) || !Number.isFinite(top)) return;

        // Aplica como top/left para permitir arrastre libre.
        btn.style.left = `${left}px`;
        btn.style.top = `${top}px`;
        btn.style.right = "auto";
        btn.style.bottom = "auto";

        // Si quedó fuera de pantalla (muy común al cambiar de celular/orientación), lo traemos de vuelta.
        window.clampPendingFloatingToViewport();
      } catch (err) {
        console.error("Error en restorePendingFloatingPosition:", err);
      }
    };

    window.positionPendingPanelNearButton = function() {
      try {
        const panel = document.getElementById("pendingPanel");
        const btn = document.getElementById("pendingIconBtn");
        if (!panel || !btn) return;
        // En Inicio es inline; no posicionar como flotante.
        if (panel.closest?.('.pending-section') || btn.closest?.('.pending-section')) return;
        if (!panel.classList.contains("active")) return;

        const margin = 12;
        const gap = 10;
        const b = btn.getBoundingClientRect();
        const pr = panel.getBoundingClientRect();

        // Alinea el panel con el borde derecho del botón (más natural en esquina).
        let left = b.right - pr.width;
        left = Math.max(margin, Math.min(left, window.innerWidth - pr.width - margin));

        // Preferimos arriba del botón; si no cabe, lo ponemos abajo.
        let top = b.top - pr.height - gap;
        if (top < margin) top = b.bottom + gap;
        top = Math.max(margin, Math.min(top, window.innerHeight - pr.height - margin));

        panel.style.left = `${left}px`;
        panel.style.top = `${top}px`;
        panel.style.right = "auto";
        panel.style.bottom = "auto";
      } catch (err) {
        console.error("Error en positionPendingPanelNearButton:", err);
      }
    };

    window.updatePendingFloatingVisibility = function() {
      try {
        const floating = document.getElementById("pendingFloating");
        if (!floating) return;

        // Solo visible con sesión
        if (!currentUser) {
          floating.style.display = "none";
          window.togglePendingPanel?.(false);
          return;
        }

        const activeTabBtn = document.querySelector('.tabs .tab-btn.active');
        const tab = String(activeTabBtn?.dataset?.tab || "inicio");
        const shouldShow = tab === "inicio";

        floating.style.display = shouldShow ? "block" : "none";
        if (!shouldShow) window.togglePendingPanel?.(false);
      } catch (err) {
        console.error("Error en updatePendingFloatingVisibility:", err);
      }
    };

    // ==================== PORTADA: ABRIR / AMPLIAR ====================
    window.openCoverLightbox = function(src, alt) {
      try {
        const lightbox = document.getElementById("coverLightbox");
        const img = document.getElementById("coverLightboxImg");
        const stage = document.getElementById("coverLightboxStage");
        if (!lightbox || !img || !stage) return;
        if (!src) return;

        stage.classList.remove("is-zoomed");
        img.src = src;
        img.alt = alt || "Portada";

        lightbox.classList.add("active");
        lightbox.setAttribute("aria-hidden", "false");

        if (window.__prevBodyOverflow == null) {
          window.__prevBodyOverflow = document.body.style.overflow;
        }
        document.body.style.overflow = "hidden";
      } catch (err) {
        console.error("Error en openCoverLightbox:", err);
      }
    };

    window.closeCoverLightbox = function() {
      try {
        const lightbox = document.getElementById("coverLightbox");
        const img = document.getElementById("coverLightboxImg");
        const stage = document.getElementById("coverLightboxStage");
        if (!lightbox) return;

        lightbox.classList.remove("active");
        lightbox.setAttribute("aria-hidden", "true");
        if (stage) stage.classList.remove("is-zoomed");
        if (img) img.src = "";

        if (window.__prevBodyOverflow != null) {
          document.body.style.overflow = window.__prevBodyOverflow;
          window.__prevBodyOverflow = null;
        } else {
          document.body.style.overflow = "";
        }
      } catch (err) {
        console.error("Error en closeCoverLightbox:", err);
      }
    };

    window.togglePendingPanel = function(force) {
      try {
        const panel = document.getElementById("pendingPanel");
        const btnA = document.getElementById("pendingIconBtn");
        const btnB = document.getElementById("pendingIconBtnHeader");
        if (!panel || !btnA) return;

        const openNow = panel.classList.contains("active");
        const next = typeof force === "boolean" ? force : !openNow;

        panel.classList.toggle("active", next);
        panel.setAttribute("aria-hidden", next ? "false" : "true");
        btnA.setAttribute("aria-expanded", next ? "true" : "false");
        if (btnB) btnB.setAttribute("aria-expanded", next ? "true" : "false");

        if (next) {
          // "Revisar" = abrir la mini-pestaña
          window.markPendingsAsSeen();

          // Posiciona el panel cerca del botón (en caso de haberlo movido)
          requestAnimationFrame(() => window.positionPendingPanelNearButton());
        }
      } catch (err) {
        console.error("Error en togglePendingPanel:", err);
      }
    };

    window.enablePendingFloatingDrag = function() {
      try {
        if (window.__pendingDragEnabled) return;
        const btn = document.getElementById("pendingIconBtn");
        if (!btn) return;
        // Si el botón está dentro de la sección de Inicio (inline), no habilitar drag.
        if (btn.closest?.('.pending-section')) return;

        window.__pendingDragEnabled = true;
        window.__pendingDragJustHappened = false;

        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

        let pointerId = null;
        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;
        let btnW = 0;
        let btnH = 0;
        let dragging = false;

        // Base (sin transform) desde donde se aplica translate3d mientras se arrastra
        let baseLeft = 0;
        let baseTop = 0;

        // RAF throttle: evita jank en móvil al no escribir estilos en cada pointermove
        let rafId = 0;
        let targetLeft = 0;
        let targetTop = 0;

        const getRect = () => btn.getBoundingClientRect();

        const applyPosition = () => {
          rafId = 0;
          // Durante el arrastre, solo movemos con transform (más fluido en móvil)
          const dx = targetLeft - baseLeft;
          const dy = targetTop - baseTop;
          btn.style.transform = `translate3d(${dx}px, ${dy}px, 0)`;
        };

        const scheduleApply = () => {
          if (rafId) return;
          rafId = requestAnimationFrame(applyPosition);
        };

        const startDrag = (e) => {
          // Solo clic principal en mouse
          if (e.pointerType === "mouse" && e.button !== 0) return;
          try { e.preventDefault(); } catch (_) {}
          pointerId = e.pointerId;
          btn.setPointerCapture(pointerId);

          const r = getRect();
          startX = e.clientX;
          startY = e.clientY;
          startLeft = r.left;
          startTop = r.top;
          btnW = r.width;
          btnH = r.height;
          targetLeft = startLeft;
          targetTop = startTop;

          // Fijar base (left/top) para que el transform sea relativo a ella
          baseLeft = startLeft;
          baseTop = startTop;
          btn.style.left = `${baseLeft}px`;
          btn.style.top = `${baseTop}px`;
          btn.style.right = "auto";
          btn.style.bottom = "auto";
          btn.style.transform = "translate3d(0px, 0px, 0)";

          dragging = false;
        };

        const moveDrag = (e) => {
          if (pointerId == null || e.pointerId !== pointerId) return;
          try { e.preventDefault(); } catch (_) {}

          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          const dist = Math.hypot(dx, dy);

          if (!dragging) {
            if (dist < 8) return;
            dragging = true;
            window.__pendingDragJustHappened = true;
            btn.classList.add("is-dragging");
            // Si el panel está abierto, lo cerramos mientras arrastra
            window.togglePendingPanel(false);

            // Evita que transiciones ralenticen el movimiento
            btn.style.transition = "none";
          }

          // Libre por toda la pantalla: permitir bordes 0..max
          const maxLeft = Math.max(0, window.innerWidth - btnW);
          const maxTop = Math.max(0, window.innerHeight - btnH);

          targetLeft = clamp(startLeft + dx, 0, maxLeft);
          targetTop = clamp(startTop + dy, 0, maxTop);
          scheduleApply();
        };

        const endDrag = (e) => {
          if (pointerId == null || e.pointerId !== pointerId) return;
          try {
            btn.releasePointerCapture(pointerId);
          } catch (_) {}

          if (dragging) {
            if (rafId) {
              cancelAnimationFrame(rafId);
              applyPosition();
            }

            // Commit final: convierte el transform en left/top y limpia transform
            btn.style.left = `${targetLeft}px`;
            btn.style.top = `${targetTop}px`;
            btn.style.transform = "";

            const r = getRect();
            try {
              localStorage.setItem(window.getPendingFloatingPosKey(), JSON.stringify({ left: r.left, top: r.top }));
            } catch (_) {}

            setTimeout(() => {
              window.__pendingDragJustHappened = false;
            }, 250);
          } else {
            // No fue drag: permite el click normal
            setTimeout(() => {
              window.__pendingDragJustHappened = false;
            }, 0);
          }

          dragging = false;
          pointerId = null;
          btn.classList.remove("is-dragging");

          // Restaura transición
          btn.style.transition = "";
        };

        // Listeners no-passive para que preventDefault funcione bien en móvil
        btn.addEventListener("pointerdown", startDrag, { passive: false });
        btn.addEventListener("pointermove", moveDrag, { passive: false });
        btn.addEventListener("pointerup", endDrag, { passive: true });
        btn.addEventListener("pointercancel", endDrag, { passive: true });

        window.addEventListener("resize", () => {
          // Si está abierto, re-posiciona el panel.
          window.positionPendingPanelNearButton();
          window.clampPendingFloatingToViewport?.();
        });
      } catch (err) {
        console.error("Error en enablePendingFloatingDrag:", err);
      }
    };

    // Sonido "miau" al presionar el icono
    window.playKittenMeow = function() {
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;

        if (!window.__meowCtx) window.__meowCtx = new AudioCtx();
        const ctx = window.__meowCtx;

        // Si el contexto está suspendido (móvil), reanudar con gesto del usuario
        if (ctx.state === "suspended") {
          ctx.resume().catch(() => {});
        }

        const now = ctx.currentTime;
        const duration = 0.62;

        // Cadena: fuentes -> formantes -> compresor -> salida
        const out = ctx.createGain();
        out.gain.setValueAtTime(0.0001, now);
        out.gain.exponentialRampToValueAtTime(0.28, now + 0.03);
        out.gain.exponentialRampToValueAtTime(0.0001, now + duration);

        const compressor = ctx.createDynamicsCompressor();
        compressor.threshold.setValueAtTime(-22, now);
        compressor.knee.setValueAtTime(18, now);
        compressor.ratio.setValueAtTime(6, now);
        compressor.attack.setValueAtTime(0.008, now);
        compressor.release.setValueAtTime(0.14, now);

        // "Voz" principal: mezcla de triángulo + diente
        const osc1 = ctx.createOscillator();
        osc1.type = "triangle";
        const osc2 = ctx.createOscillator();
        osc2.type = "sawtooth";

        const v1 = ctx.createGain();
        v1.gain.setValueAtTime(0.65, now);
        const v2 = ctx.createGain();
        v2.gain.setValueAtTime(0.25, now);

        // Contorno de tono más "miau" (ataque corto + caída larga)
        // Arranca alto, baja un poco rápido, y cae hacia el final.
        const fStart = 820;
        const fMid = 620;
        const fEnd = 240;
        osc1.frequency.setValueAtTime(fStart, now);
        osc2.frequency.setValueAtTime(fStart * 1.01, now);
        osc1.frequency.exponentialRampToValueAtTime(fMid, now + 0.12);
        osc2.frequency.exponentialRampToValueAtTime(fMid * 1.01, now + 0.12);
        osc1.frequency.exponentialRampToValueAtTime(fEnd, now + duration);
        osc2.frequency.exponentialRampToValueAtTime(fEnd * 1.01, now + duration);

        // Vibrato irregular leve (más natural)
        const lfo = ctx.createOscillator();
        lfo.type = "sine";
        lfo.frequency.setValueAtTime(7.5, now);
        const lfoGain = ctx.createGain();
        lfoGain.gain.setValueAtTime(14, now);
        lfo.connect(lfoGain);
        lfoGain.connect(osc1.frequency);
        lfoGain.connect(osc2.frequency);

        // Formantes (bandpass) para dar "boca" al sonido
        const form1 = ctx.createBiquadFilter();
        form1.type = "bandpass";
        form1.Q.setValueAtTime(7.5, now);
        form1.frequency.setValueAtTime(980, now);
        form1.frequency.exponentialRampToValueAtTime(720, now + duration);

        const form2 = ctx.createBiquadFilter();
        form2.type = "bandpass";
        form2.Q.setValueAtTime(9.0, now);
        form2.frequency.setValueAtTime(1650, now);
        form2.frequency.exponentialRampToValueAtTime(1350, now + duration);

        const tilt = ctx.createBiquadFilter();
        tilt.type = "lowpass";
        tilt.frequency.setValueAtTime(2400, now);
        tilt.frequency.exponentialRampToValueAtTime(1600, now + duration);

        // Un poquito de aire/ruido con filtro, para el "ma" inicial
        const noiseBuffer = ctx.createBuffer(1, Math.floor(ctx.sampleRate * duration), ctx.sampleRate);
        const data = noiseBuffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) {
          // ruido suavizado
          data[i] = (Math.random() * 2 - 1) * 0.25;
        }
        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuffer;

        const noiseHP = ctx.createBiquadFilter();
        noiseHP.type = "highpass";
        noiseHP.frequency.setValueAtTime(500, now);

        const noiseBP = ctx.createBiquadFilter();
        noiseBP.type = "bandpass";
        noiseBP.frequency.setValueAtTime(1400, now);
        noiseBP.Q.setValueAtTime(1.1, now);

        const noiseGain = ctx.createGain();
        noiseGain.gain.setValueAtTime(0.0001, now);
        noiseGain.gain.exponentialRampToValueAtTime(0.08, now + 0.02);
        noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);

        // Conexiones
        osc1.connect(v1);
        osc2.connect(v2);

        const voiceMix = ctx.createGain();
        voiceMix.gain.setValueAtTime(1, now);
        v1.connect(voiceMix);
        v2.connect(voiceMix);

        voiceMix.connect(form1);
        form1.connect(form2);
        form2.connect(tilt);
        tilt.connect(compressor);
        compressor.connect(out);
        out.connect(ctx.destination);

        noise.connect(noiseHP);
        noiseHP.connect(noiseBP);
        noiseBP.connect(noiseGain);
        noiseGain.connect(compressor);

        osc1.start(now);
        osc2.start(now);
        lfo.start(now);
        noise.start(now);

        osc1.stop(now + duration);
        osc2.stop(now + duration);
        lfo.stop(now + duration);
        noise.stop(now + duration);
      } catch (err) {
        console.error("Error en playKittenMeow:", err);
      }
    };

    window.onPendingIconClick = function(e) {
      // Si el usuario acaba de arrastrar, ignorar el click.
      if (window.__pendingDragJustHappened) return;
      try {
        window.playKittenMeow();
      } catch (_) {}
      window.togglePendingPanel();
    };

    document.addEventListener("click", (e) => {
      const panel = document.getElementById("pendingPanel");
      const btn = document.getElementById("pendingIconBtn");
      const btnHeader = document.getElementById("pendingIconBtnHeader");
      if (!panel || !btn) return;
      if (!panel.classList.contains("active")) return;
      const t = e.target;
      if (panel.contains(t) || btn.contains(t) || (btnHeader && btnHeader.contains(t))) return;
      window.togglePendingPanel(false);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      const panel = document.getElementById("pendingPanel");
      if (!panel || !panel.classList.contains("active")) return;
      window.togglePendingPanel(false);
    });

    window.loadBonellesYearStats = async function() {
      try {
        if (!currentUser || !firebaseReady || !db) return;

        const now = new Date();
        const year = now.getFullYear();
        const start = new Date(year, 0, 1);
        const end = new Date(year + 1, 0, 1);

        // Evitar índices compuestos: traer un lote reciente y filtrar por año
        const snap = await db.collection("bonelles").orderBy("date", "desc").limit(1000).get();
        const counts = {};
        const weekdayCounts = {}; // { food: { weekday: n } }
        snap.forEach(doc => {
          const data = doc.data() || {};
          const d = data.date?.toDate?.();
          if (!d) return;
          if (d < start || d >= end) return;
          const food = String(data.food || "").trim();
          if (!food) return;
          counts[food] = (counts[food] || 0) + 1;

          const wd = String(data.weekday || d.toLocaleDateString("es-ES", { weekday: "long" }) || "").trim();
          if (!weekdayCounts[food]) weekdayCounts[food] = {};
          if (wd) weekdayCounts[food][wd] = (weekdayCounts[food][wd] || 0) + 1;
        });

        const getTopWeekday = (food) => {
          const map = weekdayCounts[food] || {};
          const days = Object.keys(map);
          if (days.length === 0) return "";
          days.sort((a, b) => (map[b] || 0) - (map[a] || 0));
          return days[0];
        };

        const render = (targetId) => {
          const el = document.getElementById(targetId);
          if (!el) return;
          const foods = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
          if (foods.length === 0) {
            el.innerHTML = `<div style="color: var(--text-tertiary);">Aún no hay registros este año.</div>`;
            return;
          }
          const topFood = foods[0];
          const topWday = getTopWeekday(topFood);
          const header = `<div style="padding: 10px 12px; border: 1px solid var(--text-light); border-radius: var(--radius-md); background: var(--bg-light); margin-bottom: 12px;">
              <div style="font-weight:900; color: var(--text-primary);">Top del año: ${window.escapeHtml(topFood)} (${counts[topFood]} veces)</div>
              <div style="color: var(--text-secondary); margin-top: 4px;">Día más repetido: <strong>${window.escapeHtml(topWday || "—")}</strong></div>
            </div>`;

          const rows = foods
            .slice(0, 12)
            .map(f => {
              const wd = getTopWeekday(f) || "—";
              return `<div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid var(--text-light);">
                  <div style="display:flex; flex-direction:column; gap:2px;">
                    <div style="font-weight:800; color: var(--text-primary);">${window.escapeHtml(f)}</div>
                    <div style="color: var(--text-tertiary); font-size: 0.9rem;"><i class="fas fa-calendar-week"></i> más: ${window.escapeHtml(wd)}</div>
                  </div>
                  <div style="font-weight:900;">${counts[f]}</div>
                </div>`;
            })
            .join("");

          el.innerHTML = header + rows;
        };

        render("bonYearStats");
        render("dashBonellesYear");
      } catch (err) {
        console.error("Error en loadBonellesYearStats:", err);
      }
    };

    window.escapeHtml = function(str) {
      return String(str ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    window.addBonelle = async function() {
      try {
        if (!currentUser || !firebaseReady || !db) {
          window.showToast("Debes iniciar sesión", "error");
          return;
        }

        const food = document.getElementById("bonFood")?.value?.trim();
        const dateStr = document.getElementById("bonDate")?.value;
        const restaurant = document.getElementById("bonRestaurant")?.value?.trim();
        const where = document.getElementById("bonWhere")?.value || "lugar";
        const ratingContainer = document.getElementById("bonMyRating");
        const myRating = Math.max(0, Math.min(5, Number(ratingContainer?.dataset?.value || 0)));

        if (!food || !dateStr) {
          window.showToast("Completa comida y día", "error");
          return;
        }

        const dateObj = new Date(`${dateStr}T00:00:00`);
        if (!dateObj || Number.isNaN(dateObj.getTime())) {
          window.showToast("Fecha inválida", "error");
          return;
        }
        const weekday = dateObj.toLocaleDateString("es-ES", { weekday: "long" });

        const ratings = { diego: null, danna: null };
        if (String(currentUser).toLowerCase() === "diego") ratings.diego = myRating || null;
        if (String(currentUser).toLowerCase() === "danna") ratings.danna = myRating || null;

        await db.collection("bonelles").add({
          food,
          date: firebase.firestore.Timestamp.fromDate(dateObj),
          weekday,
          restaurant: restaurant || "",
          where,
          ratings,
          author: currentUser,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        window.showToast("Bonelle registrado", "success");
        const foodEl = document.getElementById("bonFood");
        const dateEl = document.getElementById("bonDate");
        const restEl = document.getElementById("bonRestaurant");
        if (foodEl) foodEl.value = "";
        if (dateEl) dateEl.value = "";
        if (restEl) restEl.value = "";
        window.setStarValue("bonMyRating", 0);

        window.loadBonelles();
        window.loadBonellesYearStats();
      } catch (err) {
        const msg = String(err?.message || err || "");
        const code = String(err?.code || "");
        if (code === "permission-denied" || /permission\-denied/i.test(msg) || /Missing or insufficient permissions/i.test(msg)) {
          window.showToast("Firestore bloqueó Bonelles. Activa permisos para la colección 'bonelles' en Rules.", "error");
        } else {
          window.showToast("Error: " + msg, "error");
        }
      }
    };

    window.loadBonelles = async function() {
      try {
        if (!currentUser || !firebaseReady || !db) return;
        const list = document.getElementById("bonellesList");
        if (list) list.innerHTML = '<p style="text-align:center; color: var(--text-tertiary); padding: 20px;">Cargando...</p>';

        const snap = await db.collection("bonelles").orderBy("date", "desc").limit(200).get();
        if (!list) return;

        if (snap.empty) {
          list.innerHTML = '<p style="text-align:center; color: var(--text-tertiary); padding: 20px;">Aún no hay registros. ¡Agrega el primero!</p>';
          return;
        }

        const me = String(currentUser).toLowerCase();
        window._bonellesCache = {};
        window.bindBonellesListInteractions?.();
        const items = [];
        snap.forEach(doc => {
          const data = doc.data() || {};
          data.__id = doc.id;
          items.push(data);
          window._bonellesCache[String(doc.id)] = data;
        });

        list.innerHTML = items.map(item => {
          const d = item.date?.toDate?.();
          const dateText = d ? d.toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" }) : "—";
          const weekday = item.weekday ? String(item.weekday) : (d ? d.toLocaleDateString("es-ES", { weekday: "long" }) : "—");
          const whereText = item.where === "casa" ? "En su casa" : "En el lugar";
          const rest = item.restaurant ? window.escapeHtml(item.restaurant) : "";
          const food = window.escapeHtml(item.food || "");
          const idRaw = String(item.__id || "");
          const idJs = JSON.stringify(idRaw);

          const ratings = item.ratings || {};
          const diegoRating = Number(ratings.diego || 0);
          const dannaRating = Number(ratings.danna || 0);
          const myValue = me === "diego" ? diegoRating : dannaRating;
          const author = String(item.author || "").toLowerCase();
          const showPending = author && author !== me && (!myValue || myValue === 0);

          const renderStars = (who, value, canEdit) => {
            const stars = [1,2,3,4,5].map(n => {
              const on = n <= value;
              const cls = on ? "is-on" : "";
              const icon = on ? "fa-solid fa-star" : "fa-regular fa-star";
              const bonAttr = `data-bon-id=\"${window.escapeHtml(idRaw)}\" data-who=\"${window.escapeHtml(String(who))}\" data-rating=\"${n}\"`;
              const disabled = canEdit ? "" : "disabled";
              return `<button type=\"button\" class=\"${cls}\" ${bonAttr} ${disabled} aria-label=\"${who} ${n}\"><i class=\"${icon}\"></i></button>`;
            }).join("");
            return `<div class=\"bon-rating\"><span style=\"min-width:70px;\">${who === "diego" ? "Diego" : "Danna"}</span><span class=\"stars\">${stars}</span></div>`;
          };

          const canEditDiego = me === "diego";
          const canEditDanna = me === "danna";

          return `
            <div class="bon-item">
              <div class="bon-top">
                <div>
                  <div class="bon-title"><i class="fas fa-utensils"></i> ${food}</div>
                  <div class="bon-meta">
                    <span><i class="fas fa-calendar"></i> ${window.escapeHtml(dateText)}</span>
                    <span><i class="fas fa-calendar-week"></i> ${window.escapeHtml(weekday)}</span>
                  </div>
                </div>
                <div class="bon-actions">
                  <button type="button" class="bon-edit-btn" data-bon-id="${window.escapeHtml(idRaw)}"><i class="fas fa-pen"></i> Editar</button>
                  <button type="button" class="bon-delete-btn" data-bon-id="${window.escapeHtml(idRaw)}"><i class="fas fa-trash"></i> Eliminar</button>
                  <div class="bon-meta" style="justify-content:flex-end;">
                    ${showPending ? `<span class="bon-chip"><i class="fas fa-star"></i> Pendiente tu calificación</span>` : ""}
                  <span class="bon-chip"><i class="fas fa-location-dot"></i> ${whereText}</span>
                  ${rest ? `<span class="bon-chip"><i class="fas fa-store"></i> ${rest}</span>` : ""}
                  </div>
                </div>
              </div>
              <div class="bon-row">
                ${renderStars("diego", diegoRating, canEditDiego)}
                ${renderStars("danna", dannaRating, canEditDanna)}
              </div>
            </div>
          `;
        }).join("");

        window.loadBonellesYearStats();
      } catch (err) {
        console.error("Error en loadBonelles:", err);
        const list = document.getElementById("bonellesList");
        if (list) list.innerHTML = '<p style="text-align:center; color: var(--text-tertiary); padding: 20px;">Error cargando registros.</p>';
      }
    };

    window.bindBonellesListInteractions = function() {
      try {
        if (window.__bonellesListBound) return;
        const list = document.getElementById("bonellesList");
        if (!list) return;

        window.__bonellesListBound = true;

        const handle = (e) => {
          const target = e.target;
          if (!target) return;

          const btn = target.closest?.("button");
          if (!btn) return;

          if (btn.disabled) return;

          // Edit/Delete
          if (btn.classList.contains("bon-edit-btn")) {
            const id = btn.getAttribute("data-bon-id");
            if (!id) return;
            e.preventDefault();
            e.stopPropagation();
            window.editBonelle?.(id);
            return;
          }

          if (btn.classList.contains("bon-delete-btn")) {
            const id = btn.getAttribute("data-bon-id");
            if (!id) return;
            e.preventDefault();
            e.stopPropagation();
            window.deleteBonelle?.(id);
            return;
          }

          // Stars (rating)
          if (btn.closest?.(".bon-rating") && btn.closest?.(".stars")) {
            const id = btn.getAttribute("data-bon-id");
            const who = btn.getAttribute("data-who");
            const rating = Number(btn.getAttribute("data-rating") || 0);
            if (!id || !who || !rating) return;
            e.preventDefault();
            e.stopPropagation();
            window.rateBonelle?.(id, who, rating);
          }
        };

        // pointerup suele ser más confiable en móvil/PWA; click queda como fallback.
        list.addEventListener("pointerup", handle, { passive: false });
        list.addEventListener("click", handle, { passive: false });
      } catch (err) {
        console.error("Error en bindBonellesListInteractions:", err);
      }
    };

    window.rateBonelle = async function(bonelleId, who, rating) {
      try {
        if (!currentUser || !firebaseReady || !db) return;
        const me = String(currentUser).toLowerCase();
        if (String(who).toLowerCase() !== me) return;
        const r = Math.max(1, Math.min(5, Number(rating) || 1));
        await db.collection("bonelles").doc(String(bonelleId)).update({ [`ratings.${me}`]: r });
        window.loadBonelles();
      } catch (err) {
        window.showToast("Error: " + err.message, "error");
      }
    };

    window.deleteBonelle = async function(bonelleId) {
      try {
        if (!currentUser || !firebaseReady || !db) {
          window.showToast("Debes iniciar sesión", "error");
          return;
        }
        const id = String(bonelleId || "");
        if (!id) return;
        const ok = window.confirm("¿Eliminar este registro de Bonelles? Esta acción no se puede deshacer.");
        if (!ok) return;

        await db.collection("bonelles").doc(id).delete();
        window.showToast("Registro eliminado", "success");
        window.loadBonelles();
        window.loadBonellesYearStats();
        window.loadDashboard();
      } catch (err) {
        window.showToast("Error: " + err.message, "error");
      }
    };

    window.editBonelle = async function(bonelleId) {
      try {
        if (!currentUser || !firebaseReady || !db) {
          window.showToast("Debes iniciar sesión", "error");
          return;
        }
        const id = String(bonelleId || "");
        if (!id) return;

        const current = window._bonellesCache?.[id] || null;
        const curFood = String(current?.food || "");
        const curRestaurant = String(current?.restaurant || "");
        const curWhere = String(current?.where || "lugar");
        const curDate = current?.date?.toDate?.();
        const curDateStr = curDate
          ? `${curDate.getFullYear()}-${String(curDate.getMonth() + 1).padStart(2, "0")}-${String(curDate.getDate()).padStart(2, "0")}`
          : "";

        const food = window.prompt("Comida:", curFood);
        if (food === null) return;
        if (!String(food).trim()) {
          window.showToast("Comida inválida", "error");
          return;
        }

        const dateStr = window.prompt("Fecha (YYYY-MM-DD):", curDateStr);
        if (dateStr === null) return;
        const dateObj = new Date(`${String(dateStr).trim()}T00:00:00`);
        if (!String(dateStr).trim() || Number.isNaN(dateObj.getTime())) {
          window.showToast("Fecha inválida", "error");
          return;
        }

        const restaurant = window.prompt("Restaurante:", curRestaurant);
        if (restaurant === null) return;

        const whereRaw = window.prompt("Dónde (casa o lugar):", curWhere);
        if (whereRaw === null) return;
        const whereNorm = String(whereRaw).toLowerCase().trim() === "casa" ? "casa" : "lugar";

        const weekday = dateObj.toLocaleDateString("es-ES", { weekday: "long" });

        await db.collection("bonelles").doc(id).update({
          food: String(food).trim(),
          date: firebase.firestore.Timestamp.fromDate(dateObj),
          weekday,
          restaurant: String(restaurant || "").trim(),
          where: whereNorm
        });

        window.showToast("Registro actualizado", "success");
        window.loadBonelles();
        window.loadBonellesYearStats();
        window.loadDashboard();
      } catch (err) {
        window.showToast("Error: " + String(err?.message || err), "error");
      }
    };

    window._next5CountdownTimer = null;
    window._anniversaryTimer = null;

    window.startNext5Countdown = function(next5Date) {
      try {
        const daysEl = document.getElementById("dashDaysTo5");
        const hoursEl = document.getElementById("dashHoursTo5");
        const minutesEl = document.getElementById("dashMinutesTo5");
        const secondsEl = document.getElementById("dashSecondsTo5");
        const labelEl = document.getElementById("dashCountdownLabel");
        if (!(next5Date instanceof Date)) return;
        if (!daysEl || !hoursEl || !minutesEl || !secondsEl) return;

        if (window._next5CountdownTimer) {
          clearInterval(window._next5CountdownTimer);
          window._next5CountdownTimer = null;
        }

        const pad2 = (n) => String(n).padStart(2, "0");

        const update = () => {
          const now = new Date();
          const isToday5 =
            now.getFullYear() === next5Date.getFullYear() &&
            now.getMonth() === next5Date.getMonth() &&
            now.getDate() === next5Date.getDate();

          // Si hoy es día 5, contamos hasta mañana (para que el contador tenga sentido todo el día)
          const target = isToday5
            ? new Date(next5Date.getFullYear(), next5Date.getMonth(), next5Date.getDate() + 1, 0, 0, 0, 0)
            : new Date(next5Date.getFullYear(), next5Date.getMonth(), next5Date.getDate(), 0, 0, 0, 0);

          let diffMs = target.getTime() - now.getTime();
          if (diffMs < 0) diffMs = 0;

          const totalSeconds = Math.floor(diffMs / 1000);
          const days = Math.floor(totalSeconds / 86400);
          const rem = totalSeconds - days * 86400;
          const hours = Math.floor(rem / 3600);
          const minutes = Math.floor((rem % 3600) / 60);
          const seconds = rem % 60;

          daysEl.textContent = String(days);
          hoursEl.textContent = pad2(hours);
          minutesEl.textContent = pad2(minutes);
          secondsEl.textContent = pad2(seconds);
          if (labelEl) {
            labelEl.textContent = isToday5
              ? "Hoy es nuestro día 5 • queda"
              : "Para nuestro día 5 • falta";
          }
        };

        update();
        window._next5CountdownTimer = setInterval(update, 1000);
      } catch (err) {
        console.error("Error en startNext5Countdown:", err);
      }
    };

    function pad2(v) {
      return String(v).padStart(2, "0");
    }

    function computeElapsedYMDHMS(start, end) {
      if (!(start instanceof Date) || !(end instanceof Date)) {
        return { years: 0, months: 0, days: 0, hours: 0, minutes: 0, seconds: 0 };
      }
      if (end.getTime() < start.getTime()) {
        return { years: 0, months: 0, days: 0, hours: 0, minutes: 0, seconds: 0 };
      }

      let years = end.getFullYear() - start.getFullYear();
      let cursor = new Date(start);
      cursor.setFullYear(cursor.getFullYear() + years);
      if (cursor.getTime() > end.getTime()) {
        years -= 1;
        cursor = new Date(start);
        cursor.setFullYear(cursor.getFullYear() + years);
      }

      let months = end.getMonth() - cursor.getMonth();
      if (months < 0) months += 12;
      let cursor2 = new Date(cursor);
      cursor2.setMonth(cursor2.getMonth() + months);
      if (cursor2.getTime() > end.getTime()) {
        months -= 1;
        cursor2 = new Date(cursor);
        cursor2.setMonth(cursor2.getMonth() + months);
      }

      const msDay = 1000 * 60 * 60 * 24;
      let days = Math.floor((end.getTime() - cursor2.getTime()) / msDay);
      if (days < 0) days = 0;
      const cursor3 = new Date(cursor2);
      cursor3.setDate(cursor3.getDate() + days);

      let remaining = end.getTime() - cursor3.getTime();
      if (remaining < 0) remaining = 0;
      const msHour = 1000 * 60 * 60;
      const msMin = 1000 * 60;

      const hours = Math.floor(remaining / msHour);
      remaining -= hours * msHour;
      const minutes = Math.floor(remaining / msMin);
      remaining -= minutes * msMin;
      const seconds = Math.floor(remaining / 1000);

      return { years, months, days, hours, minutes, seconds };
    }

    window.startAnniversaryTimers = function() {
      try {
        if (window._anniversaryTimer) {
          clearInterval(window._anniversaryTimer);
          window._anniversaryTimer = null;
        }

        const startDate = new Date(2024, 7, 5, 0, 0, 0);

        const update = () => {
          const now = new Date();

          // Próximo 5 de agosto
          let nextAnn = new Date(now.getFullYear(), 7, 5, 0, 0, 0);
          if (now.getTime() > nextAnn.getTime()) {
            nextAnn = new Date(now.getFullYear() + 1, 7, 5, 0, 0, 0);
          }

          const nextAnnEl = document.getElementById("dashNextAnniversary");
          if (nextAnnEl) nextAnnEl.textContent = nextAnn.toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });

          const diffMs = Math.max(0, nextAnn.getTime() - now.getTime());
          const totalSeconds = Math.floor(diffMs / 1000);
          const days = Math.floor(totalSeconds / (60 * 60 * 24));
          const hours = Math.floor((totalSeconds % (60 * 60 * 24)) / (60 * 60));
          const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
          const seconds = Math.floor(totalSeconds % 60);

          const annDaysEl = document.getElementById("dashAnnDays");
          if (annDaysEl) annDaysEl.textContent = String(days);
          const annHoursEl = document.getElementById("dashAnnHours");
          if (annHoursEl) annHoursEl.textContent = pad2(hours);
          const annMinutesEl = document.getElementById("dashAnnMinutes");
          if (annMinutesEl) annMinutesEl.textContent = pad2(minutes);
          const annSecondsEl = document.getElementById("dashAnnSeconds");
          if (annSecondsEl) annSecondsEl.textContent = pad2(seconds);

          // Tiempo juntos desde 5 de agosto de 2024
          const elapsed = computeElapsedYMDHMS(startDate, now);
          const yEl = document.getElementById("dashTogetherYears");
          if (yEl) yEl.textContent = String(elapsed.years);
          const moEl = document.getElementById("dashTogetherMonths");
          if (moEl) moEl.textContent = String(elapsed.months);
          const dEl = document.getElementById("dashTogetherDays");
          if (dEl) dEl.textContent = String(elapsed.days);
          const hEl = document.getElementById("dashTogetherHours");
          if (hEl) hEl.textContent = pad2(elapsed.hours);
          const miEl = document.getElementById("dashTogetherMinutes");
          if (miEl) miEl.textContent = pad2(elapsed.minutes);
          const sEl = document.getElementById("dashTogetherSeconds");
          if (sEl) sEl.textContent = pad2(elapsed.seconds);
        };

        update();
        window._anniversaryTimer = setInterval(update, 1000);
      } catch (err) {
        console.error("Error en startAnniversaryTimers:", err);
      }
    };

    // ==================== DATE ROULETTE ====================
    const DATE_IDEAS = [
      {
        title: "Mini road-trip",
        description: "Elijan un destino a 1–2 horas (mirador, pueblito, lago). Hagan playlist, paren por café y tomen 10 fotos ‘tipo álbum’. Terminen con algo rico y un ‘brindis’ por ustedes."
      },
      {
        title: "Picnic",
        description: "Armen una canasta simple (fruta, sándwiches, postre) y una mantita. Lleven una playlist y un juego corto (cartas/UNO). Bonus: cada uno lleva 1 cosa sorpresa."
      },
      {
        title: "Noche de juegos de mesa",
        description: "Elijan 2 juegos: uno competitivo y uno cooperativo. Pongan snacks y una regla divertida (el que pierde da 3 cumplidos). Terminen con un abrazo de ‘reconciliación’."
      },
      {
        title: "Clase de baile",
        description: "Tomen una clase (salsa/bachata/urbano) o aprendan con un video. Meta: dominar 1 paso juntos. Cierren con una canción lenta para bailar pegaditos."
      },
      {
        title: "Compras por su pareja",
        description: "Vayan a una tienda y pongan un presupuesto. Cada uno compra 2–3 cosas que ‘representen’ al otro (snack favorito, detalle, algo útil). Luego se lo entregan como mini ceremonia."
      },
      {
        title: "Recreen su primera cita",
        description: "Hagan el mismo plan (o lo más parecido): comida, lugar, horario, música. Cuéntense qué pensaron ese día. Cierren con una foto juntos recreando la pose de esa época."
      },
      {
        title: "Cena de 5 tiempos",
        description: "Menú: entrada, sopa/ensalada, plato fuerte, postre, bebida. Puede ser en casa o afuera. Pongan dress code y turnos: uno elige 2 tiempos y el otro los otros 3."
      },
      {
        title: "Noche en un motel",
        description: "Planifiquen una noche diferente: habitación, snacks, playlist y cero prisas. Lleven un juego de preguntas y una carta para leer ahí. Enfoque: desconectarse y mimarse."
      },
      {
        title: "Noche de películas",
        description: "Elijan 2 pelis (una por cada uno). Hagan ‘combo cine’ en casa: palomitas + bebida + dulce. Regla: durante la primera peli no se usa el celular."
      },
      {
        title: "Día de museos",
        description: "Elijan un museo/exposición. Cada uno escoge 3 cosas favoritas y se las explica al otro. Al final, vayan por café y escriban una mini reseña de la cita."
      },
      {
        title: "Bar-hopping",
        description: "Armen una ruta de 2–3 bares. En cada lugar pidan 1 bebida para compartir y califiquen ambiente/música. Cierren en un lugar tranquilo para hablar de lo mejor del año."
      },
      {
        title: "Brunch",
        description: "Vayan a un brunch bonito o háganlo en casa: huevos, pan, fruta, café. Hagan una lista de 10 cosas que quieren hacer juntos este año mientras comen."
      },
      {
        title: "Boliche",
        description: "Hagan 2 partidas. El que pierda en la primera, elige la música de camino a casa. El que pierda en la segunda, da un masaje de 10 minutos."
      },
      {
        title: "Libros y café",
        description: "Vayan a una librería + cafetería. Cada uno elige un libro para el otro (por portada o por intuición) y leen 10 minutos en silencio juntos. Luego se cuentan por qué lo eligieron."
      },
      {
        title: "Cine",
        description: "Elijan una peli y vayan como cita formal. Compren algo para compartir. Después del cine, caminen 15 minutos y digan su escena favorita y por qué."
      },
      {
        title: "Ir a patinar",
        description: "Pista de patinaje o patines al aire libre. Meta: 1 vuelta tomados de la mano sin soltarse. Luego premio: helado o bebida caliente."
      },
      {
        title: "Ir a un bazar",
        description: "Vayan a un bazar/mercadito. Regla: cada uno encuentra 1 cosa que ‘les recuerde’ al otro y se la enseña. Cierren con una foto y un snack."
      },
      {
        title: "Restaurante confort",
        description: "Vayan a su restaurante de ‘comfort’. Pidan lo de siempre, pero prueben 1 cosa nueva. Conversación: cada uno dice 3 cosas que le dan paz del otro."
      },
      {
        title: "Restaurante nuevo",
        description: "Elijan un lugar nuevo (tipo ‘aventura’). Regla: cada uno elige 1 plato para compartir. Al final califiquen comida/servicio/ambiente y guarden una foto del plato."
      },
      {
        title: "Cita doble",
        description: "Inviten a otra pareja o amigos. Elijan una actividad (boliche, comida, juegos). Regla: ustedes dos se dan 1 mini cumplido en público (sin pena) durante la cita."
      },
      {
        title: "Food Trucks",
        description: "Vayan a una zona de food trucks. Compartan 2–3 cosas distintas. Hagan ranking: 1) mejor sabor 2) mejor presentación 3) mejor sorpresa."
      },
      {
        title: "Noche de Switch y dormir",
        description: "Elijan un juego (cooperativo o competitivo). Hagan 2 rondas y un castigo divertido. Terminen con una peli cortita o música suave y a dormir abrazados."
      }
    ];

    window._dateWheelState = window._dateWheelState || {
      inited: false,
      spinning: false,
      rotation: 0,
      items: [],
      selected: null,
      selectedIndex: null
    };

    function formatCitaMeta(doc) {
      const data = doc || {};
      const by = (data.acceptedBy || data.by || "").toString();
      const who = by ? (by.charAt(0).toUpperCase() + by.slice(1)) : "—";
      const created = data.createdAt?.toDate?.();
      const when = created ? created.toLocaleDateString("es-ES", { year: "numeric", month: "short", day: "numeric" }) : "—";
      return { who, when };
    }

    function getAllDateIdeas() {
      return DATE_IDEAS.slice();
    }

    function getCssVar(name, fallback) {
      const v = getComputedStyle(document.body).getPropertyValue(name).trim();
      return v || fallback;
    }

    function drawDateWheel(items) {
      const canvas = document.getElementById("dateWheelCanvas");
      const rotor = document.getElementById("dateWheelRotor");
      if (!canvas || !rotor) return;

      const rect = rotor.getBoundingClientRect();
      const size = Math.max(240, Math.floor(Math.min(rect.width, rect.height)));
      const ratio = window.devicePixelRatio || 1;
      canvas.width = Math.floor(size * ratio);
      canvas.height = Math.floor(size * ratio);

      const ctx = canvas.getContext("2d");
      if (!ctx) return;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.clearRect(0, 0, size, size);

      const bgA = getCssVar("--bg-light", "#f3f4f6");
      const bgB = getCssVar("--bg-white", "#ffffff");
      const stroke = getCssVar("--text-light", "#e5e7eb");
      const text = getCssVar("--text-primary", "#111827");

      const n = Math.max(2, items.length);
      const cx = size / 2;
      const cy = size / 2;
      const r = (size / 2) - 2;
      const seg = (Math.PI * 2) / n;
      const start = -Math.PI / 2;

      const degrees = 360 / n;
      const fontSize = degrees < 16 ? 9 : degrees < 20 ? 10 : 11;
      const maxChars = degrees < 16 ? 12 : degrees < 20 ? 14 : 16;

      for (let i = 0; i < n; i++) {
        const a0 = start + i * seg;
        const a1 = a0 + seg;

        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, a0, a1);
        ctx.closePath();
        ctx.fillStyle = (i % 2 === 0) ? bgA : bgB;
        ctx.fill();
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 1;
        ctx.stroke();

        // Label (truncado)
        const raw = String(items[i]?.title || "");
        const label = raw.length > maxChars ? (raw.slice(0, maxChars) + "…") : raw;
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(a0 + seg / 2);
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        ctx.fillStyle = text;
        ctx.font = `900 ${fontSize}px Inter, system-ui, -apple-system, Segoe UI, Arial`;
        ctx.globalAlpha = 0.95;
        ctx.fillText(label, r - 18, 0);
        ctx.restore();
      }

      // Centro
      ctx.beginPath();
      ctx.arc(cx, cy, Math.max(22, r * 0.11), 0, Math.PI * 2);
      ctx.fillStyle = bgB;
      ctx.fill();
      ctx.strokeStyle = stroke;
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function computeSelectedIndex(rotationDeg, n) {
      const seg = 360 / n;
      const rotNorm = ((rotationDeg % 360) + 360) % 360;
      const y = (360 - rotNorm) % 360;
      const angle = (y + seg / 2) % 360;
      return Math.floor(angle / seg);
    }

    window.initDateRoulette = function() {
      try {
        if (window._dateWheelState.inited) return;
        window._dateWheelState.inited = true;

        const rotor = document.getElementById("dateWheelRotor");
        const stage = document.querySelector(".wheel-stage");
        if (!rotor || !stage) return;

        window._dateWheelState.items = getAllDateIdeas();
        drawDateWheel(window._dateWheelState.items);

        const resultEl = document.getElementById("dateRouletteResult");
        if (resultEl) resultEl.textContent = "Gira la ruleta…";

        const descEl = document.getElementById("dateRouletteDesc");
        if (descEl) descEl.textContent = "";

        const btnAccept = document.getElementById("btnAcceptDate");
        if (btnAccept) btnAccept.disabled = true;

        // Resize re-draw
        window.addEventListener("resize", () => {
          if (!window._dateWheelState?.inited) return;
          drawDateWheel(window._dateWheelState.items);
        }, { passive: true });

        // End of spin
        rotor.addEventListener("transitionend", () => {
          try {
            if (!window._dateWheelState.spinning) return;
            window._dateWheelState.spinning = false;
            stage.classList.remove("is-spinning");

            const n = window._dateWheelState.items.length;
            const idx = computeSelectedIndex(window._dateWheelState.rotation, n);
            window._dateWheelState.selectedIndex = idx;
            window._dateWheelState.selected = window._dateWheelState.items[idx];

            const resultEl2 = document.getElementById("dateRouletteResult");
            if (resultEl2) {
              resultEl2.classList.remove("is-ready");
              resultEl2.textContent = String(window._dateWheelState.selected?.title || "");
              // retrigger animation
              void resultEl2.offsetWidth;
              resultEl2.classList.add("is-ready");
            }

            const descEl2 = document.getElementById("dateRouletteDesc");
            if (descEl2) descEl2.textContent = String(window._dateWheelState.selected?.description || "");

            const btnAccept2 = document.getElementById("btnAcceptDate");
            if (btnAccept2) btnAccept2.disabled = !window._dateWheelState.selected;
          } catch (err) {
            console.error("transitionend date wheel error:", err);
          }
        });

        if (typeof window.loadDatesDone === "function") window.loadDatesDone();
      } catch (err) {
        console.error("Error en initDateRoulette:", err);
      }
    };

    window.spinDateWheel = function() {
      try {
        if (!currentUser || !firebaseReady || !db) {
          window.showToast("Inicia sesión para usar la ruleta", "warning");
          return;
        }
        const rotor = document.getElementById("dateWheelRotor");
        const stage = document.querySelector(".wheel-stage");
        if (!rotor || !stage) return;
        if (window._dateWheelState.spinning) return;

        // Keep all specified options visible on the wheel
        window._dateWheelState.items = getAllDateIdeas();
        drawDateWheel(window._dateWheelState.items);

        const n = window._dateWheelState.items.length;
        const chosenIndex = Math.floor(Math.random() * n);
        const seg = 360 / n;
        const desiredNorm = (360 - (((chosenIndex + 0.5) * seg) % 360)) % 360;

        const current = window._dateWheelState.rotation;
        const currentNorm = ((current % 360) + 360) % 360;
        const deltaNorm = (desiredNorm - currentNorm + 360) % 360;
        const baseSpins = 360 * (6 + Math.floor(Math.random() * 5));
        const finalRotation = current + baseSpins + deltaNorm;

        window._dateWheelState.spinning = true;
        window._dateWheelState.rotation = finalRotation;
        window._dateWheelState.selected = null;
        window._dateWheelState.selectedIndex = null;

        const resultEl = document.getElementById("dateRouletteResult");
        if (resultEl) {
          resultEl.classList.remove("is-ready");
          resultEl.textContent = "Girando…";
        }

        const descEl = document.getElementById("dateRouletteDesc");
        if (descEl) descEl.textContent = "";

        const btnAccept = document.getElementById("btnAcceptDate");
        if (btnAccept) btnAccept.disabled = true;

        stage.classList.add("is-spinning");
        rotor.style.transition = "transform 4.8s cubic-bezier(.12,.95,.12,1)";
        rotor.style.transform = `rotate(${finalRotation}deg)`;
      } catch (err) {
        console.error("Error en spinDateWheel:", err);
      }
    };

    window.acceptDateIdea = async function() {
      try {
        if (!currentUser || !firebaseReady || !db) return;
        if (!window._dateWheelState.selected) {
          window.showToast("Primero gira la ruleta", "warning");
          return;
        }

        const title = String(window._dateWheelState.selected?.title || "");
        const description = String(window._dateWheelState.selected?.description || "");
        const btnAccept = document.getElementById("btnAcceptDate");
        if (btnAccept) btnAccept.disabled = true;

        await db.collection("citas").add({
          title,
          description,
          acceptedBy: currentUser,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        window.showToast("Guardado en Citas hechas", "success");

        const resultEl = document.getElementById("dateRouletteResult");
        if (resultEl) {
          resultEl.classList.remove("is-ready");
          resultEl.textContent = "Gira la ruleta…";
        }
        const descEl = document.getElementById("dateRouletteDesc");
        if (descEl) descEl.textContent = "";
        window._dateWheelState.selected = null;
        window._dateWheelState.selectedIndex = null;

        if (typeof window.loadDatesDone === "function") await window.loadDatesDone();
      } catch (err) {
        console.error("Error en acceptDateIdea:", err);
        window.showToast("Error guardando cita: " + (err.message || err), "error");
        const btnAccept = document.getElementById("btnAcceptDate");
        if (btnAccept) btnAccept.disabled = !window._dateWheelState.selected;
      }
    };

    window.loadDatesDone = async function() {
      try {
        const list = document.getElementById("datesDoneList");
        if (!list) return;
        if (!currentUser || !firebaseReady || !db) {
          list.innerHTML = '<div style="color: var(--text-tertiary); padding: 8px 2px;">Inicia sesión para ver las citas hechas.</div>';
          return;
        }

        list.innerHTML = '<div style="color: var(--text-tertiary); padding: 8px 2px;">Cargando…</div>';

        const snap = await db.collection("citas").limit(200).get();
        if (snap.empty) {
          list.innerHTML = '<div style="color: var(--text-tertiary); padding: 8px 2px;">Aún no hay citas hechas.</div>';
          return;
        }

        const docs = snap.docs
          .map(d => ({ id: d.id, ...((d.data() || {})) }))
          .sort((a, b) => {
            const da = a.createdAt?.toDate?.() || new Date(0);
            const dbb = b.createdAt?.toDate?.() || new Date(0);
            return dbb - da;
          })
          .slice(0, 24);

        list.innerHTML = "";
        docs.forEach(data => {
          const el = document.createElement("div");
          el.className = "date-done-item";
          const meta = formatCitaMeta(data);
          const title = String(data.title || data.idea || "");
          const description = String(data.description || data.desc || "");
          const descShort = description.length > 180 ? (description.slice(0, 180) + "…") : description;
          el.innerHTML = `
            <div class="date-done-title">${escapeHtml(title)}</div>
            ${descShort ? `<div style="color: var(--text-secondary); font-weight: 650; line-height: 1.5;">${escapeHtml(descShort)}</div>` : ""}
            <div class="date-done-meta">
              <span><i class="fas fa-user"></i> ${escapeHtml(meta.who)}</span>
              <span><i class="fas fa-calendar"></i> ${escapeHtml(meta.when)}</span>
            </div>
          `;
          list.appendChild(el);
        });
      } catch (err) {
        console.error("Error en loadDatesDone:", err);
        const list = document.getElementById("datesDoneList");
        if (list) list.innerHTML = `<div style="color:#ef4444; padding: 8px 2px;">Error: ${escapeHtml(err.message || String(err))}</div>`;
      }
    };

    // ==================== OPCIONES SELECTORES ====================
    const moods = [
      { id: "love", icon: "fa-heart", label: "Amor profundo", desc: "Lleno de amor" },
      { id: "happy", icon: "fa-face-smile", label: "Feliz", desc: "Momentos alegres" },
      { id: "passion", icon: "fa-fire", label: "Apasionado", desc: "Con intensidad" },
      { id: "nostalgia", icon: "fa-clock-rotate-left", label: "Nostálgico", desc: "Recuerdos dulces" },
      { id: "romantic", icon: "fa-rose", label: "Romántico", desc: "Sensibilidad pura" }
    ];

    const moodLegacyEmojiMap = {
      "\uD83D\uDC96": "love",       // legacy: love
      "\uD83D\uDE0A": "happy",      // legacy: happy
      "\uD83E\uDD70": "passion",    // legacy: passion
      "\uD83D\uDE2D": "nostalgia",  // legacy: nostalgia
      "\uD83C\uDF39": "romantic"    // legacy: romantic
    };

    const moodById = moods.reduce((acc, m) => {
      acc[m.id] = m;
      return acc;
    }, {});

    const styleById = {
      classic: { icon: "fa-file-lines", label: "Clásico" },
      vintage: { icon: "fa-scroll", label: "Vintage" },
      modern: { icon: "fa-wand-magic-sparkles", label: "Moderno" },
      romantic: { icon: "fa-heart", label: "Romántico" }
    };

    window.getMoodId = function(value) {
      if (!value) return "love";
      if (moodById[value]) return value;
      if (moodLegacyEmojiMap[value]) return moodLegacyEmojiMap[value];
      return "love";
    };

    window.renderMoodIcon = function(value) {
      const moodId = window.getMoodId(value);
      const mood = moodById[moodId] || moodById.love;
      return `<i class="fas ${mood.icon}"></i>`;
    };

    window.renderMoodFull = function(value) {
      const moodId = window.getMoodId(value);
      const mood = moodById[moodId] || moodById.love;
      return `<i class="fas ${mood.icon}"></i> ${mood.label}`;
    };

    window.renderStyleFull = function(styleId) {
      const meta = styleById[styleId] || styleById.classic;
      return `<i class="fas ${meta.icon}"></i> ${meta.label}`;
    };

    window.getTriggerHtml = function(selectId, value, label) {
      if (selectId === "selectMood") return window.renderMoodFull(value);
      if (selectId === "selectStyle") return window.renderStyleFull(value);
      if (selectId === "selectTo") return `<i class="fas fa-user"></i> ${label}`;
      return label;
    };

    window.initSelects = function() {
      try {
        // Destinatario
        const other = currentUser === "diego" ? "danna" : "diego";
        const otherName = other.charAt(0).toUpperCase() + other.slice(1);
        
        const dropdownTo = document.getElementById("dropdownTo");
        if (dropdownTo) {
          dropdownTo.innerHTML = `
            <div class="select-option" onclick="window.selectOption('selectTo', '${other}', '${otherName}')">
              <span class="select-option-emoji"><i class="fas fa-user"></i></span>
              <div class="select-option-text">
                <div class="select-option-label">${otherName}</div>
              </div>
            </div>
          `;
        }
        const letterToEl = document.getElementById("letterTo");
        if (letterToEl) letterToEl.value = other;
        const triggerTo = document.getElementById("triggerTo");
        if (triggerTo) triggerTo.innerHTML = window.getTriggerHtml("selectTo", other, otherName);

        // Sentimientos
        const dropdownMood = document.getElementById("dropdownMood");
        if (dropdownMood) {
          dropdownMood.innerHTML = moods.map(m => `
            <div class="select-option" onclick="window.selectOption('selectMood', '${m.id}', '${m.label}')">
              <span class="select-option-emoji"><i class="fas ${m.icon}"></i></span>
              <div class="select-option-text">
                <div class="select-option-label">${m.label}</div>
                <div class="select-option-desc">${m.desc}</div>
              </div>
            </div>
          `).join("");
        }
        const letterMoodEl = document.getElementById("letterMood");
        if (letterMoodEl) letterMoodEl.value = "love";
        const triggerMood = document.getElementById("triggerMood");
        if (triggerMood) triggerMood.innerHTML = window.renderMoodFull("love");

        // Estilos de Carta
        const styles = [
          { id: "classic", icon: "fa-file-lines", label: "Clásico", desc: "Elegante y tradicional" },
          { id: "vintage", icon: "fa-scroll", label: "Vintage", desc: "Estilo antiguo y nostálgico" },
          { id: "modern", icon: "fa-wand-magic-sparkles", label: "Moderno", desc: "Limpio y contemporáneo" },
          { id: "romantic", icon: "fa-heart", label: "Romántico", desc: "Cálido y apasionado" }
        ];

        const dropdownStyle = document.getElementById("dropdownStyle");
        if (dropdownStyle) {
          dropdownStyle.innerHTML = styles.map(s => `
            <div class="select-option" onclick="window.selectOption('selectStyle', '${s.id}', '${s.label}')">
              <span class="select-option-emoji"><i class="fas ${s.icon}"></i></span>
              <div class="select-option-text">
                <div class="select-option-label">${s.label}</div>
                <div class="select-option-desc">${s.desc}</div>
              </div>
            </div>
          `).join("");
        }
        const letterStyleEl = document.getElementById("letterStyle");
        if (letterStyleEl) letterStyleEl.value = "classic";
        const triggerStyleEl = document.getElementById("triggerStyle");
        if (triggerStyleEl) triggerStyleEl.innerHTML = window.renderStyleFull("classic");

        // Tipografías
        const fonts = [
          { id: "sans-serif", label: "Sans Serif", preview: "Clean & Modern" },
          { id: "serif", label: "Serif", preview: "Elegant & Classic" },
          { id: "cursive", label: "Cursive", preview: "Beautiful & Flow" },
          { id: "monospace", label: "Monospace", preview: "Technical & Retro" }
        ];

        const dropdownFont = document.getElementById("dropdownFont");
        if (dropdownFont) {
          dropdownFont.innerHTML = fonts.map(f => `
            <div class="select-option" onclick="window.selectOption('selectFont', '${f.id}', '${f.label}')">
              <div class="select-option-text">
                <div class="select-option-label">${f.label}</div>
                <div class="select-option-desc" style="font-family: var(--font-${f.id}, inherit);">${f.preview}</div>
              </div>
            </div>
          `).join("");
        }
        const letterFontEl = document.getElementById("letterFont");
        if (letterFontEl) letterFontEl.value = "sans-serif";
        const triggerFontEl = document.getElementById("triggerFont");
        if (triggerFontEl) triggerFontEl.textContent = "Sans Serif";
    } catch(err) {
      console.error("Error in initSelects:", err);
    }
    };

    // ==================== YOUTUBE MUSIC URL HANDLER ====================
    window.initSongSearch = function() {
      try {
        const searchInput = document.getElementById("songSearchInput");
        
        if (!searchInput) {
          console.warn("songSearchInput no encontrado");
          return;
        }
        
        console.log("Inicializando entrada de URL de YouTube");

        // Al pegar o escribir la URL
        searchInput.addEventListener("change", function() {
          const url = this.value.trim();
          console.log("URL ingresada:", url);
          
          if (!url) return;
          
          // Validar que sea una URL de YouTube válida
          if (!window.isValidYouTubeUrl(url)) {
            window.showToast("URL de YouTube no válida", "error");
            return;
          }
          
          // Extraer video ID
          const videoId = window.extractYouTubeVideoId(url);
          if (videoId) {
            // Usar el video ID como título por defecto
            window.selectSongFromSearch(videoId, url, "Canción de YouTube", url);
            window.showToast("Canción cargada correctamente", "success");
          }
        });

        // También validar al presionar Enter
        searchInput.addEventListener("keypress", function(e) {
          if (e.key === "Enter") {
            e.preventDefault();
            this.dispatchEvent(new Event("change"));
          }
        });
        
        console.log("Entrada de URL de YouTube inicializada");
      } catch(err) {
        console.error("Error en initSongSearch:", err);
      }
    };

    window.isValidYouTubeUrl = function(url) {
      try {
        // Aceptar URLs de YouTube en varios formatos
        const patterns = [
          /youtube\.com\/watch\?v=[a-zA-Z0-9_-]+/,
          /youtu\.be\/[a-zA-Z0-9_-]+/,
          /youtube\.com\/embed\/[a-zA-Z0-9_-]+/
        ];
        
        return patterns.some(pattern => pattern.test(url));
      } catch (error) {
        console.error("Error validando URL:", error);
        return false;
      }
    };

    window.extractYouTubeVideoId = function(url) {
      try {
        // Extraer video ID de diferentes formatos de URL de YouTube
        let videoId = null;
        
        if (url.includes("youtube.com/watch?v=")) {
          videoId = url.split("v=")[1].split("&")[0];
        } else if (url.includes("youtu.be/")) {
          videoId = url.split("youtu.be/")[1].split("?")[0];
        } else if (url.includes("youtube.com/embed/")) {
          videoId = url.split("embed/")[1].split("?")[0];
        }
        
        console.log("Video ID extraído:", videoId);
        return videoId;
      } catch (error) {
        console.error("Error extrayendo video ID:", error);
        return null;
      }
    };

    window.selectSongFromSearch = function(id, title, artist, url) {
      try {
        // Guardar información de la canción
        document.getElementById("letterSong").value = id;
        document.getElementById("selectedSongUrl").value = url;
        
        // Mostrar información seleccionada
        const selectedTitle = document.getElementById("selectedSongTitle");
        const selectedArtist = document.getElementById("selectedSongArtist");
        
        if (selectedTitle) selectedTitle.textContent = title;
        if (selectedArtist) selectedArtist.textContent = artist;
        
        const selectedInfo = document.getElementById("selectedSongInfo");
        if (selectedInfo) selectedInfo.style.display = "flex";
        
        const searchInput = document.getElementById("songSearchInput");
        if (searchInput) searchInput.value = url;

        console.log("Canción seleccionada:", title, "URL:", url);
        
        // Mostrar botón para abrir en YouTube
        const openYTBtn = document.getElementById("openYouTubeBtn");
        if (openYTBtn && url) {
          openYTBtn.style.display = "inline-flex";
          openYTBtn.onclick = (e) => {
            e.preventDefault();
            window.open(url, '_blank');
          };
        }
        
        // Actualizar preview
        window.updatePreview();
      } catch(err) {
        console.error("Error seleccionando canción:", err);
      }
    };

    window.clearSongSelection = function() {
      try {
        const letterSong = document.getElementById("letterSong");
        if (letterSong) letterSong.value = "none";
        
        const selectedSongUrl = document.getElementById("selectedSongUrl");
        if (selectedSongUrl) selectedSongUrl.value = "";
        
        const selectedInfo = document.getElementById("selectedSongInfo");
        if (selectedInfo) selectedInfo.style.display = "none";
        
        const songSearchInput = document.getElementById("songSearchInput");
        if (songSearchInput) {
          songSearchInput.value = "";
          songSearchInput.focus();
        }
        
        console.log("🗑️ Selección de canción limpiada");
        window.updatePreview();
      } catch(err) {
        console.error("Error limpiando selección:", err);
      }
    };

    window.toggleSelect = function(selectId) {
      const trigger = document.querySelector(`#${selectId} .select-trigger`);
      const dropdown = document.querySelector(`#${selectId} .select-dropdown`);
      
      document.querySelectorAll(".select-dropdown.active").forEach(d => {
        if (d !== dropdown) d.classList.remove("active");
      });
      document.querySelectorAll(".select-trigger.active").forEach(t => {
        if (t !== trigger) t.classList.remove("active");
      });

      trigger.classList.toggle("active");
      dropdown.classList.toggle("active");
    };

    window.selectOption = function(selectId, value, label) {
      document.getElementById(`${selectId.replace('select', 'letter')}`).value = value;
      const triggerEl = document.getElementById(`trigger${selectId.replace('select', '')}`);
      if (triggerEl) {
        triggerEl.innerHTML = window.getTriggerHtml ? window.getTriggerHtml(selectId, value, label) : label;
      }
      document.querySelector(`#${selectId} .select-trigger`).classList.remove("active");
      document.querySelector(`#${selectId} .select-dropdown`).classList.remove("active");
      
      // Aplicar estilos si es selectStyle o selectFont
      if (selectId === "selectStyle") {
        const preview = document.getElementById("paperPreview");
        if (preview) {
          preview.className = `paper-preview style-${value} font-${document.getElementById("letterFont").value}`;
        }
      } else if (selectId === "selectFont") {
        const preview = document.getElementById("paperPreview");
        if (preview) {
          preview.className = `paper-preview style-${document.getElementById("letterStyle").value} font-${value}`;
        }
      }
      
      window.updatePreview();
    };

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".custom-select")) {
        document.querySelectorAll(".select-dropdown.active").forEach(d => d.classList.remove("active"));
        document.querySelectorAll(".select-trigger.active").forEach(t => t.classList.remove("active"));
      }
    });

    window.updateUI = function() {
      try {
        console.log("updateUI iniciando...");
        window.initSelects();
        console.log("updateUI completado");
      } catch(err) {
        console.error("Error en updateUI:", err);
      }
    };

    window.setupEventListeners = function() {
      try {
        console.log("setupEventListeners iniciando...");
        
        const inputs = ["letterTitle", "letterText", "letterMood"];
        inputs.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener("input", window.updatePreview);
            el.addEventListener("change", window.updatePreview);
          }
        });

        // Portada: abrir en pantalla completa
        try {
          const cover = document.getElementById("inicioCover");
          const coverImg = cover?.querySelector?.("img");
          if (cover && coverImg) {
            cover.tabIndex = 0;
            cover.setAttribute("role", "button");
            cover.setAttribute("aria-label", "Ampliar portada");

            const open = () => window.openCoverLightbox(coverImg.getAttribute("src"), coverImg.getAttribute("alt") || "Portada");
            cover.addEventListener("click", (e) => {
              // Evitar que clicks sobre elementos interactivos dentro (si se agregan en el futuro) disparen dos veces
              if (e.defaultPrevented) return;
              open();
            });
            cover.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                open();
              }
            });
          }

          const lightbox = document.getElementById("coverLightbox");
          const img = document.getElementById("coverLightboxImg");
          const stage = document.getElementById("coverLightboxStage");
          if (lightbox && img && stage) {
            // Cerrar al tocar fuera
            lightbox.addEventListener("click", (e) => {
              if (e.target === lightbox) window.closeCoverLightbox();
            });
            // Toggle zoom al tocar la imagen
            img.addEventListener("click", (e) => {
              e.stopPropagation();
              stage.classList.toggle("is-zoomed");
            });
          }

          // ESC para cerrar
          document.addEventListener("keydown", (e) => {
            if (e.key !== "Escape") return;
            const lb = document.getElementById("coverLightbox");
            if (lb && lb.classList.contains("active")) window.closeCoverLightbox();
          });
        } catch (e) {
          console.error("Error configurando portada:", e);
        }

        const tabButtons = document.querySelectorAll(".tabs .tab-btn");
        tabButtons.forEach(btn => {
          btn.addEventListener("click", function() {
            document.querySelectorAll(".tabs .tab-btn").forEach(b => b.classList.remove("active"));
            document.querySelectorAll("#mainContent .tab-content").forEach(c => c.classList.remove("active"));
            this.classList.add("active");
            const tabId = `tab-${this.dataset.tab}`;
            const content = document.getElementById(tabId);
            if (content) {
              content.classList.add("active");
            }

            // Marcar como visto y refrescar pendientes
            try {
              const tab = String(this.dataset.tab || "");
              if (currentUser && tab === "galeria") {
                const photosKey = `ce_lastSeenPhotos_${currentUser}`;
                localStorage.setItem(photosKey, String(Date.now()));
              }
              if (typeof window.loadDashboard === "function") window.loadDashboard();
            } catch (e) {
              console.error("Error actualizando pendientes:", e);
            }

            // Mostrar el botón flotante solo en Inicio
            try {
              window.updatePendingFloatingVisibility?.();
            } catch (_) {}
          });
        });

        // Inicializar primer tab como activo
        document.querySelectorAll(".tabs .tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll("#mainContent .tab-content").forEach(c => c.classList.remove("active"));

        const firstTab = document.querySelector(".tabs .tab-btn");
        if (firstTab) {
          firstTab.classList.add("active");
          const firstTabId = `tab-${firstTab.dataset.tab}`;
          const firstContent = document.getElementById(firstTabId);
          if (firstContent) {
            firstContent.classList.add("active");
          }
        }

        // Estado inicial del botón flotante (solo Inicio)
        try {
          window.updatePendingFloatingVisibility?.();
        } catch (_) {}

        // Inicializar búsqueda de canciones
        console.log("Inicializando entrada de URL de YouTube...");
        window.initSongSearch();
        console.log("setupEventListeners completado");
      } catch(err) {
        console.error("Error en setupEventListeners:", err);
      }
    };

    window.updatePreview = function() {
      try {
        const title = document.getElementById("letterTitle")?.value || "Sin título";
        const text = document.getElementById("letterText")?.value || "Escribe aquí...";
        const mood = document.getElementById("letterMood")?.value || "love";
        const to = document.getElementById("letterTo")?.value;
        const style = document.getElementById("letterStyle")?.value || "classic";
        const font = document.getElementById("letterFont")?.value || "sans-serif";

        const previewTitle = document.getElementById("previewTitle");
        if (previewTitle) previewTitle.textContent = title;
        
        const previewText = document.getElementById("previewText");
        if (previewText) previewText.textContent = text;
        
        const previewMood = document.getElementById("previewMood");
        if (previewMood) previewMood.innerHTML = window.renderMoodIcon ? window.renderMoodIcon(mood) : mood;
        
        const previewFrom = document.getElementById("previewFrom");
        if (previewFrom) previewFrom.textContent = `De: ${currentUser ? currentUser.charAt(0).toUpperCase() + currentUser.slice(1) : "—"}`;
        
        const previewTo = document.getElementById("previewTo");
        if (previewTo) previewTo.textContent = `Para: ${to ? to.charAt(0).toUpperCase() + to.slice(1) : "—"}`;
        
        const previewDate = document.getElementById("previewDate");
        if (previewDate) previewDate.textContent = new Date().toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });
        
        // Aplicar estilos a la previsualización
        const preview = document.getElementById("paperPreview");
        if (preview) {
          preview.className = `paper-preview style-${style} font-${font}`;
        }
      } catch(err) {
        console.error("Error en updatePreview:", err);
      }
    };

    window.saveLetter = async function() {
      try {
        if (!currentUser || !firebaseReady || !db) {
          window.showToast("Debes iniciar sesión", "error");
          return;
        }

        const to = document.getElementById("letterTo")?.value;
        const title = document.getElementById("letterTitle")?.value;
        const text = document.getElementById("letterText")?.value;
        const mood = document.getElementById("letterMood")?.value;
        const songId = document.getElementById("letterSong")?.value;
        const songTitle = document.getElementById("selectedSongTitle")?.textContent;
        const songArtist = document.getElementById("selectedSongArtist")?.textContent;
        const songUrl = document.getElementById("selectedSongUrl")?.value;
        const style = document.getElementById("letterStyle")?.value;
        const font = document.getElementById("letterFont")?.value;

        if (!to || !title || !title.trim() || !text || !text.trim()) {
          window.showToast("Completa todos los campos", "error");
          return;
        }

        const letterData = {
          author: currentUser,
          to: to,
          title: title,
          text: text,
          mood: mood,
          style: style || "classic",
          font: font || "sans-serif",
          songId: songId || "none",
          songTitle: songTitle || "",
          songArtist: songArtist || "",
          songUrl: songUrl || "",
          isRead: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection("letters").add(letterData);

        window.showToast("Carta enviada con éxito", "success");
        document.getElementById("letterTitle").value = "";
        document.getElementById("letterText").value = "";
        window.clearSongSelection();
        window.updatePreview();
        window.loadLetters();
        window.loadDashboard();

        // Push real (segundo plano) al otro usuario
        try {
          const other = otherUserFor(currentUser);
          if (other) {
            await window.sendPushToUser(
              other,
              `Nueva carta de ${currentUser.charAt(0).toUpperCase() + currentUser.slice(1)}`,
              `"${title}"`,
              { url: "/" }
            );
          }
        } catch (pushErr) {
          console.warn("No se pudo enviar push:", pushErr);
        }
      } catch (err) {
        window.showToast("Error: " + err.message, "error");
      }
    };

    window.loadLetters = async function() {
      try {
        console.log("loadLetters iniciando...");
        
        if (!currentUser || !firebaseReady || !db) {
          console.log("Condición de retorno en loadLetters");
          return;
        }

        const lettersList = document.getElementById("lettersList");
        if (!lettersList) {
          console.error("lettersList element not found");
          return;
        }
        
        lettersList.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 20px">Cargando cartas...</p>';

        let query = db.collection("letters");
        
        if (filterMode === "inbox") {
          // Solo cartas destinadas a este usuario
          query = query.where("to", "==", currentUser);
        } else if (filterMode === "all") {
          // Cartas del usuario actual (que envió)
          query = query.where("author", "==", currentUser);
        } else {
          // Por defecto, mostrar cartas para este usuario
          query = query.where("to", "==", currentUser);
          filterMode = "inbox";
        }
        
        // Limitar y obtener (sin orderBy en la query para evitar índice)
        query = query.limit(100);

        const snapshot = await query.get();

        console.log("Cartas cargadas:", snapshot.size, "Filter:", filterMode, "User:", currentUser);

        if (snapshot.empty) {
          lettersList.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 20px"><i class="fas fa-inbox"></i> Sin cartas aún</p>';
          const statsEl = document.getElementById("statsLetters");
          if (statsEl) statsEl.textContent = "0";
          return;
        }

        // Ordenar en el cliente por fecha descendente
        const docs = snapshot.docs.sort((a, b) => {
          const dateA = a.data().createdAt?.toDate?.() || new Date(0);
          const dateB = b.data().createdAt?.toDate?.() || new Date(0);
          return dateB - dateA;
        });

        lettersList.innerHTML = "";
        let count = 0;
        docs.forEach(doc => {
          count++;
          const data = doc.data();
          // Guardar ID para poder eliminar
          data.__id = doc.id;
          const dateObj = data.createdAt?.toDate?.();
          const date = dateObj ? dateObj.toLocaleDateString("es-ES", { year: "numeric", month: "short", day: "numeric" }) : "—";
          const authorName = (data.author || "?").charAt(0).toUpperCase() + (data.author || "?").slice(1);
          
          const el = document.createElement("div");
          const authorKey = String(data.author || "").toLowerCase();
          el.className = "letter-item";
          if (authorKey === "diego") el.classList.add("letter-from-diego");
          if (authorKey === "danna") el.classList.add("letter-from-danna");
          el.style.animationDelay = `${count * 0.05}s`;
          el.innerHTML = `
            <div>
              <div class="letter-item-title"><i class="fas fa-heart"></i> ${data.title || "Sin título"}</div>
              <div class="letter-item-meta">
                <span><i class="fas fa-user"></i> De ${authorName}</span>
                <span><i class="fas fa-calendar"></i> ${date}</span>
              </div>
            </div>
          `;
          el.addEventListener("click", () => window.openLetter(data));
          lettersList.appendChild(el);
        });

        const statsLetters = document.getElementById("statsLetters");
        if (statsLetters) statsLetters.textContent = docs.length;
        
        console.log("loadLetters completado");
      } catch (err) {
        console.error("Error al cargar cartas:", err);
        lettersList.innerHTML = `<p style="text-align: center; color: #ef4444; padding: 20px"><i class="fas fa-exclamation-circle"></i> Error: ${err.message}</p>`;
      }
    };

    let currentLetter = null;
    let currentLetterId = null;
    let audioElement = null;

    // ==================== YOUTUBE IFRAME API (AUTOPLAY) ====================
    let ytPlayer = null;
    let ytApiReadyPromise = null;

    function ensureYouTubeIframeApi() {
      if (ytApiReadyPromise) return ytApiReadyPromise;

      ytApiReadyPromise = new Promise((resolve) => {
        // Ya está cargada
        if (window.YT && window.YT.Player) {
          resolve();
          return;
        }

        // Si ya existe el script, esperar
        const existing = document.querySelector('script[src="https://www.youtube.com/iframe_api"]');
        if (existing) {
          const check = setInterval(() => {
            if (window.YT && window.YT.Player) {
              clearInterval(check);
              resolve();
            }
          }, 50);
          setTimeout(() => {
            clearInterval(check);
            resolve();
          }, 5000);
          return;
        }

        // Cargar script
        window.onYouTubeIframeAPIReady = function() {
          resolve();
        };

        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(tag);

        // Fallback por si onYouTubeIframeAPIReady no dispara
        const check = setInterval(() => {
          if (window.YT && window.YT.Player) {
            clearInterval(check);
            resolve();
          }
        }, 50);
        setTimeout(() => {
          clearInterval(check);
          resolve();
        }, 5000);
      });

      return ytApiReadyPromise;
    }

    window.openLetter = function(data) {
      try {
        currentLetter = data;
        currentLetterId = data && data.__id ? String(data.__id) : null;

        // Marcar como leída si es una carta recibida
        try {
          const isReceived = String(data?.to || "").toLowerCase() === String(currentUser || "").toLowerCase();
          const isRead = !!data?.isRead;
          if (isReceived && !isRead && currentLetterId && firebaseReady && db) {
            db.collection("letters")
              .doc(currentLetterId)
              .update({ isRead: true })
              .then(() => {
                data.isRead = true;
                if (typeof window.loadDashboard === "function") window.loadDashboard();
                if (typeof window.loadLetters === "function") window.loadLetters();
              })
              .catch((e) => console.error("Error marcando carta como leída:", e));
          }
        } catch (e) {
          console.error("Error en marcado de lectura:", e);
        }

        const deleteBtn = document.getElementById("deleteLetterBtn");
        if (deleteBtn) {
          // Solo mostrar si hay un id válido
          deleteBtn.style.display = currentLetterId ? "inline-flex" : "none";
        }

        // Llenar modal
        document.getElementById("modalTitle").textContent = data.title;
        document.getElementById("modalPaperTitle").textContent = data.title;
        document.getElementById("modalPaperText").textContent = data.text;
        document.getElementById("modalFrom").textContent = data.author.charAt(0).toUpperCase() + data.author.slice(1);
        document.getElementById("modalTo").textContent = data.to.charAt(0).toUpperCase() + data.to.slice(1);
        const modalMoodEl = document.getElementById("modalMood");
        if (modalMoodEl) modalMoodEl.innerHTML = window.renderMoodFull ? window.renderMoodFull(data.mood) : (data.mood || "—");
        document.getElementById("modalDate").textContent = data.createdAt?.toDate().toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });

        // Aplicar estilo y tipografía
        const modalPaper = document.getElementById("modalPaper");
        if (modalPaper) {
          const style = data.style || "classic";
          const font = data.font || "sans-serif";
          modalPaper.className = `modal-paper style-${style} font-${font}`;
        }

        // Música
        if (data.songId && data.songId !== "none") {
          const songTitle = data.songTitle || "Canción seleccionada";
          const songArtist = data.songArtist || "Artista desconocido";
          const songUrl = data.songUrl || "";

          document.getElementById("musicContainer").style.display = "block";
          
          // Mostrar título y artista (limitar la URL si es muy larga)
          const displayTitle = songTitle.length > 50 ? "Canción de YouTube" : songTitle;
          const displayArtist = songArtist.length > 50 ? "Reproduciendo..." : songArtist;
          
          document.getElementById("playerTitle").textContent = displayTitle;
          document.getElementById("playerArtist").textContent = displayArtist;
          
          // Embeber player de YouTube si hay URL (youtube.com o youtu.be)
          if (songUrl && songUrl.includes("youtu")) {
            console.log("Reproduciendo canción de YouTube:", songUrl);
            window.embedYouTubePlayer(songUrl);
          } else {
            window.initAudio(data.songId, songUrl);
            // Reproducir automáticamente
            setTimeout(() => {
              window.toggleMusic();
            }, 100);
          }
        } else {
          document.getElementById("musicContainer").style.display = "none";
        }

        // Mostrar modal
        document.getElementById("letterModal").classList.add("active");
      } catch(err) {
        console.error("Error en openLetter:", err);
      }
    };

    window.deleteCurrentLetter = async function() {
      try {
        if (!currentLetterId) return;
        if (!currentUser || !firebaseReady || !db) {
          window.showToast("Debes iniciar sesión", "error");
          return;
        }
        const ok = window.confirm("¿Eliminar esta carta? Esta acción no se puede deshacer.");
        if (!ok) return;

        await db.collection("letters").doc(currentLetterId).delete();
        window.showToast("Carta eliminada", "success");
        window.closeLetter();
        window.loadLetters();
        window.loadDashboard();
      } catch (err) {
        window.showToast("Error: " + err.message, "error");
      }
    };

    window.closeLetter = function() {
      try {
        const letterModal = document.getElementById("letterModal");
        if (letterModal) letterModal.classList.remove("active");

        const deleteBtn = document.getElementById("deleteLetterBtn");
        if (deleteBtn) deleteBtn.style.display = "none";
        currentLetterId = null;
        
        if (audioElement) {
          audioElement.pause();
          audioElement.currentTime = 0;
        }
        
        // Detener/limpiar YouTube
        try {
          if (ytPlayer && typeof ytPlayer.destroy === "function") {
            ytPlayer.destroy();
          }
        } catch (e) {
          console.warn("No se pudo destruir ytPlayer:", e);
        }
        ytPlayer = null;

        // Limpiar iframe/contenedor de YouTube
        const playerContainer = document.getElementById("playerContainer");
        if (playerContainer) playerContainer.innerHTML = "";
        
        currentLetter = null;
      } catch(err) {
        console.error("Error cerrando carta:", err);
      }
    };

    window.initAudio = function(songId, songUrl = "") {
      if (audioElement) {
        audioElement.pause();
        audioElement.currentTime = 0;
      }

      // Si hay URL guardada, usarla directamente
      // Para YouTube, redirigir al usuario a la página de YouTube
      if (songUrl && songUrl.includes("youtube")) {
        // No podemos reproducir directamente desde YouTube por CORS
        // Mostrar botón para abrir en nueva ventana
        const musicContainer = document.getElementById("musicContainer");
        if (musicContainer) {
          const playBtn = document.getElementById("playBtn");
          playBtn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
          playBtn.onclick = () => window.open(songUrl, '_blank');
          playBtn.title = "Abre la canción en YouTube";
        }
        return;
      }

      // Audio URLs de preview (usando archivos de ejemplo)
      const audioUrls = {
        "perfect": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
        "thinking": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
        "always": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",
        "marry": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3",
        "tonight": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3",
        "moon": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3",
        "everlong": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3"
      };

      audioElement = new Audio(audioUrls[songId] || "");
      audioElement.addEventListener("timeupdate", () => {
        if (audioElement.duration) {
          const percent = (audioElement.currentTime / audioElement.duration) * 100;
          document.getElementById("playerProgress").style.width = percent + "%";
        }
      });
      audioElement.addEventListener("ended", () => {
        document.getElementById("playBtn").innerHTML = '<i class="fas fa-play"></i>';
      });
    };

    window.embedYouTubePlayer = function(url) {
      try {
        const musicContainer = document.getElementById("musicContainer");
        if (!musicContainer) return;
        
        console.log("Embebiendo YouTube player para URL:", url);
        
        // Extraer video ID (reutiliza helper)
        const videoId = window.extractYouTubeVideoId ? window.extractYouTubeVideoId(url) : null;
        
        console.log("Video ID extraído:", videoId);
        
        if (videoId) {
          const playerContainer = document.getElementById("playerContainer");
          if (!playerContainer) return;

          // Asegurar contenedor visible/limpio
          playerContainer.innerHTML = '<div id="ytPlayerMount"></div>';

          // Actualizar botón (no controla YouTube, pero indica estado)
          const playBtn = document.getElementById("playBtn");
          if (playBtn) {
            playBtn.innerHTML = '<i class="fas fa-music"></i>';
            playBtn.title = "Reproduciendo en YouTube";
            playBtn.style.cursor = "default";
            playBtn.onclick = null;
          }

          // Intento 1: usar Iframe API para forzar playVideo()
          ensureYouTubeIframeApi().then(() => {
            try {
              if (ytPlayer && typeof ytPlayer.destroy === "function") {
                ytPlayer.destroy();
              }
            } catch (e) {
              console.warn("No se pudo destruir ytPlayer anterior:", e);
            }

            if (!(window.YT && window.YT.Player)) {
              // Fallback si no cargó la API
              const iframe = document.createElement("iframe");
              iframe.width = "100%";
              iframe.height = "180";
              // mute=1 mejora el autoplay en móviles; luego intentamos desmutear vía API cuando sea posible
              iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&playsinline=1&controls=1&rel=0&modestbranding=1`;
              iframe.title = "Music Player";
              iframe.frameBorder = "0";
              iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
              iframe.allowFullscreen = true;
              const mount = document.getElementById("ytPlayerMount");
              if (mount) {
                mount.replaceWith(iframe);
              } else {
                playerContainer.appendChild(iframe);
              }
              console.log("YouTube iframe fallback embebido:", videoId);
              return;
            }

            ytPlayer = new window.YT.Player("ytPlayerMount", {
              videoId,
              playerVars: {
                autoplay: 1,
                controls: 1,
                rel: 0,
                modestbranding: 1,
                playsinline: 1
              },
              events: {
                onReady: (event) => {
                  try {
                    // Para maximizar autoplay: arrancar muteado y luego intentar desmutear
                    event.target.mute();
                    event.target.playVideo();
                    setTimeout(() => {
                      try {
                        event.target.unMute();
                        event.target.setVolume(100);
                      } catch (_) {}
                    }, 800);
                    console.log("YouTube API onReady -> playVideo");
                  } catch (e) {
                    console.warn("No se pudo iniciar playVideo:", e);
                  }
                },
                onError: (e) => {
                  console.warn("Error YouTube Player:", e);
                  // Fallback: abrir en YouTube
                  const playBtnFallback = document.getElementById("playBtn");
                  if (playBtnFallback) {
                    playBtnFallback.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                    playBtnFallback.style.cursor = "pointer";
                    playBtnFallback.onclick = () => window.open(url, "_blank");
                    playBtnFallback.title = "Abre en YouTube";
                  }
                }
              }
            });

            console.log("YouTube player (API) creado:", videoId);
          });
        } else {
          console.warn("No se pudo extraer video ID de:", url);
          // Si es URL de búsqueda o no válida, mostrar botón para abrir
          const playBtn = document.getElementById("playBtn");
          if (playBtn) {
            playBtn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
            playBtn.style.cursor = "pointer";
            playBtn.onclick = () => window.open(url, '_blank');
            playBtn.title = "Abre en YouTube";
          }
        }
      } catch(err) {
        console.error("Error embebiendo YouTube:", err);
      }
    };

    window.toggleMusic = function() {
      if (!audioElement) return;
      
      if (audioElement.paused) {
        audioElement.play();
        document.getElementById("playBtn").innerHTML = '<i class="fas fa-pause"></i>';
      } else {
        audioElement.pause();
        document.getElementById("playBtn").innerHTML = '<i class="fas fa-play"></i>';
      }
    };

    window.filterLetters = function(mode) {
      filterMode = mode;
      window.loadLetters();
    };

    window.addPhoto = async function() {
      if (!currentUser || !firebaseReady || !db) {
        window.showToast("Debes iniciar sesión", "error");
        return;
      }

      const fileInput = document.getElementById("photoFile");
      const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

      const url = (document.getElementById("photoUrl")?.value || "").trim();
      const caption = (document.getElementById("photoCaption")?.value || "").trim();

      if (!file && !url) {
        window.showToast("Selecciona una foto o pega una URL", "error");
        return;
      }

      try {
        let dataUrl = "";
        let finalUrl = "";

        if (file) {
          dataUrl = await window.compressImageForFirestore(file, {
            maxDimension: 1280,
            quality: 0.82,
            mime: "image/webp"
          });

          if (!dataUrl || typeof dataUrl !== "string" || !dataUrl.startsWith("data:image/")) {
            window.showToast("No se pudo procesar la imagen", "error");
            return;
          }

          // Firestore: límite aprox. 1 MiB por documento. El dataURL (base64) crece.
          const commaIdx = dataUrl.indexOf(",");
          const b64Len = commaIdx >= 0 ? (dataUrl.length - commaIdx - 1) : dataUrl.length;
          const approxBytes = Math.floor((b64Len * 3) / 4);
          if (approxBytes > 900000) {
            window.showToast("La foto es muy pesada. Prueba con otra o recórtala.", "error");
            return;
          }
        } else {
          finalUrl = url;
        }

        await db.collection("photos").add({
          author: currentUser,
          url: finalUrl,
          dataUrl: dataUrl,
          caption: caption,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        window.showToast("Foto agregada", "success");
        const photoUrlEl = document.getElementById("photoUrl");
        if (photoUrlEl) photoUrlEl.value = "";
        const photoCaptionEl = document.getElementById("photoCaption");
        if (photoCaptionEl) photoCaptionEl.value = "";
        if (fileInput) fileInput.value = "";
        window.loadPhotos();
        window.loadDashboard();
      } catch (err) {
        window.showToast("Error: " + err.message, "error");
      }
    };

    window.compressImageForFirestore = function(file, opts = {}) {
      const maxDimension = Number(opts.maxDimension || 1280);
      const quality = typeof opts.quality === "number" ? opts.quality : 0.82;
      const preferredMime = String(opts.mime || "image/webp");

      return new Promise((resolve, reject) => {
        try {
          if (!file || !file.type || !file.type.startsWith("image/")) {
            reject(new Error("Archivo no es una imagen"));
            return;
          }

          const reader = new FileReader();
          reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
          reader.onload = () => {
            const img = new Image();
            img.onerror = () => reject(new Error("Imagen inválida"));
            img.onload = () => {
              const w = img.naturalWidth || img.width;
              const h = img.naturalHeight || img.height;
              if (!w || !h) {
                reject(new Error("No se pudo obtener el tamaño de la imagen"));
                return;
              }

              const scale = Math.min(1, maxDimension / Math.max(w, h));
              const targetW = Math.max(1, Math.round(w * scale));
              const targetH = Math.max(1, Math.round(h * scale));

              const canvas = document.createElement("canvas");
              canvas.width = targetW;
              canvas.height = targetH;
              const ctx = canvas.getContext("2d", { alpha: false });
              if (!ctx) {
                reject(new Error("Canvas no soportado"));
                return;
              }

              ctx.imageSmoothingEnabled = true;
              ctx.imageSmoothingQuality = "high";
              ctx.drawImage(img, 0, 0, targetW, targetH);

              let out = "";
              try {
                out = canvas.toDataURL(preferredMime, quality);
              } catch (_) {
                out = "";
              }

              if (!out || !out.startsWith("data:image/")) {
                out = canvas.toDataURL("image/jpeg", Math.min(0.86, quality));
              }

              resolve(out);
            };
            img.src = String(reader.result || "");
          };

          reader.readAsDataURL(file);
        } catch (e) {
          reject(e);
        }
      });
    };

    window.deletePhoto = async function(photoId) {
      try {
        if (!photoId) return;
        if (!currentUser || !firebaseReady || !db) {
          window.showToast("Debes iniciar sesión", "error");
          return;
        }
        const ok = window.confirm("¿Eliminar esta foto?");
        if (!ok) return;
        await db.collection("photos").doc(photoId).delete();
        window.showToast("Foto eliminada", "success");
        window.loadPhotos();
        window.loadDashboard();
      } catch (err) {
        window.showToast("Error: " + err.message, "error");
      }
    };

    let currentPhoto = null;
    let currentPhotoId = null;

    window.openPhotoInNewTab = function(btn) {
      try {
        const src = btn && btn.dataset ? btn.dataset.src : "";
        if (src) window.open(src, "_blank");
      } catch (e) {
        console.error("Error abriendo foto:", e);
      }
    };

    window.openPhotoModal = function(photo) {
      try {
        if (!photo || !photo.src) return;
        currentPhoto = photo;
        currentPhotoId = photo.__id ? String(photo.__id) : null;

        const modal = document.getElementById("photoModal");
        if (!modal) return;

        const img = document.getElementById("photoModalImg");
        if (img) img.src = photo.src;

        const captionEl = document.getElementById("photoModalCaption");
        if (captionEl) captionEl.textContent = photo.caption || "Foto";

        const metaEl = document.getElementById("photoModalMeta");
        if (metaEl) {
          const authorName = (photo.author || "").charAt(0).toUpperCase() + (photo.author || "").slice(1);
          metaEl.innerHTML = `<i class="fas fa-user"></i> ${authorName || "—"} &nbsp; <i class="fas fa-calendar"></i> ${photo.date || "—"}`;
        }

        const delBtn = document.getElementById("deletePhotoBtn");
        if (delBtn) delBtn.style.display = currentPhotoId ? "inline-flex" : "none";

        modal.classList.add("active");
      } catch (e) {
        console.error("Error en openPhotoModal:", e);
      }
    };

    window.closePhotoModal = function() {
      try {
        const modal = document.getElementById("photoModal");
        if (modal) modal.classList.remove("active");
        const img = document.getElementById("photoModalImg");
        if (img) img.src = "";
        currentPhoto = null;
        currentPhotoId = null;
      } catch (e) {
        console.error("Error en closePhotoModal:", e);
      }
    };

    window.openPhotoModalInNewTab = function() {
      if (!currentPhoto || !currentPhoto.src) return;
      window.open(currentPhoto.src, "_blank");
    };

    window.deleteCurrentPhoto = async function() {
      if (!currentPhotoId) return;
      await window.deletePhoto(currentPhotoId);
      window.closePhotoModal();
    };

    window.loadPhotos = async function() {
      try {
        console.log("loadPhotos iniciando...");
        
        if (!currentUser || !firebaseReady || !db) {
          console.log("Condición de retorno en loadPhotos");
          return;
        }

        const snapshot = await db.collection("photos")
          .orderBy("createdAt", "desc")
          .limit(100)
          .get();

        const gallery = document.getElementById("galleryGrid");
        if (!gallery) {
          console.error("galleryGrid element not found");
          return;
        }
        
        gallery.innerHTML = "";

        if (snapshot.empty) {
          gallery.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-tertiary); padding: 40px"><i class="fas fa-image"></i> Aún no hay fotos</p>';
          const statsPhotos = document.getElementById("statsPhotos");
          if (statsPhotos) statsPhotos.textContent = "0";
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const photoId = doc.id;
          const src = data.dataUrl || data.url || "";
          const srcAttr = String(src)
            .replace(/&/g, "&amp;")
            .replace(/"/g, "&quot;")
            .replace(/</g, "&lt;");
          const dateObj = data.createdAt?.toDate?.();
          const date = dateObj ? dateObj.toLocaleDateString("es-ES", { year: "numeric", month: "short", day: "numeric" }) : "—";
          const el = document.createElement("div");
          el.className = "gallery-item";
          const authorIcon = data.author === "diego" ? '<i class="fas fa-user"></i>' : '<i class="fas fa-user"></i>';
          el.innerHTML = `
            <div class="gallery-photo">
              <img src="${srcAttr}" alt="" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22%3E%3Crect fill=%22%23333%22 width=%22200%22 height=%22200%22/%3E%3Ctext text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22%3ENo disponible%3C/text%3E%3C/svg%3E'" />
            </div>
            <div class="gallery-actions">
              <button class="gallery-action-btn" title="Abrir" data-src="${srcAttr}" onclick="event.stopPropagation(); window.openPhotoInNewTab(this)"><i class="fas fa-up-right-from-square"></i></button>
              <button class="gallery-action-btn" title="Eliminar" onclick="event.stopPropagation(); window.deletePhoto('${photoId}')"><i class="fas fa-trash"></i></button>
            </div>
            <div class="gallery-item-caption">
              <div>${data.caption || "Foto"}</div>
              <div class="caption-meta">${authorIcon} ${(data.author || "").charAt(0).toUpperCase() + (data.author || "").slice(1)}</div>
            </div>
          `;
          el.addEventListener("click", () => {
            if (!src) return;
            window.openPhotoModal({
              __id: photoId,
              src,
              caption: data.caption || "Foto",
              author: (data.author || "").toLowerCase(),
              date
            });
          });
          gallery.appendChild(el);
        });

        const statsPhotos = document.getElementById("statsPhotos");
        if (statsPhotos) statsPhotos.textContent = snapshot.size;
        
        console.log("loadPhotos completado");
      } catch (err) {
        console.error("Error en loadPhotos:", err);
      }
    };

    window.logout = function() {
      try {
        if (window._next5CountdownTimer) {
          clearInterval(window._next5CountdownTimer);
          window._next5CountdownTimer = null;
        }
        if (window._anniversaryTimer) {
          clearInterval(window._anniversaryTimer);
          window._anniversaryTimer = null;
        }
        currentUser = null;
        localStorage.removeItem("currentUser");
        const loginScreen = document.getElementById("loginScreen");
        if (loginScreen) loginScreen.classList.remove("hidden");
        const mainHeader = document.getElementById("mainHeader");
        if (mainHeader) mainHeader.style.display = "none";
        const mainContent = document.getElementById("mainContent");
        if (mainContent) mainContent.style.display = "none";
        location.reload();
      } catch(err) {
        console.error("Error en logout:", err);
      }
    };

    window.showToast = function(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;

      const icon = document.createElement("i");
      if (type === "success") icon.className = "fas fa-check-circle";
      else if (type === "error") icon.className = "fas fa-exclamation-circle";
      else icon.className = "fas fa-info-circle";

      const text = document.createElement("div");
      text.textContent = String(message ?? "");

      toast.appendChild(icon);
      toast.appendChild(text);

      const container = document.getElementById("toastsContainer");
      if (!container) return;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    };

    window.enableNotifications = function() {
      if (!("Notification" in window)) {
        window.showToast("Tu navegador no soporta notificaciones", "error");
        return;
      }

      Notification.requestPermission().then(perm => {
        if (perm === "granted") {
          window.showToast("Notificaciones activadas", "success");
        }
      });
    };

    window.sendNotification = function(title, body) {
      if (!("Notification" in window) || Notification.permission !== "granted") return;
      new Notification(title, { 
        body: body,
        icon: "/portada.jpeg",
        badge: "/portada.jpeg"
      });
    };

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (String(base64String || "") + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    function safeLowerUser(u) {
      return String(u || "").toLowerCase();
    }

    function otherUserFor(u) {
      const lu = safeLowerUser(u);
      if (lu === "diego") return "danna";
      if (lu === "danna") return "diego";
      return "";
    }

    function isIOSDevice() {
      return /iphone|ipad|ipod/i.test(navigator.userAgent || "");
    }

    function isStandaloneApp() {
      // iOS: navigator.standalone | general: display-mode
      // (Safari iOS suele exponer Push solo en modo standalone)
      return (
        (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
        // @ts-ignore
        (typeof navigator !== "undefined" && navigator.standalone === true)
      );
    }

    window.debugPushStatus = async function() {
      try {
        const status = {
          protocol: location.protocol,
          host: location.host,
          isIOS: isIOSDevice(),
          standalone: isStandaloneApp(),
          hasNotification: ("Notification" in window),
          permission: ("Notification" in window) ? Notification.permission : "n/a",
          hasServiceWorker: ("serviceWorker" in navigator),
          hasPushManager: ("PushManager" in window),
        };

        console.log("[push] status:", status);

        let hasRegistration = false;
        let hasSubscription = false;
        let subscriptionHost = "";

        if (status.hasServiceWorker) {
          try {
            const reg = await navigator.serviceWorker.getRegistration("/");
            console.log("[push] sw registration:", reg);

            if (reg) {
              hasRegistration = true;
              try {
                const sub = await reg.pushManager.getSubscription();
                hasSubscription = !!sub;
                if (sub && sub.endpoint) {
                  try { subscriptionHost = new URL(sub.endpoint).host; } catch (_) {}
                }
                console.log("[push] subscription:", sub);
              } catch (e) {
                console.log("[push] getSubscription error:", e);
              }
            }
          } catch (e) {
            console.log("[push] sw registration error:", e);
          }
        }

        let pushConfigStatus = "";
        let pushConfigOk = false;

        try {
          const res = await fetch("/api/push-config", { cache: "no-store" });
          console.log("[push] /api/push-config:", res.status);
          pushConfigStatus = String(res.status);
          if (res.ok) {
            pushConfigOk = true;
            console.log("[push] vapid:", await res.json());
          } else {
            console.log("[push] push-config text:", await res.text());
          }
        } catch (e) {
          pushConfigStatus = "fetch error";
          console.log("[push] push-config fetch error:", e);
        }

        const summary = [
          `iOS: ${status.isIOS ? 'sí' : 'no'}`,
          `Standalone (icono): ${status.standalone ? 'sí' : 'no'}`,
          `Permiso: ${status.permission}`,
          `SW: ${hasRegistration ? 'registrado' : 'no'}`,
          `Suscripción Push: ${hasSubscription ? 'sí' : 'no'}`,
          subscriptionHost ? `Endpoint: ${subscriptionHost}` : '',
          `push-config: ${pushConfigOk ? 'ok' : 'fail'} (${pushConfigStatus || '-'})`,
          '',
          'Tip iPhone: Ajustes > Notificaciones > (Website Notifications)'
        ].filter(Boolean).join('\n');

        alert(summary);
      } catch (e) {
        console.log("[push] debugPushStatus error:", e);
      }
    };

    window.testPushNow = async function() {
      try {
        if (!currentUser) {
          window.showToast("Inicia sesión primero", "error");
          return;
        }
        if (!("Notification" in window) || Notification.permission !== "granted") {
          window.showToast("Primero activa Push y concede permisos", "error");
          return;
        }
        if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
          window.showToast("Push no es compatible en este navegador", "error");
          return;
        }

        window.showToast("Enviando push de prueba...", "info");
        await window.sendPushToUser(
          safeLowerUser(currentUser),
          "Prueba de notificación",
          "Si ves esto, el push funciona ✅",
          { url: "/" }
        );
        window.showToast("Push enviado. Si no llega, revisa Diagnosticar Push", "success");
      } catch (e) {
        console.warn("testPushNow error:", e);
        const msg = e && e.message ? String(e.message) : String(e);
        window.showToast("No se pudo enviar push: " + msg, "error");
      }
    };

    async function registerPushServiceWorker() {
      if (!("serviceWorker" in navigator)) throw new Error("Service Worker no soportado");
      return await navigator.serviceWorker.register("/sw.js", { scope: "/" });
    }

    async function fetchVapidPublicKey() {
      const res = await fetch("/api/push-config", { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudo leer la config push");
      const data = await res.json();
      if (!data || !data.publicKey) throw new Error("Config push inválida");
      return String(data.publicKey);
    }

    async function savePushSubscription(subscription) {
      if (!currentUser || !firebaseReady || !db) throw new Error("Debes iniciar sesión");
      const subJson = subscription.toJSON();
      const endpoint = String(subJson && subJson.endpoint ? subJson.endpoint : "");
      if (!endpoint) throw new Error("Suscripción inválida");
      const docId = btoa(endpoint).replace(/[^a-zA-Z0-9]/g, "").slice(0, 150);

      await db.collection("pushSubscriptions").doc(docId).set({
        user: safeLowerUser(currentUser),
        endpoint,
        subscription: subJson,
        ua: navigator.userAgent || "",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    // Si ya existe una suscripción push, la asociamos silenciosamente al usuario actual.
    // Evita recibir push del usuario anterior en este mismo dispositivo.
    window.syncExistingPushSubscription = async function() {
      try {
        if (!currentUser) return;
        if (isIOSDevice() && !isStandaloneApp()) return;
        if (!("Notification" in window) || Notification.permission !== "granted") return;
        if (!("serviceWorker" in navigator) || !("PushManager" in window)) return;
        if (!location.protocol.startsWith("https") && location.hostname !== "localhost") return;

        const reg = await registerPushServiceWorker();
        const subscription = await reg.pushManager.getSubscription();
        if (!subscription) return;

        await savePushSubscription(subscription);
      } catch (err) {
        console.warn("syncExistingPushSubscription warning:", err);
      }
    };

    window.enablePushNotifications = async function() {
      try {
        if (!("Notification" in window)) {
          window.showToast("Tu navegador no soporta notificaciones", "error");
          return;
        }

        // Web Push en iOS funciona (principalmente) cuando la web está instalada como app
        // (Compartir → Añadir a pantalla de inicio) y se abre desde el icono.
        if (isIOSDevice() && !isStandaloneApp()) {
          window.showToast("En iPhone/iPad: primero 'Añadir a pantalla de inicio' y abre desde el icono para activar push", "error");
          return;
        }

        if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
          window.showToast("Push no es compatible en este navegador", "error");
          return;
        }
        if (!location.protocol.startsWith("https") && location.hostname !== "localhost") {
          window.showToast("Push requiere HTTPS", "error");
          return;
        }
        if (!currentUser) {
          window.showToast("Inicia sesión para activar push", "error");
          return;
        }

        if (Notification.permission === "denied") {
          window.showToast("Notificaciones bloqueadas. Ve a Ajustes > Notificaciones y actívalas para esta app", "error");
          return;
        }

        const perm = await Notification.requestPermission();
        if (perm !== "granted") {
          window.showToast("Permiso de notificaciones no concedido", "error");
          return;
        }

        const reg = await registerPushServiceWorker();
        const publicKey = await fetchVapidPublicKey();
        const appServerKey = urlBase64ToUint8Array(publicKey);

        let subscription = await reg.pushManager.getSubscription();
        if (!subscription) {
          subscription = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: appServerKey
          });
        }

        await savePushSubscription(subscription);
        window.showToast("Push activado (segundo plano)", "success");
      } catch (err) {
        console.error("enablePushNotifications error:", err);
        const name = err && err.name ? String(err.name) : "Error";
        const msg = err && err.message ? String(err.message) : String(err);
        window.showToast("No se pudo activar push (" + name + "): " + msg, "error");
      }
    };

    window.sendPushToUser = async function(targetUser, title, body, data = {}) {
      const res = await fetch("/api/send-push", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          targetUser: safeLowerUser(targetUser),
          title: String(title || "Diego Y Danna"),
          body: String(body || ""),
          data: data && typeof data === "object" ? data : {}
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error("Push server error: " + txt);
      }
      return await res.json();
    };

    // Verificar notificación de aniversario (día 5)
    setInterval(() => {
      const today = new Date();
      if (today.getDate() === 5 && currentUser) {
        window.sendNotification("¡Hoy es especial!", "Es el día 5, nuestro aniversario mensual");
      }
    }, 60000);

    window.setupScrollAnimations = function() {
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add("visible");
          }
        });
      }, { threshold: 0.1 });

      document.querySelectorAll(".scroll-animation").forEach(el => {
        observer.observe(el);
      });
    };

    // Startup
    window.addEventListener("DOMContentLoaded", () => {
      try {
        console.log("DOMContentLoaded iniciando...");

        // Configura drag del botón (aunque esté oculto antes del login)
        window.enablePendingFloatingDrag?.();
        
        // Asegurar que el primer tab esté visible
        const firstContent = document.getElementById("tab-inicio");
        if (firstContent) {
          firstContent.classList.add("active");
          console.log("Primer tab activado");
        }
        
        const saved = localStorage.getItem("currentUser");
        if (saved && firebaseReady) {
          console.log("Restaurando sesión guardada:", saved);
          window.initApp(saved);
        } else {
          console.log("No hay sesión guardada o Firebase no listo");
        }
        
        console.log("DOMContentLoaded completado");
      } catch(err) {
        console.error("Error en DOMContentLoaded:", err);
      }
    });

    // DEBUG: Ver todas las cartas en Firestore
    window.debugLetters = async function() {
      if (!db) {
        console.log("Firebase no está listo");
        return;
      }
      try {
        const snapshot = await db.collection("letters").get();
        console.log("Total de cartas en Firestore:", snapshot.size);
        snapshot.forEach(doc => {
          console.log(doc.id, doc.data());
        });
      } catch (err) {
        console.error("Error en debug:", err);
      }
    };
  </script>
</body>
</html>
